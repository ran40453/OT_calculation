<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>加班表管理</title>
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    // 版本標籤（方便在 console 看到目前版號）
    window.__CW_DEPLOY_TAG = "<?= DEPLOY_TAG ?>";
    // 從 Apps Script 模板注入的初始加班資料（getOvertimeData 的回傳值）
    window.__OT_INIT_PAYLOAD__ = <?!= INIT_DATA_JSON ?>;
  </script>
  <?!= include('style'); ?>
</head>

<body>

  <!-- 分頁導航列（固定顯示） -->
  <!-- 分頁導航列（桌面版為左側邊欄，手機版為頂部導航） -->
  <nav class="tab-navigation">
    <div class="nav-logo-area" style="padding: 10px; margin-bottom: 20px; display: none;">
      <!-- 桌面版可在這裡放 Logo -->
    </div>
    <button class="tab-btn active" data-tab="overview">
      <span class="material-symbols-outlined">dashboard</span>
      Overview
    </button>
    <button class="tab-btn" data-tab="analytics">
      <span class="material-symbols-outlined">analytics</span>
      Analytics
    </button>
  </nav>

  <!-- Overview Tab (原有內容) -->
  <div class="tab-content active" id="overview-tab">
    <div class="container">

      <!-- 左側區域 -->
      <div class="left-panel">

        <!-- Logo 卡片 -->
        <div class="card logo-card" onclick="showOtMonthlySummary()" style="cursor:pointer;">
          <img
            src="https://static.wixstatic.com/media/f31164_8fb3a217689346059f1c7a5e599fa050~mv2.png/v1/fill/w_282,h_50,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/logoFONT.png"
            alt="OT Logo" class="logo-image">
        </div>

        <!-- Dashboard 總計 -->
        <div class="card dashboard">
          <h3>總計</h3>
          <div class="capsule-column">
            <div class="capsule-row">
              <span class="label">出差天數</span>
              <span class="capsule black dashboard-value" id="travelDays">0</span>
            </div>
            <div class="capsule-row">
              <span class="label">加班總時數</span>
              <span class="capsule black" id="totalOT">0</span>
            </div>
            <div class="capsule-row">
              <span class="detail-label">Base</span>
              <span class="capsule dark-gray" id="totalBase">0</span>
            </div>
            <div class="capsule-row">
              <span class="label">Travel</span>
              <span class="capsule dark-gray" id="totalTravel">0</span>
            </div>
            <div class="capsule-row">
              <span class="label">OT</span>
              <span class="capsule dark-gray" id="totalOTSalary">0</span>
            </div>
            <div class="capsule-row">
              <span class="label">費用 Total</span>
              <span class="capsule black dashboard-value" id="totalCost">0</span>
            </div>
            <div class="capsule-row">
              <span class="label">總收入</span>
              <span class="capsule yellow dashboard-value" id="totalSalary">0</span>
            </div>
          </div>
        </div>


        <!-- 輸入設定卡片 (可收合) -->
        <div class="card settings-card" id="settingsCard">
          <div class="card-header" onclick="toggleSettingsCard()"
            style="padding: 16px 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; text-align: left;">輸入設定</h3>
            <span class="material-symbols-outlined card-expand-icon" id="settingsExpandIcon">expand_more</span>
          </div>
          <div class="card-body" id="settingsBody" style="display: none; padding-top: 0;">
            <label>月薪</label>
            <input type="number" id="salary" value="68000"><br>
            <label>美元匯率</label>
            <div style="display: flex; gap: 8px; align-items: center;">
              <input type="number" id="usdRate" value="30.9" style="flex: 1;">
              <button id="refreshRateOverviewBtn" class="icon-button" style="width: 44px; height: 44px; margin: 0;"
                title="更新匯率">
                <span class="material-symbols-outlined">refresh</span>
              </button>
            </div>

          </div>
        </div>

        <!-- 操作按鈕卡片 (獨立) -->
        <div class="card actions-card">
          <div class="settings-actions" style="justify-content: center; gap: 16px;">
            <button id="exportCSVCard" class="icon-button">
              <span class="material-symbols-outlined">save</span>
            </button>
            <label for="importCSVCard" class="icon-button file-label">
              <span class="material-symbols-outlined">upload</span>
            </label>
            <button id="saveToSheetBtn" class="icon-button" aria-label="Save to Google Sheet">
              <span class="material-symbols-outlined">cloud_upload</span>
            </button>
            <button id="fillMissingDatesBtn" class="icon-button" aria-label="Fill missing dates">
              <span class="material-symbols-outlined">calendar_month</span>
            </button>
            <input type="file" id="importCSVCard" accept=".csv">
          </div>
        </div>
        <a class="icon-button mobile-table-toggle" href="#tableSection">
          <span class="material-symbols-outlined">table_view</span>
          <span class="mobile-table-toggle-label">查看加班明細</span>
        </a>

      </div>

      <!-- 右側區域 -->
      <div class="right-panel">

        <!-- 新增資料卡片 (Smart Stepper 統一設計) -->
        <div class="add-card add-card-circular">
          <div class="add-card-item">
            <label>日期</label>
            <button type="button" id="newDate" class="smart-stepper-add" data-type="date">--/--</button>
          </div>
          <div class="add-card-item">
            <label>1.67</label>
            <button type="button" id="new167" class="smart-stepper-add" data-key="v167">0.0</button>
          </div>
          <div class="add-card-item">
            <label>1.34</label>
            <button type="button" id="new134" class="smart-stepper-add" data-key="v134">0.0</button>
          </div>
          <div class="add-card-item">
            <label>1.66</label>
            <button type="button" id="new166" class="smart-stepper-add" data-key="v166">0.0</button>
          </div>
          <div class="add-card-item">
            <label>2.67</label>
            <button type="button" id="new267" class="smart-stepper-add" data-key="v267">0.0</button>
          </div>
          <div class="add-card-item">
            <label>Travel</label>
            <button type="button" id="newTravelCountry" class="smart-stepper-add" data-type="travel">VN</button>
          </div>
          <div class="add-card-item">
            <label>&nbsp;</label>
            <button id="addRowCard" class="circular-add-btn-round">
              <span class="material-symbols-outlined">add</span>
            </button>
          </div>
        </div>

        <!-- 表格容器 -->
        <div id="tableContainer">
          <!-- 表格由 JS 動態生成 -->
        </div>

      </div>

    </div>
  </div>
  <!-- End of Overview Tab -->

  <!-- Analytics Tab -->
  <div class="tab-content" id="analytics-tab">
    <div class="analytics-container">

      <!-- 頂部控制列 -->
      <div class="analytics-header">
        <h2>Analytics</h2>
        <div class="month-filter-wrapper">
          <select id="monthFilter" class="month-select">
            <option value="">全部月份</option>
          </select>
        </div>
      </div>

      <!-- 統計專欄區 (Grid 佈局) -->
      <div class="stats-columns">

        <!-- 天數專欄 -->
        <div class="stat-column-card">
          <div class="column-header">
            <span class="material-symbols-outlined icon-blue">calendar_month</span>
            <h3>天數統計</h3>
          </div>
          <div class="stat-list">
            <div class="stat-item">
              <span class="label">工作天數</span>
              <span class="value" id="statWorkDays">0</span>
            </div>
            <div class="stat-item">
              <span class="label">出差天數</span>
              <span class="value" id="statTravelDays">0</span>
            </div>
            <div class="stat-item">
              <span class="label">平日加班</span>
              <span class="value" id="statWeekdayDays">0</span>
            </div>
            <div class="stat-item">
              <span class="label">週末加班</span>
              <span class="value" id="statWeekendDays">0</span>
            </div>
          </div>
        </div>

        <!-- 薪資專欄 -->
        <div class="stat-column-card">
          <div class="column-header">
            <span class="material-symbols-outlined icon-green">payments</span>
            <h3>薪資概況</h3>
          </div>
          <div class="stat-list">
            <div class="stat-item">
              <span class="label">平均日薪</span>
              <span class="value" id="statAvgDaily">0</span>
            </div>
            <div class="stat-item">
              <span class="label">平均時薪</span>
              <span class="value" id="statAvgHourly">0</span>
            </div>
            <div class="stat-item">
              <span class="label">平均月薪</span>
              <span class="value" id="statAvgMonthly">0</span>
            </div>
          </div>
        </div>

        <!-- 收入專欄 -->
        <div class="stat-column-card">
          <div class="column-header">
            <span class="material-symbols-outlined icon-orange">savings</span>
            <h3>收入分析</h3>
          </div>
          <div class="stat-list">
            <div class="stat-item">
              <span class="label">總收入</span>
              <span class="value highlight" id="statTotalIncome">0</span>
            </div>
            <div class="stat-item">
              <span class="label">本月收入</span>
              <span class="value" id="statThisMonthIncome">0</span>
            </div>
            <div class="stat-item">
              <span class="label">加班總時數</span>
              <span class="value" id="statOTHours">0</span>
            </div>
          </div>
        </div>

      </div>

      <!-- 圖表區 (Grid 佈局) -->
      <div class="chart-section">
        <div class="chart-card">
          <h3>月度加班趨勢</h3>
          <div style="position: relative; height: 100%; width: 100%;">
            <canvas id="overtimeChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3>收入結構</h3>
          <div style="position: relative; height: 100%; width: 100%;">
            <canvas id="incomeChart"></canvas>
          </div>
        </div>
      </div>

    </div>
  </div>
  <!-- End of Analytics Tab -->

  <?!= include('main'); ?>
</body>

</html>