<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>加班表管理</title>
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script id="init-payload" type="application/json"><?!= INIT_DATA_JSON || '{"data":[]}' ?></script>
  <script>
    // 版本標籤（防止本地環境報錯）
    window.__CW_DEPLOY_TAG = "<?= DEPLOY_TAG ?>";
    if (window.__CW_DEPLOY_TAG && window.__CW_DEPLOY_TAG.startsWith("<" + "?")) window.__CW_DEPLOY_TAG = "LOCAL_DEV";

    // 從 Apps Script 模板注入的初始加班資料
    // 使用 JSON script 區塊讀取，避免本地預覽時語法報錯
    try {
      const rawPayload = document.getElementById('init-payload').textContent;
      window.__OT_INIT_PAYLOAD__ = JSON.parse(rawPayload);
    } catch (e) {
      console.warn('[OT] 無法讀取或解析初始資料:', e);
      window.__OT_INIT_PAYLOAD__ = null;
    }
  </script>
  <?!= include('style'); ?>
</head>

<body>

  <!-- 分頁導航列（固定顯示） -->
  <!-- 分頁導航列（桌面版為左側邊欄，手機版為頂部導航） -->
  <!-- 分頁導航列已移除，改為 Header Toggle -->

  <!-- Global Persistent Header -->
  <div class="header-row" style="padding: 8px 24px 0 24px; margin-bottom: 0;">
    <div class="card header-combined-card"
      style="display: flex; align-items: center; justify-content: space-between; padding: 8px 16px; width: 100%; cursor: default; margin-bottom: 0;">

      <!-- Logo (Left) -->
      <div id="logoCard" style="display: flex; align-items: center; cursor: pointer; gap: 12px;">
        <img
          src="https://static.wixstatic.com/media/f31164_8fb3a217689346059f1c7a5e599fa050~mv2.png/v1/fill/w_282,h_50,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/logoFONT.png"
          alt="OT Logo" class="logo-image" style="max-height: 32px; object-fit: contain;">
      </div>

      <!-- View Toggle (Right in Header) -->
      <button id="viewToggleBtn" aria-label="View Detailed List" class="icon-button"
        onclick="location.href='#tableSection'" title="查看加班明細"
        style="background: rgba(0,0,0,0.05); color: #333; border: 1px solid rgba(0,0,0,0.1); box-shadow: none;">
        <span class="material-symbols-outlined">table_view</span>
      </button>
    </div>
  </div>

  <!-- Overview Tab (原有內容) -->
  <div class="tab-content active" id="overview-tab">
    <div class="container" style="padding-top: 16px;">

      <!-- 左側區域 -->
      <div class="left-panel">
        <!-- Logo 卡片已移至全域 -->

        <!-- Dashboard 總計 (可收合) -->
        <div class="card dashboard-card" id="dashboardCard">
          <div class="card-header" onclick="toggleDashboardCard()"
            style="padding: 16px 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; text-align: left;">總計</h3>
            <span class="material-symbols-outlined card-expand-icon" id="dashboardExpandIcon">expand_less</span>
          </div>

          <div class="expand-wrapper open" id="dashboardBody">
            <div class="expand-inner">
              <div class="dashboard-stats-grid">
                <!-- 群組 1: 次數與時數 -->
                <div class="dashboard-group">
                  <div class="stat-row">
                    <span class="label">出差天數</span>
                    <span class="capsule black" id="travelDays">0</span>
                  </div>
                  <div class="stat-row">
                    <span class="label">加班總時數</span>
                    <span class="capsule black" id="totalOT">0</span>
                  </div>
                </div>

                <!-- 群組 2: 津貼與加班費 -->
                <div class="dashboard-group">
                  <div class="stat-row">
                    <span class="label">Travel 津貼</span>
                    <span class="capsule black" id="totalTravel">0</span>
                  </div>
                  <div class="stat-row">
                    <span class="label">OT 加班費</span>
                    <span class="capsule black" id="totalOTSalary">0</span>
                  </div>
                </div>

                <!-- 總計單獨顯示 -->
                <div class="dashboard-total">
                  <div class="stat-row total-row">
                    <span class="label">總收入</span>
                    <span class="capsule yellow" id="totalCost">0</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>


        <!-- 輸入設定卡片 (可收合) -->
        <div class="card settings-card" id="settingsCard">
          <div class="card-header" onclick="toggleSettingsCard()"
            style="padding: 16px 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; text-align: left;">輸入設定</h3>
            <span class="material-symbols-outlined card-expand-icon" id="settingsExpandIcon">expand_more</span>
          </div>
          <div class="expand-wrapper" id="settingsBody">
            <div class="expand-inner">
              <label>薪資設定</label>
              <button onclick="openSalaryModal()" class="icon-button"
                style="width: 100%; border-radius: 12px; margin: 8px 0; gap: 8px;">
                <span class="material-symbols-outlined">payments</span>
                <span>薪資調整明細</span>
              </button>
              <label>美元匯率</label>
              <div style="display: flex; gap: 8px; align-items: center;">
                <input type="number" id="usdRate" value="30.9" style="flex: 1;">
                <button id="refreshRateOverviewBtn" class="icon-button" style="width: 44px; height: 44px; margin: 0;"
                  title="更新匯率">
                  <span class="material-symbols-outlined">refresh</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- 操作按鈕卡片 (獨立) -->
        <div class="card actions-card">
          <div class="settings-actions" style="justify-content: center; gap: 16px;">
            <button id="exportCSVCard" class="icon-button">
              <span class="material-symbols-outlined">save</span>
            </button>
            <label for="importCSVCard" class="icon-button file-label">
              <span class="material-symbols-outlined">upload</span>
            </label>
            <button id="saveToSheetBtn" class="icon-button" aria-label="Save to Google Sheet">
              <span class="material-symbols-outlined">cloud_upload</span>
            </button>
            <button id="fillMissingDatesBtn" class="icon-button" aria-label="Fill missing dates">
              <span class="material-symbols-outlined">calendar_month</span>
            </button>

            <button id="privacyToggleBtn" class="icon-button privacy-btn" onclick="togglePrivacyMode()" title="切換隱私模式">
              <span class="material-symbols-outlined">visibility</span>
            </button>
            <input type="file" id="importCSVCard" accept=".csv">
          </div>
        </div>
        <!-- Cleaned up legacy header row -->

      </div>

      <!-- 右側區域 -->
      <div class="right-panel">

        <!-- 新增資料卡片 (Smart Stepper 統一設計) -->
        <div class="add-card add-card-circular">
          <div class="add-card-item">
            <label>日期</label>
            <button type="button" id="newDate" class="smart-stepper-add" data-type="date">--/--</button>
          </div>
          <div class="add-card-item">
            <label>Hour</label>
            <button type="button" id="newHour" class="smart-stepper-add" data-type="hour">17</button>
          </div>
          <div class="add-card-item">
            <label>Min</label>
            <button type="button" id="newMinute" class="smart-stepper-add" data-type="minute">30</button>
          </div>
          <div class="add-card-item">
            <label>Holiday</label>
            <button type="button" id="newHolidayToggle" class="smart-stepper-add"
              style="border: none; background: rgba(0,0,0,0.05) !important;">
              <span class="material-symbols-outlined" style="font-size: 20px;">event_busy</span>
            </button>
          </div>
          <div class="add-card-item">
            <label>Leave</label>
            <button type="button" id="newLeaveToggle" class="smart-stepper-add" title="切換請假狀態">
              <span class="material-symbols-outlined">person</span>
            </button>
          </div>
          <div class="add-card-item">
            <label>Travel</label>
            <button type="button" id="newTravelCountry" class="smart-stepper-add" data-type="travel">
              <span class="material-symbols-outlined" style="font-size: 20px;">flight</span>
            </button>
          </div>
          <div class="add-card-item">
            <label>&nbsp;</label>
            <button id="addRowCard" class="circular-add-btn-round">
              <span class="material-symbols-outlined">add</span>
            </button>
          </div>
        </div>

        <!-- 表格容器 -->
        <div id="tableContainer">
          <!-- 表格由 JS 動態生成 -->
        </div>

      </div>

    </div>
  </div>
  <!-- End of Overview Tab -->

  <!-- Analytics Tab -->
  <div class="tab-content" id="analytics-tab">
    <div class="analytics-container">

      <!-- 頂部控制列 -->
      <div class="analytics-header">
        <h2>Analytics</h2>
        <div class="month-filter-wrapper">
          <select id="monthFilter" class="month-select">
            <option value="">全部月份</option>
          </select>
        </div>
      </div>

      <!-- 統計專欄區 (Grid 佈局) -->
      <div class="stats-columns">

        <!-- 天數專欄 -->
        <div class="stat-column-card">
          <div class="column-header">
            <span class="material-symbols-outlined icon-blue">calendar_month</span>
            <h3>天數統計</h3>
          </div>
          <div class="stat-list">
            <div class="stat-item">
              <span class="label">工作天數</span>
              <span class="value" id="statWorkDays">0</span>
            </div>
            <div class="stat-item">
              <span class="label">出差天數</span>
              <span class="value" id="statTravelDays">0</span>
            </div>
            <div class="stat-item">
              <span class="label">平日加班</span>
              <span class="value" id="statWeekdayDays">0</span>
            </div>
            <div class="stat-item">
              <span class="label">週末加班</span>
              <span class="value" id="statWeekendDays">0</span>
            </div>
          </div>
        </div>

        <!-- 薪資專欄 -->
        <div class="stat-column-card">
          <div class="column-header">
            <span class="material-symbols-outlined icon-green">payments</span>
            <h3>薪資概況</h3>
          </div>
          <div class="stat-list">
            <div class="stat-item">
              <span class="label">平均日薪</span>
              <span class="value" id="statAvgDaily">0</span>
            </div>
            <div class="stat-item">
              <span class="label">平均時薪</span>
              <span class="value" id="statAvgHourly">0</span>
            </div>
            <div class="stat-item">
              <span class="label">平均月薪</span>
              <span class="value" id="statAvgMonthly">0</span>
            </div>
            <div class="stat-item highlight-alt">
              <span class="label">實質時薪 (有效)</span>
              <span class="value" id="statEffectiveHourly">0</span>
            </div>
          </div>
        </div>

        <!-- 收入專欄 -->
        <div class="stat-column-card">
          <div class="column-header">
            <span class="material-symbols-outlined icon-orange">savings</span>
            <h3>收入分析</h3>
          </div>
          <div class="stat-list">
            <div class="stat-item">
              <span class="label">總收入</span>
              <span class="value highlight" id="statTotalIncome">0</span>
            </div>
            <div class="stat-item">
              <span class="label">本月收入</span>
              <span class="value" id="statThisMonthIncome">0</span>
            </div>
            <div class="stat-item">
              <span class="label">加班總時數</span>
              <span class="value" id="statOTHours">0</span>
            </div>
            <div class="stat-item">
              <span class="label">出差補貼佔比</span>
              <span class="value" id="statTravelRatio">0%</span>
            </div>
            <div class="stat-item">
              <span class="label">加班貢獻度</span>
              <span class="value" id="statOTImpact">0%</span>
            </div>
          </div>
        </div>

      </div>

      <!-- 圖表區 (Grid 佈局) -->
      <div class="chart-section">
        <div class="chart-card">
          <h3>月度加班趨勢</h3>
          <div style="position: relative; height: 100%; width: 100%;">
            <canvas id="overtimeChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3>收入結構</h3>
          <div style="position: relative; height: 100%; width: 100%;">
            <canvas id="incomeChart"></canvas>
          </div>
        </div>
      </div>

    </div>
  </div>
  <!-- End of Analytics Tab -->

  <!-- 薪資調整明細彈窗 (Modal) -->
  <div id="salaryModal" class="modal-overlay">
    <div class="modal-content glass-window">
      <div class="modal-header">
        <h3>薪資調整明細</h3>
        <button class="icon-button close-btn" onclick="closeSalaryModal()">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <div class="modal-body">
        <section class="salary-section">
          <h4
            style="margin: 0 0 12px 0; color: var(--primary); font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
            <span class="material-symbols-outlined">payments</span> 薪資紀錄
          </h4>
          <div id="salaryList" class="salary-record-list">
            <!-- 紀錄將由 JS 動態生成 -->
          </div>
          <button class="add-salary-btn" onclick="addSalaryRecord()">
            <span class="material-symbols-outlined">add</span>
            <span>新增調薪紀錄</span>
          </button>
        </section>

        <hr style="border: none; border-top: 1px solid rgba(0, 0, 0, 0.05); margin: 24px 0;">

        <section class="travel-rate-section">
          <h4
            style="margin: 0 0 12px 0; color: var(--primary); font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
            <span class="material-symbols-outlined">flight_takeoff</span> 出差費率設定 (USD)
          </h4>
          <div id="travelRateList" class="salary-record-list">
            <!-- 費率將由 JS 動態生成 -->
          </div>
          <button class="add-salary-btn" onclick="addTravelRateRecord()">
            <span class="material-symbols-outlined">add</span>
            <span>新增出差地區</span>
          </button>
        </section>
      </div>
    </div>
  </div>

  <?!= include('main'); ?>
</body>

</html>