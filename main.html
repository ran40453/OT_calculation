<script>
  // 全域變數（供 Analytics 功能使用）
  let tableData = [];
  let newRowTravelEnabled = true;
  let selectedMonth = null;
  let charts = {};
  let availableMonths = [];

  ; (function (global) {
    // 在 Apps Script（後端）也會載入這個檔案，但沒有 window / document，所以這裡用 globalThis/this 做防呆
    if (!global || !global.document) {
      return;
    }
    global.__BUILD_TAG__ = '2025-12-04-v2';
    console.log('[OT] BUILD', global.__BUILD_TAG__);

    // 變數已移至全域

    function getWeekdayChar(dateStr) {
      const date = new Date(dateStr);
      const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
      return weekdays[date.getDay()];
    }

    function formatDateYYYYMMDD(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    // 根據國家代碼取得每日 Travel USD
    function getTravelUsdByCountry(country) {
      if (!country || country === 'None') return 0;
      if (country === 'China') return 33;
      if (country === 'India') return 70;
      return 40; // Vietnam 預設
    }

    // 更新: 重新計算所有資料，並重新渲染
    function updateAll(openIndex = null, skipRender = false) {
      const salary = parseFloat(document.getElementById('salary')?.value) || 68000;
      const rate = parseFloat(document.getElementById('usdRate')?.value) || 31.;
      // const travelUsdPerDay = getTravelUsdByCountry(); // 不再使用全域設定

      let accum = 0;
      const monthTravelSums = {}; // key: 'YYYY-MM' -> 該月 Travel 加總
      const monthOtSalarySums = {}; // key: 'YYYY-MM' -> 該月 OT Salary 加總

      // 由前端依 salary / rate / travel 設定重新計算
      tableData.forEach((entry) => {
        const otSum =
          (Number(entry.v167) || 0) * 1.67 +
          (Number(entry.v134) || 0) * 1.34 +
          (Number(entry.v166) || 0) * 1.66 +
          (Number(entry.v267) || 0) * 2.67;

        // 資料遷移：舊資料 travelEnabled=true 轉為 Vietnam，false 轉為 None
        if (!entry.travelCountry) {
          if (entry.travelEnabled === false) entry.travelCountry = 'None';
          else entry.travelCountry = 'Vietnam';
        }

        const base = salary / 30;
        const travelUsd = getTravelUsdByCountry(entry.travelCountry);
        const travel = travelUsd * rate;
        const otSalary = (salary / 30 / 8) * otSum;
        const total = base + travel + otSalary;

        accum += total;

        entry.weekday = getWeekdayChar(entry.date);
        entry.otSum = otSum.toFixed(2);
        entry.base = base.toFixed(2);
        entry.travel = travel.toFixed(2);
        entry.otSalary = otSalary.toFixed(2);
        entry.total = total.toFixed(2);
        entry.accum = accum.toFixed(2);

        // 依月份累積：當月 Travel 與 OT Salary（不含 Base）
        const monthKey = entry.date ? entry.date.slice(0, 7) : '';
        if (monthKey) {
          monthTravelSums[monthKey] = (monthTravelSums[monthKey] || 0) + travel;
          monthOtSalarySums[monthKey] = (monthOtSalarySums[monthKey] || 0) + otSalary;
        }
      });

      // 依月份回寫「月薪」欄位：該月完整 Base（salary）+ 當月 Travel 加總 + 當月 OT Salary 加總
      tableData.forEach((entry) => {
        const monthKey = entry.date ? entry.date.slice(0, 7) : '';
        let monthSLR = 0;
        if (monthKey) {
          const travelSum = monthTravelSums[monthKey] || 0;
          const otSalarySum = monthOtSalarySums[monthKey] || 0;
          // 月薪 = 當月完整 Base (salary) +當月 Travel 加總 + 當月 OT Salary 加總
          monthSLR = salary + travelSum + otSalarySum;
        }
        entry.monthSLR = monthSLR.toFixed(2);
      });

      if (!skipRender) {
        renderDataList(openIndex);
      } else {
        // 只更新表格內現有的數值，不重新渲染
        updateTableValues();
      }
      updateDashboard();
    }

    // 更新表格中已渲染的數值（不重新建立 DOM）
    function updateTableValues() {
      const rows = document.querySelectorAll('.data-row');
      rows.forEach((row, index) => {
        const entry = tableData[index];
        if (!entry) return;

        // 更新 OT 數值顯示
        const steppers = row.querySelectorAll('.stepper-value');
        steppers.forEach((valueSpan, i) => {
          const keys = ['v167', 'v134', 'v166', 'v267'];
          if (entry[keys[i]] !== undefined) {
            valueSpan.textContent = entry[keys[i]];
            // 更新 class
            if (entry[keys[i]] > 0) {
              valueSpan.classList.add('has-value');
            } else {
              valueSpan.classList.remove('has-value');
            }
          }
        });

        // 更新總計
        const totalSpan = row.querySelector('.total-value');
        if (totalSpan) {
          totalSpan.textContent = Math.round(entry.total);
        }
      });
    }
    function fillMissingDatesToToday() {
      if (!tableData.length) {
        showNotification('❌ 目前沒有任何資料，無法自動補滿日期', true);
        return;
      }

      // 找出目前資料中「最新」日期
      let latest = null;
      tableData.forEach((entry) => {
        if (!entry.date) return;
        const d = new Date(entry.date);
        if (isNaN(d)) return;
        if (!latest || d > latest) {
          latest = d;
        }
      });

      if (!latest) {
        showNotification('❌ 目前資料日期格式異常，無法自動補滿日期', true);
        return;
      }

      // 從最新日期的下一天開始補到今天（含）
      const startDate = new Date(latest.getFullYear(), latest.getMonth(), latest.getDate() + 1);
      const today = new Date();
      const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());

      if (startDate > todayDateOnly) {
        showNotification('✅ 目前已補滿至今日，沒有新增資料');
        return;
      }

      let added = 0;
      const addedDates = [];

      for (let d = new Date(startDate); d <= todayDateOnly; d.setDate(d.getDate() + 1)) {
        const dateStr = formatDateYYYYMMDD(d);
        const newEntry = {
          date: dateStr,
          v167: 0,
          v134: 0,
          v166: 0,
          v267: 0,
          remark: '',
          travelEnabled: newRowTravelEnabled,
        };
        tableData.push(newEntry);
        added++;
        addedDates.push(dateStr);
      }

      if (!added) {
        showNotification('✅ 目前已補滿至今日，沒有新增資料');
        return;
      }

      // 重新排序並重算
      tableData.sort((a, b) => new Date(b.date) - new Date(a.date));
      updateAll();

      const first = addedDates[0];
      const last = addedDates[addedDates.length - 1];

      const formatMMDD = (iso) => {
        const mm = iso.slice(5, 7);
        const dd = iso.slice(8, 10);
        return `${mm}${dd}`;
      };

      const msg = `✅ 新增 ${added} 筆，從 ${formatMMDD(first)} 到 ${formatMMDD(last)}`;
      showNotification(msg);
    }

    // 新增資料
    function addNewEntry(entry) {
      tableData.push(entry);
      tableData.sort((a, b) => new Date(b.date) - new Date(a.date)); // 由新到舊
      updateAll();
    }

    // 調整 OT 數值（不重新渲染表格，只更新數值）
    function adjustOTValue(entry, key, delta) {
      const newVal = Math.max(0, (entry[key] || 0) + delta);
      entry[key] = newVal;

      // 只更新該列的數值和計算結果，不重新渲染整個表格
      updateAll(null, true); // 傳入 skipRender=true
    }

    // 數字翻牌動畫通用 helper（逐位數）
    function setAnimatedNumber(element, newValue) {
      if (!element) return;
      const newText = String(newValue);
      const oldText = element.dataset.value ?? element.textContent;

      if (oldText === newText) {
        element.dataset.value = newText;
        return;
      }

      element.dataset.value = newText;
      element.innerHTML = '';

      for (let i = 0; i < newText.length; i++) {
        const ch = newText[i];
        const span = document.createElement('span');
        span.textContent = ch;
        span.classList.add('digit');
        if (oldText[i] !== ch) {
          span.classList.add('flip');
        }
        element.appendChild(span);
      }
    }

    // 簡單的通知氣泡（成功 / 失敗提示）
    function showNotification(message, isError = false) {
      let bubble = document.getElementById('otNotifyBubble');
      if (!bubble) {
        bubble = document.createElement('div');
        bubble.id = 'otNotifyBubble';
        bubble.classList.add('ot-notify-bubble');
        // 基本樣式，之後可用 CSS 覆蓋
        bubble.style.position = 'fixed';
        bubble.style.left = '50%';
        bubble.style.top = '50%';
        bubble.style.transform = 'translate(-50%, -50%)';
        bubble.style.maxWidth = '320px';
        bubble.style.padding = '16px 18px';
        // 移除舊的
        const old = document.querySelector('.ot-notify-bubble');
        if (old) old.remove();

        const bubble = document.createElement('div');
        bubble.classList.add('ot-notify-bubble');

        // 樣式設定
        bubble.style.position = 'fixed';
        bubble.style.padding = '12px 24px';
        bubble.style.borderRadius = '12px';
        bubble.style.color = '#fff';
        bubble.style.fontWeight = '500';
        bubble.style.boxShadow = '0 8px 24px rgba(0,0,0,0.25)';
        bubble.style.zIndex = '9999';
        bubble.style.backdropFilter = 'blur(10px)';
        bubble.style.webkitBackdropFilter = 'blur(10px)';
        bubble.style.transition = 'all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
        bubble.style.opacity = '0';
        bubble.style.pointerEvents = 'none';
        bubble.style.whiteSpace = 'pre-wrap'; /* Support multiline text */
        bubble.style.textAlign = 'left';      /* Align text to left for list */
        bubble.style.lineHeight = '1.5';

        if (isError) {
          bubble.style.background = 'rgba(255, 59, 48, 0.9)';
        } else {
          bubble.style.background = 'rgba(0, 0, 0, 0.8)';
        }

        bubble.textContent = message;
        document.body.appendChild(bubble);

        // 定位計算
        const logoCard = document.querySelector('.logo-card');
        if (logoCard) {
          const rect = logoCard.getBoundingClientRect();
          bubble.style.left = rect.left + 'px';
          bubble.style.width = rect.width + 'px'; // 與 Logo 同寬
          bubble.style.boxSizing = 'border-box'; // 確保 padding 不撐大
          bubble.style.textAlign = 'center';

          // 初始位置：在 Logo 底部上方一點（隱藏狀態）
          const startTop = rect.bottom - 20;
          const endTop = rect.bottom + 10;

          bubble.style.top = endTop + 'px';
          bubble.style.transform = `translateY(-${endTop - startTop}px) scale(0.9)`;

          // 觸發重繪
          requestAnimationFrame(() => {
            bubble.style.opacity = '1';
            bubble.style.transform = 'translateY(0) scale(1)';
          });
        } else {
          // Fallback: 置中顯示
          bubble.style.top = '20px';
          bubble.style.left = '50%';
          bubble.style.transform = 'translateX(-50%) translateY(-20px)';
          requestAnimationFrame(() => {
            bubble.style.opacity = '1';
            bubble.style.transform = 'translateX(-50%) translateY(0)';
          });
        }

        // 自動消失
        setTimeout(() => {
          bubble.style.opacity = '0';
          bubble.style.transform = 'translateY(-20px) scale(0.9)'; // 向上收回
          setTimeout(() => bubble.remove(), 400);
        }, 3000);
      }
    }

    // 同步 Travel Toggle UI（新增列上的 Travel 按鈕）
    function syncTravelToggleUI() {
      const travelToggleBtn = document.getElementById('travelToggle');
      if (travelToggleBtn) {
        if (newRowTravelEnabled) {
          travelToggleBtn.classList.add('on');
        } else {
          travelToggleBtn.classList.remove('on');
        }
      }
    }

    // 渲染資料列表 (Material Design 3 Card List with Calendar View & Month Grouping)
    function renderDataList(openIndex = null) {
      const container = document.getElementById('tableContainer');
      container.innerHTML = '';

      // 添加桌面版星期標題 (只顯示一次)
      if (window.innerWidth >= 1024) {
        const header = document.createElement('div');
        header.classList.add('calendar-header');
        ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
          const el = document.createElement('div');
          el.classList.add('calendar-weekday-label');
          el.textContent = day;
          header.appendChild(el);
        });
        const existingHeader = document.querySelector('.calendar-header');
        if (existingHeader) existingHeader.remove();
        container.parentNode.insertBefore(header, container);
      }

      // 若尚未載入任何資料，渲染空狀態卡片
      if (tableData.length === 0) {
        const card = document.createElement('div');
        card.classList.add('data-card');
        card.style.textAlign = 'center';
        card.style.padding = '32px';
        card.style.cursor = 'pointer';
        card.style.display = 'flex';
        card.style.flexDirection = 'column';
        card.style.alignItems = 'center';
        card.style.justifyContent = 'center';
        // 讓空卡片在桌面版佔滿全寬或置中
        if (window.innerWidth >= 1024) card.style.gridColumn = '1 / -1';

        card.innerHTML = `
          <div style="color: var(--md-sys-color-primary); margin-bottom: 16px;">
            <span class="material-symbols-outlined" style="font-size: 48px;">upload_file</span>
          </div>
          <div style="font: var(--md-sys-typescale-title-medium); margin-bottom: 8px;">No Data Available</div>
          <div style="font: var(--md-sys-typescale-body-medium); color: var(--md-sys-color-on-surface-variant);">
            Tap here to import CSV or add a new entry above
          </div>
        `;

        card.addEventListener('click', () => {
          const importInput = document.getElementById('importCSVCard');
          if (importInput) {
            importInput.click();
          }
        });

        container.appendChild(card);
        updateDashboard();
        return;
      }

      // Sort tableData by Date Descending to ensure grouping works
      tableData.sort((a, b) => new Date(b.date) - new Date(a.date));

      let lastMonthKey = '';

      // Pre-calculate Monthly OT Totals
      const monthlyOTMap = {};
      tableData.forEach(entry => {
        const d = new Date(entry.date);
        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        if (!monthlyOTMap[key]) monthlyOTMap[key] = 0;
        monthlyOTMap[key] += Number(entry.total || 0);
      });

      let currentMonthGroup = null;

      tableData.forEach((entry, index) => {
        // Month Grouping Logic
        const dateObj = new Date(entry.date);
        const currentMonthKey = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}`;

        if (currentMonthKey !== lastMonthKey) {
          const monthHeader = document.createElement('div');
          monthHeader.classList.add('month-header');
          monthHeader.style.cursor = 'pointer'; // Clickable
          monthHeader.title = "Click to toggle month view";

          const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];

          // Left: Title + Collapse Icon
          const leftWrapper = document.createElement('div');
          leftWrapper.style.display = 'flex';
          leftWrapper.style.alignItems = 'center';
          leftWrapper.style.gap = '8px';

          const expandIcon = document.createElement('span');
          expandIcon.classList.add('material-symbols-outlined');
          expandIcon.textContent = 'expand_more';
          expandIcon.style.transition = 'transform 0.2s';

          const title = document.createElement('span');
          title.textContent = `${monthNames[dateObj.getMonth()]} ${dateObj.getFullYear()}`;

          leftWrapper.appendChild(title);
          leftWrapper.appendChild(expandIcon);

          // Right: Chips (OT Total + Salary)
          const rightWrapper = document.createElement('div');
          rightWrapper.style.display = 'flex';
          rightWrapper.style.gap = '8px';
          rightWrapper.style.alignItems = 'center';
          rightWrapper.style.paddingRight = '12px'; // Extra padding requested

          // 1. Monthly OT Total (Yellow)
          const otTotalVal = Math.round(monthlyOTMap[currentMonthKey] || 0);
          const otChip = document.createElement('div');
          otChip.classList.add('info-chip', 'yellow');
          otChip.innerHTML = `<span>+${otTotalVal}</span>`;

          // 2. Monthly Salary (Original)
          const salaryChip = document.createElement('div');
          salaryChip.classList.add('info-chip', 'salary-chip');
          salaryChip.style.background = '#fff9c4';
          salaryChip.style.color = '#5f5200';
          salaryChip.innerHTML = `<span class="material-symbols-outlined" style="font-size: 1.1rem;">monetization_on</span> <span>${Math.round(entry.monthSLR)}</span>`;

          rightWrapper.appendChild(otChip);
          rightWrapper.appendChild(salaryChip);

          monthHeader.appendChild(leftWrapper);
          monthHeader.appendChild(rightWrapper);
          container.appendChild(monthHeader);

          // Create Group Container
          const thisMonthGroup = document.createElement('div');
          thisMonthGroup.classList.add('month-group');
          thisMonthGroup.style.display = 'contents'; // Default open
          container.appendChild(thisMonthGroup);

          // Update global tracker for card appending
          currentMonthGroup = thisMonthGroup;

          // Toggle Logic (Reference thisMonthGroup instead of currentMonthGroup)
          monthHeader.addEventListener('click', () => {
            const isHidden = thisMonthGroup.style.display === 'none';
            thisMonthGroup.style.display = isHidden ? 'contents' : 'none';
            expandIcon.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(-90deg)';
          });

          lastMonthKey = currentMonthKey;
        }

        const card = document.createElement('div');
        card.classList.add('data-card');
        if (openIndex === index) card.classList.add('expanded');

        // Desktop Calendar Alignment
        if (window.innerWidth >= 1024) {
          const weekdayMap = { '日': 1, '一': 2, '二': 3, '三': 4, '四': 5, '五': 6, '六': 7 };
          const col = weekdayMap[entry.weekday] || 1;
          card.style.gridColumn = `${col} / span 1`;
        }

        // --- Header (Card Content) ---
        const header = document.createElement('div');
        header.classList.add('card-header');
        // Sunday Style Logic (Apply to CARD, not just header)
        if (dateObj.getDay() === 0) {
          card.classList.add('sunday');
        }

        // Primary Info: Date & Scoreboard
        const primaryInfo = document.createElement('div');
        primaryInfo.classList.add('card-primary-info');

        const dateWrapper = document.createElement('div');
        dateWrapper.classList.add('card-date-wrapper');

        const dd = String(dateObj.getDate()).padStart(2, '0');

        const dateDay = document.createElement('span');
        dateDay.classList.add('date-day');
        dateDay.textContent = dd;

        const dateWeekday = document.createElement('span');
        dateWeekday.classList.add('date-weekday');
        // Map Chinese weekday to English abbreviation for mobile display
        const weekdayEnMap = { '日': 'Sun', '一': 'Mon', '二': 'Tue', '三': 'Wed', '四': 'Thu', '五': 'Fri', '六': 'Sat' };
        dateWeekday.textContent = weekdayEnMap[entry.weekday] || entry.weekday;

        dateWrapper.appendChild(dateDay);
        dateWrapper.appendChild(dateWeekday);

        // OT Scoreboard Badge
        const otTotal = (entry.v167 + entry.v134 + entry.v166 + entry.v267);
        const val = Math.round(otTotal); // Integer only

        const scoreboard = document.createElement('div');
        scoreboard.classList.add('scoreboard-badge');

        // Color Logic
        if (val === 2) scoreboard.classList.add('green');
        else if (val === 3) scoreboard.classList.add('yellow');
        else if (val === 4) scoreboard.classList.add('orange');
        else if (val === 5) scoreboard.classList.add('red');
        else if (val >= 6) scoreboard.classList.add('purple');

        scoreboard.textContent = val;

        primaryInfo.appendChild(dateWrapper);
        primaryInfo.appendChild(scoreboard);

        // Secondary Info: Salary & Daily OT
        const secondaryInfo = document.createElement('div');
        secondaryInfo.classList.add('card-secondary-info');



        // Daily OT Salary
        const dailyTotalChip = document.createElement('div');
        dailyTotalChip.classList.add('info-chip', 'yellow', 'daily-total-chip'); // Added yellow class and specific class
        dailyTotalChip.id = `chip-daily-${index}`;
        dailyTotalChip.innerHTML = `<span>+${Math.round(entry.total)}</span>`;

        // Travel Icon
        const travelChip = document.createElement('div');
        travelChip.classList.add('info-chip', 'travel-chip');
        travelChip.id = `chip-travel-${index}`;
        const countryMap = { 'Vietnam': 'VN', 'China': 'CN', 'India': 'IN', 'None': '--' };
        const countryCode = countryMap[entry.travelCountry] || '--';

        if (entry.travelCountry && entry.travelCountry !== 'None') {
          travelChip.classList.add('active'); // Blue background style
          travelChip.innerHTML = `<span class="material-symbols-outlined">flight</span> <span>${countryCode}</span>`;
        } else {
          travelChip.innerHTML = `<span class="material-symbols-outlined" style="opacity:0.5">flight</span> <span>--</span>`;
        }

        // secondaryInfo.appendChild(salaryChip); // Removed from card
        secondaryInfo.appendChild(dailyTotalChip);
        secondaryInfo.appendChild(travelChip);

        const expandIcon = document.createElement('span');
        expandIcon.classList.add('material-symbols-outlined', 'card-expand-icon');
        expandIcon.textContent = 'expand_more';

        header.appendChild(primaryInfo);
        header.appendChild(secondaryInfo);
        header.appendChild(expandIcon);

        // --- Body ---
        const body = document.createElement('div');
        body.classList.add('card-body');

        // Hours Grid (Circular Steppers)
        const grid = document.createElement('div');
        grid.classList.add('hours-grid');

        ['v167', 'v134', 'v166', 'v267'].forEach(key => {
          const item = document.createElement('div');
          item.classList.add('hour-item');

          const label = document.createElement('div');
          label.classList.add('hour-label');
          const labelText = key.replace('v', '').replace(/(\d)(\d{2})/, '$1.$2');
          label.textContent = labelText;

          const stepper = document.createElement('div');
          stepper.classList.add('smart-stepper');
          if (entry[key] > 0) stepper.classList.add('has-value');
          stepper.textContent = entry[key].toFixed(1);
          stepper.dataset.entryIndex = index;
          stepper.dataset.key = key;

          item.appendChild(label);
          item.appendChild(stepper);
          grid.appendChild(item);
        });

        // Travel Toggle (In Submenu)
        // Mobile Layout: Try to put it inline or below
        const travelToggleRow = document.createElement('div');
        travelToggleRow.classList.add('travel-toggle-row');

        const travelLabel = document.createElement('span');
        travelLabel.textContent = 'Travel Location';
        travelLabel.style.fontSize = '0.9rem';
        travelLabel.style.color = 'var(--md-sys-color-on-surface-variant)';

        const travelSelect = document.createElement('div');
        travelSelect.classList.add('capsule');
        travelSelect.style.cursor = 'pointer';
        const countryShortMap = { 'Vietnam': 'VN', 'China': 'CN', 'India': 'IN', 'None': '--' };
        travelSelect.textContent = countryShortMap[entry.travelCountry] || '--';
        if (entry.travelCountry && entry.travelCountry !== 'None') {
          travelSelect.style.background = 'var(--md-sys-color-primary-container)';
          travelSelect.style.color = 'var(--md-sys-color-on-primary-container)';
        }

        travelSelect.addEventListener('click', (e) => {
          e.stopPropagation();
          const countries = ['None', 'Vietnam', 'China', 'India'];
          const currentIdx = countries.indexOf(entry.travelCountry || 'None');
          const nextIdx = (currentIdx + 1) % countries.length;
          entry.travelCountry = countries[nextIdx];
          renderDataList(index); // Re-render keeping expanded
        });

        travelToggleRow.appendChild(travelLabel);
        travelToggleRow.appendChild(travelSelect);

        // Footer
        const footer = document.createElement('div');
        footer.classList.add('card-footer');

        const remark = document.createElement('div');
        remark.classList.add('remark-text');
        remark.textContent = entry.remark || 'No remarks';

        const actions = document.createElement('div');
        actions.classList.add('card-actions');

        const actionBtn = document.createElement('button');
        actionBtn.classList.add('action-btn', 'delete');
        actionBtn.innerHTML = '<span class="material-symbols-outlined">delete</span>';
        actionBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (confirm('確定刪除?')) {
            deleteEntry(index);
          }
        });

        actions.appendChild(actionBtn);
        footer.appendChild(remark);
        footer.appendChild(actions);

        body.appendChild(grid);
        body.appendChild(travelToggleRow);
        body.appendChild(footer);

        card.appendChild(header);
        card.appendChild(body);
        // Append to Current Month Group instead of container directly
        if (currentMonthGroup) {
          currentMonthGroup.appendChild(card);
        } else {
          container.appendChild(card); // Fallback
        }

        // Expansion Logic
        header.addEventListener('click', () => {
          if (openIndex === index) {
            openIndex = -1;
            card.classList.remove('expanded');
          } else {
            openIndex = index;
            document.querySelectorAll('.data-card.expanded').forEach(c => c.classList.remove('expanded'));
            card.classList.add('expanded');
          }
        });
      });

      updateDashboard();
    }

    // 新增按鈕事件
    document.getElementById('addRowCard').addEventListener('click', () => {
      const newEntry = {
        date: document.getElementById('newDate').value,
        v167: parseFloat(document.getElementById('new167').value) || 0,
        v134: parseFloat(document.getElementById('new134').value) || 0,
        v166: parseFloat(document.getElementById('new166').value) || 0,
        v267: parseFloat(document.getElementById('new267').value) || 0,
        remark: document.getElementById('newRemark').value,
        travelEnabled: newRowTravelEnabled,
      };
      if (!newEntry.date) {
        alert('請選擇日期');
        return;
      }
      addNewEntry(newEntry);

      // 清空輸入欄位
      document.getElementById('newDate').value = '';
      document.getElementById('new167').value = '';
      document.getElementById('new134').value = '';
      document.getElementById('new166').value = '';
      document.getElementById('new267').value = '';
      document.getElementById('newRemark').value = '';
    });

    // === 將目前表格資料整理成可寫回 Sheet 的結構 ===
    function buildSheetPayload() {
      const headers = [
        'date',
        'weekday',
        '1.67',
        '1.34',
        '1.66',
        '2.67',
        'OT hr SUM',
        'Base',
        'Travel',
        'OT Salary',
        'Total',
        'Month SLR',
        'Remark',
      ];
      const rows = tableData.map((entry) => [
        entry.date || '',
        entry.weekday || getWeekdayChar(entry.date || ''),
        Number(entry.v167 || 0),
        Number(entry.v134 || 0),
        Number(entry.v166 || 0),
        Number(entry.v267 || 0),
        String(entry.otSum || 0),
        String(entry.base || 0),
        String(entry.travel || 0),
        String(entry.otSalary || 0),
        String(entry.total || 0),
        String(entry.monthSLR || 0),
        entry.remark || '',
      ]);
      return { headers, rows };
    }

    // === 統計用工具函式（方便其他地方重用） ===
    function getTotalRecordCount() {
      return tableData.length;
    }

    function getLatestMonthKey() {
      let latestDate = null;
      tableData.forEach((entry) => {
        if (!entry.date) return;
        const d = new Date(entry.date);
        if (isNaN(d)) return;
        if (!latestDate || d > latestDate) {
          latestDate = d;
        }
      });
      if (!latestDate) return '';
      const yyyy = latestDate.getFullYear();
      const mm = String(latestDate.getMonth() + 1).padStart(2, '0');
      return `${yyyy}-${mm}`;
    }

    function getMonthlyTravelDays(monthKey) {
      if (!monthKey) return 0;
      return tableData.filter(
        (entry) => entry.date && entry.date.slice(0, 7) === monthKey
      ).length;
    }

    function getMonthlyOtHours(monthKey) {
      if (!monthKey) return 0;
      let sum = 0;
      tableData.forEach((entry) => {
        if (!entry.date || entry.date.slice(0, 7) !== monthKey) return;
        sum +=
          (parseFloat(entry.v167) || 0) +
          (parseFloat(entry.v134) || 0) +
          (parseFloat(entry.v166) || 0) +
          (parseFloat(entry.v267) || 0);
      });
      return sum;
    }

    function getMonthlySalary(monthKey) {
      if (!monthKey) return 0;
      const found = tableData.find(
        (entry) => entry.date && entry.date.slice(0, 7) === monthKey && entry.monthSLR
      );
      return found ? parseFloat(found.monthSLR) || 0 : 0;
    }

    function getMonthlyAverageDailySalary(monthKey) {
      if (!monthKey) return 0;
      let sum = 0;
      let count = 0;
      tableData.forEach((entry) => {
        if (!entry.date || entry.date.slice(0, 7) !== monthKey) return;
        const total = parseFloat(entry.total || 0);
        if (!isNaN(total)) {
          sum += total;
          count += 1;
        }
      });
      if (!count) return 0;
      return sum / count;
    }

    // 共用：取得當月摘要訊息
    function getMonthlySummaryText() {
      const totalCount = getTotalRecordCount();
      const monthKey = getLatestMonthKey();

      if (!monthKey) {
        return `已記錄 ${totalCount} 筆資料`;
      }

      const travelDays = getMonthlyTravelDays(monthKey);
      const otHours = getMonthlyOtHours(monthKey);
      const monthSalary = getMonthlySalary(monthKey);
      const avgDaily = getMonthlyAverageDailySalary(monthKey);

      const [year, month] = monthKey.split('-');
      const prettyMonth = `${year}/${month}`;

      const msgLines = [
        `已記錄 ${totalCount} 筆資料`,
        `${prettyMonth} 已出差 ${travelDays} 天`,
        `${prettyMonth} 已加班 ${otHours.toFixed(2)} 小時`,
        `${prettyMonth} 月薪：${Math.round(monthSalary)}`,
        `${prettyMonth} 平均日薪：約 ${Math.round(avgDaily)}`,
      ];

      return msgLines.join('\n');
    }

    // === 觸發寫回 Google Sheet ===
    async function saveToSheet() {
      const payload = buildSheetPayload();

      // 直接嘗試透過 google.script.run 呼叫後端；若不存在則視為純前端環境
      try {
        if (!google || !google.script || !google.script.run) {
          throw new Error('google.script.run not available');
        }
      } catch (e) {
        alert('請從 Apps Script 網頁版本開啟，才能把資料寫回 Google Sheet。\n目前這個頁面僅作為前端試算使用。');
        showNotification('❌ 上傳失敗：無法連線到 Google Apps Script 環境', true);
        return;
      }

      return new Promise((resolve, reject) => {
        const btn = document.getElementById('saveToSheetBtn');
        if (btn) btn.classList.add('loading');

        google.script.run
          .withSuccessHandler((res) => {
            if (btn) btn.classList.remove('loading');
            console.log('[OT] saveOvertimeData OK:', res);

            // 成功後顯示當前統計資訊（共用組字函式）
            const summary = getMonthlySummaryText();
            showNotification('✅ ' + summary);

            resolve(res);
          })
          .withFailureHandler((err) => {
            if (btn) btn.classList.remove('loading');
            console.error('[OT] saveOvertimeData FAIL:', err);

            const errMsg = err && (err.message || err.toString()) ? (err.message || err.toString()) : '未知錯誤';
            alert('寫回 Google Sheet 失敗，請稍後再試。\n原因：' + errMsg);
            showNotification('❌ 上傳失敗：' + errMsg, true);

            reject(err);
          })
          .saveOvertimeData(payload);
      });
    }

    // 匯出 CSV
    document
      .getElementById('exportCSVCard')
      .addEventListener('click', () => {
        let csv =
          'date,weekday,1.67,1.34,1.66,2.67,OT hr SUM,Base,Travel,OT Salary,Total,Month SLR,Remark\n';
        tableData.forEach((entry) => {
          csv +=
            [
              entry.date,
              entry.weekday,
              entry.v167,
              entry.v134,
              entry.v166,
              entry.v267,
              entry.otSum,
              entry.base,
              entry.travel,
              entry.otSalary,
              entry.total,
              entry.monthSLR,
              entry.remark,
            ].join(',') + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);

        // 以本地時間產生 yyyymmdd（例如：20251112）
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        const filename = `overtime_${yyyy}${mm}${dd}.csv`;

        link.download = filename;
        link.click();
      });

    // 匯入 CSV
    document
      .getElementById('importCSVCard')
      .addEventListener('change', function (e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function (event) {
          const text = event.target.result;
          parseCSV(text);
          updateAll();
        };
        reader.readAsText(file);
      });

    function parseCSV(text) {
      const lines = text
        .split('\n')
        .filter((line) => line.trim() !== '');
      tableData = lines.slice(1).map((line) => {
        const cols = line.split(',');
        return {
          date: cols[0],
          v167: parseFloat(cols[2]) || 0,
          v134: parseFloat(cols[3]) || 0,
          v166: parseFloat(cols[4]) || 0,
          v267: parseFloat(cols[5]) || 0,
          remark: cols[13] || '', // N 欄備註
          travelEnabled: true, // 匯入資料預設有 Travel，之後可用 toggle 關閉
        };
      });
    }

    // 更新 Dashboard 總計
    function updateDashboard() {
      let totalOT = 0,
        totalBase = 0,
        totalTravel = 0,
        totalOTSalary = 0,
        totalCost = 0;
      const monthSalaryMap = {}; // key: 'YYYY-MM' -> 該月月薪，只取一次
      const travelDays = tableData.length; // ★ 出差天數 = 所有列數

      tableData.forEach((entry) => {
        totalOT +=
          (parseFloat(entry.v167) || 0) +
          (parseFloat(entry.v134) || 0) +
          (parseFloat(entry.v166) || 0) +
          (parseFloat(entry.v267) || 0);
        totalBase += parseFloat(entry.base || 0);
        totalTravel += parseFloat(entry.travel || 0);
        totalOTSalary += parseFloat(entry.otSalary || 0);
        totalCost += parseFloat(entry.total || 0);

        const monthKey = entry.date ? entry.date.slice(0, 7) : '';
        if (monthKey && entry.monthSLR) {
          // 只在第一次遇到這個月份時記錄
          if (!monthSalaryMap[monthKey]) {
            monthSalaryMap[monthKey] = parseFloat(entry.monthSLR) || 0;
          }
        }
      });

      // 所有月份的月薪加總
      const totalSalary = Object.values(monthSalaryMap).reduce(
        (sum, val) => sum + val,
        0
      );

      // ★ 新增：出差天數（所有列數）
      setAnimatedNumber(
        document.getElementById('travelDays'),
        String(travelDays)
      );

      setAnimatedNumber(
        document.getElementById('totalOT'),
        totalOT.toFixed(2)
      );
      setAnimatedNumber(
        document.getElementById('totalBase'),
        Math.round(totalBase)
      );
      setAnimatedNumber(
        document.getElementById('totalTravel'),
        Math.round(totalTravel)
      );
      setAnimatedNumber(
        document.getElementById('totalOTSalary'),
        Math.round(totalOTSalary)
      );
      setAnimatedNumber(
        document.getElementById('totalCost'),
        Math.round(totalCost)
      );
      setAnimatedNumber(
        document.getElementById('totalSalary'),
        Math.round(totalSalary)
      );
    }

    // 當月薪或匯率輸入變更時，自動重新計算
    document.getElementById('salary').addEventListener('input', () => {
      updateAll();
    });

    document.getElementById('usdRate').addEventListener('input', () => {
      updateAll();
    });

    // 新增列上的 Travel toggle 按鈕：只控制「新資料預設是否有 Travel」
    const travelToggleBtn = document.getElementById('travelToggle');
    if (travelToggleBtn) {
      travelToggleBtn.addEventListener('click', () => {
        newRowTravelEnabled = !newRowTravelEnabled;
        syncTravelToggleUI();
      });
    }

    // === Google Sheet 相關工具（HtmlService 版：優先走 google.script.run） ===

    // === Google Sheet 相關工具（HtmlService 版：直接吃 Template 注入的初始資料） ===
    async function loadFromSheet() {
      try {
        const payload = window.__OT_INIT_PAYLOAD__;
        let rows = [];
        if (Array.isArray(payload)) {
          rows = payload;
        } else if (payload && Array.isArray(payload.data)) {
          rows = payload.data;
        }

        console.log('[OT] Template payload:', payload);

        if (rows && rows.length > 0) {
          console.log('[OT] 使用 Template 資料初始化表格');
          initTableFromPayload({ data: rows });
          showNotification(`✅ 已載入 ${rows.length} 筆資料`);
        } else {
          console.warn('[OT] Template 資料為空，嘗試透過 API 重新抓取...');
          // Fallback: 嘗試用 google.script.run 抓取
          if (typeof google !== 'undefined' && google.script && google.script.run) {
            google.script.run
              .withSuccessHandler((res) => {
                console.log('[OT] API 抓取成功:', res);
                if (res && res.data && res.data.length > 0) {
                  initTableFromPayload(res);
                  showNotification(`✅ 透過 API 載入 ${res.data.length} 筆資料`);
                } else {
                  console.warn('[OT] API 資料也為空');
                  renderDataList(); // 顯示空表
                  showNotification('⚠️ 無法讀取資料，請檢查 Google Sheet 是否有資料', true);
                }
              })
              .withFailureHandler((err) => {
                console.error('[OT] API 抓取失敗:', err);
                renderDataList(); // 顯示空表
                showNotification('❌ 資料讀取失敗，請檢查網路或權限', true);
              })
              .getOvertimeData();
          } else {
            console.warn('[OT] 無法使用 google.script.run，顯示空表');
            renderDataList();
            syncTravelToggleUI();
          }
        }
      } catch (e) {
        console.error('[OT] loadFromSheet 發生錯誤:', e);
        renderDataList();
        syncTravelToggleUI();
        showNotification('❌ 初始化失敗: ' + e.message, true);
      }
    }

    function initTableFromPayload(payload) {
      const rows = payload && payload.data ? payload.data : [];
      tableData = rows.map((row) => {
        let rawDate = row.date;

        // Apps Script 透過 google.script.run 傳過來，date 可能是 Date 物件，也可能是字串
        if (rawDate instanceof Date) {
          const d = rawDate;
          const yyyy = d.getFullYear();
          const mm = String(d.getMonth() + 1).padStart(2, '0');
          const dd = String(d.getDate()).padStart(2, '0');
          rawDate = `${yyyy}-${mm}-${dd}`;
        } else if (typeof rawDate === 'string') {
          // 若是 ISO 字串（含 T），轉成 YYYY-MM-DD
          if (rawDate.includes('T')) {
            const d = new Date(rawDate);
            if (!isNaN(d)) {
              const yyyy = d.getFullYear();
              const mm = String(d.getMonth() + 1).padStart(2, '0');
              const dd = String(d.getDate()).padStart(2, '0');
              rawDate = `${yyyy}-${mm}-${dd}`;
            } else {
              rawDate = rawDate.slice(0, 10);
            }
          } else {
            // 一般字串格式，保留前 10 碼（預期是 YYYY-MM-DD 或類似）
            rawDate = rawDate.slice(0, 10);
          }
        } else {
          // 其它型別（null/undefined），給空字串避免後續崩潰
          rawDate = '';
        }

        const v167 = Number(row.v167 ?? row['1.67'] ?? 0);
        const v134 = Number(row.v134 ?? row['1.34'] ?? 0);
        const v166 = Number(row.v166 ?? row['1.66'] ?? 0);
        const v267 = Number(row.v267 ?? row['2.67'] ?? 0);

        const baseRaw = row.base ?? row.Base ?? '';
        const travelRaw = row.travel ?? row.Travel ?? '';
        const otSalaryRaw = row.otSalary ?? row['OT Salary'] ?? '';
        const totalRaw = row.total ?? row.Total ?? '';
        const monthSlrRaw = row.monthSLR ?? row['Month SLR'] ?? '';
        const otSumRaw = row.otSum ?? row['OT hr SUM'] ?? '';
        const remarkRaw = row.remark ?? row.Remark ?? '';

        // 依照 Sheet 內存的 Travel 數值決定這一列是否「有出差」
        // Travel 為 0 或空 → 視為無出差（travelEnabled = false）
        const travelNum = Number(travelRaw) || 0;
        const travelEnabled = travelNum > 0;

        return {
          date: rawDate,
          weekday: row.weekday || (rawDate ? getWeekdayChar(rawDate) : ''),
          v167,
          v134,
          v166,
          v267,
          base: baseRaw.toString(),
          travel: travelRaw.toString(),
          otSalary: otSalaryRaw.toString(),
          total: totalRaw.toString(),
          monthSLR: monthSlrRaw.toString(),
          otSum: otSumRaw.toString(),
          remark: remarkRaw,
          travelEnabled,
        };
      });

      tableData.sort((a, b) => new Date(b.date) - new Date(a.date));
      updateAll();
    }

    // === End Google Sheet 相關工具 ===

    // === Smart Stepper Add Card 互動邏輯 ===
    const newAddCardState = {
      date: null, // YYYY-MM-DD
      v167: 0,
      v134: 0,
      v166: 0,
      v267: 0,
      travel: 'Vietnam'
    };

    const travelOptions = ['None', 'Vietnam', 'China', 'India'];
    const travelDisplay = { 'None': '-', 'Vietnam': 'VN', 'China': 'CN', 'India': 'IN' };

    // 初始化 Smart Stepper Add按鈕
    function initAddCardSteppers() {
      const dateBtn = document.getElementById('newDate');
      const travelBtn = document.getElementById('newTravelCountry');
      const hourBtns = ['new167', 'new134', 'new166', 'new267'];

      // 日期按鈕：點擊開啟日期選擇器
      if (dateBtn) {
        dateBtn.addEventListener('click', () => {
          const input = document.createElement('input');
          input.type = 'date';
          input.value = newAddCardState.date || '';

          // 直接插入到頁面並觸發
          input.style.position = 'fixed';
          input.style.top = '50%';
          input.style.left = '50%';
          input.style.transform = 'translate(-50%, -50%)';
          input.style.zIndex = '10000';
          document.body.appendChild(input);

          input.addEventListener('change', () => {
            if (input.value) {
              newAddCardState.date = input.value;
              const d = new Date(input.value);
              const mm = String(d.getMonth() + 1).padStart(2, '0');
              const dd = String(d.getDate()).padStart(2, '0');
              dateBtn.textContent = `${mm}/${dd}`;
              dateBtn.classList.add('has-value');
            }
            document.body.removeChild(input);
          });

          input.addEventListener('blur', () => {
            setTimeout(() => {
              if (document.body.contains(input)) {
                document.body.removeChild(input);
              }
            }, 100);
          });

          // 延遲觸發以確保元素已插入DOM
          setTimeout(() => {
            input.focus();
            input.click();
          }, 50);
        });
      }

      // Travel 按鈕：拖曳循環切換
      if (travelBtn) {
        let dragState = null;

        travelBtn.addEventListener('mousedown', (e) => {
          dragState = { startY: e.clientY, moved: false };
          travelBtn.classList.add('active');
        });

        document.addEventListener('mousemove', (e) => {
          if (!dragState) return;
          const deltaY = dragState.startY - e.clientY;
          if (Math.abs(deltaY) > 10) dragState.moved = true;

          if (Math.abs(deltaY) > 30) {
            const currentIdx = travelOptions.indexOf(newAddCardState.travel);
            const newIdx = deltaY > 0
              ? (currentIdx + 1) % travelOptions.length
              : (currentIdx - 1 + travelOptions.length) % travelOptions.length;
            newAddCardState.travel = travelOptions[newIdx];
            travelBtn.textContent = travelDisplay[newAddCardState.travel];
            dragState.startY = e.clientY;
          }
        });

        document.addEventListener('mouseup', () => {
          if (dragState && !dragState.moved) {
            // 點擊：切換到下一個
            const currentIdx = travelOptions.indexOf(newAddCardState.travel);
            const newIdx = (currentIdx + 1) % travelOptions.length;
            newAddCardState.travel = travelOptions[newIdx];
            travelBtn.textContent = travelDisplay[newAddCardState.travel];
          }
          if (dragState) {
            travelBtn.classList.remove('active');
            dragState = null;
          }
        });
      }

      // 小時按鈕：拖曳調整（即時顯示，單位1）
      hourBtns.forEach(id => {
        const btn = document.getElementById(id);
        if (!btn) return;

        const key = btn.dataset.key;
        let dragState = null;

        btn.addEventListener('mousedown', (e) => {
          e.preventDefault();
          dragState = {
            startY: e.clientY,
            lastY: e.clientY,
            accumulatedDelta: 0
          };
          btn.classList.add('active');
        });

        document.addEventListener('mousemove', (e) => {
          if (!dragState) return;
          e.preventDefault();

          const deltaY = dragState.lastY - e.clientY;
          dragState.lastY = e.clientY;
          dragState.accumulatedDelta += deltaY;

          const threshold = 30;
          if (Math.abs(dragState.accumulatedDelta) >= threshold) {
            const steps = Math.floor(Math.abs(dragState.accumulatedDelta) / threshold);
            const direction = dragState.accumulatedDelta > 0 ? 1 : -1;

            for (let i = 0; i < steps; i++) {
              newAddCardState[key] = Math.max(0, newAddCardState[key] + direction);
            }

            // 即時更新顯示
            btn.textContent = newAddCardState[key].toFixed(1);
            if (newAddCardState[key] > 0) {
              btn.classList.add('has-value');
            } else {
              btn.classList.remove('has-value');
            }

            dragState.accumulatedDelta = dragState.accumulatedDelta % threshold;
          }
        });

        document.addEventListener('mouseup', () => {
          if (dragState) {
            btn.classList.remove('active');
            dragState = null;
          }
        });

        // Touch Events for Mobile
        btn.addEventListener('touchstart', (e) => {
          if (e.cancelable) e.preventDefault();
          const touch = e.touches[0];
          dragState = {
            startY: touch.clientY,
            lastY: touch.clientY,
            accumulatedDelta: 0
          };
          btn.classList.add('active');
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
          if (!dragState) return;
          if (e.cancelable) e.preventDefault(); // Prevent scrolling

          const touch = e.touches[0];
          const deltaY = dragState.lastY - touch.clientY;
          dragState.lastY = touch.clientY;
          dragState.accumulatedDelta += deltaY;

          const threshold = 30; // Sensitivity
          if (Math.abs(dragState.accumulatedDelta) >= threshold) {
            const steps = Math.floor(Math.abs(dragState.accumulatedDelta) / threshold);
            const direction = dragState.accumulatedDelta > 0 ? 1 : -1;

            for (let i = 0; i < steps; i++) {
              newAddCardState[key] = Math.max(0, newAddCardState[key] + direction);
            }

            // Real-time update
            btn.textContent = newAddCardState[key].toFixed(1);
            if (newAddCardState[key] > 0) {
              btn.classList.add('has-value');
            } else {
              btn.classList.remove('has-value');
            }

            dragState.accumulatedDelta = dragState.accumulatedDelta % threshold;
          }
        }, { passive: false });

        document.addEventListener('touchend', () => {
          if (dragState) {
            btn.classList.remove('active');
            dragState = null;
          }
        });
      });
    }

    // 綁定新增按鈕
    const addBtn = document.getElementById('addRowCard');
    if (addBtn) {
      addBtn.addEventListener('click', () => {
        if (!newAddCardState.date) {
          showNotification('請選擇日期', true);
          return;
        }

        // 檢查日期是否重複
        const exists = tableData.some((d) => d.date === newAddCardState.date);
        if (exists) {
          showNotification('該日期已存在', true);
          return;
        }

        const newEntry = {
          date: newAddCardState.date,
          v167: newAddCardState.v167,
          v134: newAddCardState.v134,
          v166: newAddCardState.v166,
          v267: newAddCardState.v267,
          remark: '',
          travelCountry: newAddCardState.travel,
        };

        addNewEntry(newEntry);

        // 重置狀態
        newAddCardState.date = null;
        newAddCardState.v167 = 0;
        newAddCardState.v134 = 0;
        newAddCardState.v166 = 0;
        newAddCardState.v267 = 0;
        newAddCardState.travel = 'Vietnam';

        document.getElementById('newDate').textContent = '--/--';
        document.getElementById('newDate').classList.remove('has-value');
        document.getElementById('new167').textContent = '0.0';
        document.getElementById('new167').classList.remove('has-value');
        document.getElementById('new134').textContent = '0.0';
        document.getElementById('new134').classList.remove('has-value');
        document.getElementById('new166').textContent = '0.0';
        document.getElementById('new166').classList.remove('has-value');
        document.getElementById('new267').textContent = '0.0';
        document.getElementById('new267').classList.remove('has-value');
        document.getElementById('newTravelCountry').textContent = 'VN';

        showNotification('✅ 已新增一筆資料');
      });
    }

    // 綁定「回傳到 Google Sheet」按鈕（HTML 之後加上 id="saveToSheetBtn"）
    const saveBtn = document.getElementById('saveToSheetBtn');
    if (saveBtn) {
      saveBtn.addEventListener('click', async () => {
        try {
          saveBtn.disabled = true;
          await saveToSheet();
        } finally {
          saveBtn.disabled = false;
        }
      });
    } else {
      console.log(
        '[OT] saveToSheetBtn 尚未加入 HTML，待之後加上即可使用。'
      );
    }

    // Settings Card Toggle Logic
    if (global) {
      global.toggleSettingsCard = function () {
        const body = document.getElementById('settingsBody');
        const icon = document.getElementById('settingsExpandIcon');
        if (body.style.display === 'none') {
          body.style.display = 'block';
          icon.style.transform = 'rotate(180deg)';
        } else {
          body.style.display = 'none';
          icon.style.transform = 'rotate(0deg)';
        }
      };
    }

    const fillBtn = document.getElementById('fillMissingDatesBtn');
    if (fillBtn) {
      fillBtn.addEventListener('click', () => {
        fillMissingDatesToToday();
      });
    } else {
      console.log(
        '[OT] fillMissingDatesBtn 尚未加入 HTML，待之後加上即可使用。'
      );
    }

    // 初始載入：在 Apps Script Web App 中會從 Sheet 讀取資料，其他情況顯示空白假表
    loadFromSheet();

    // 預留給 LOGO 點擊呼叫的函式：顯示當月統計通知
    if (global) {
      global.showOtMonthlySummary = function () {
        const summary = getMonthlySummaryText();
        showNotification('✅ ' + summary);
      };

      // 暴露到全域供 Analytics 使用
      global.updateAll = updateAll;
      global.showNotification = showNotification;
    }
    // ========== Analytics 升級功能 (已合併至同一 Scope) ==========
    // 由於 analytics.js 需要存取 tableData 等全域變數，直接在此內嵌

    // ========== 分頁切換 ==========
    function initTabNavigation() {
      const tabBtns = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');

      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const targetTab = btn.dataset.tab;

          tabBtns.forEach(b => b.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));

          btn.classList.add('active');
          const targetContent = document.getElementById(`${targetTab}-tab`);
          if (targetContent) {
            targetContent.classList.add('active');
          }

          if (targetTab === 'analytics') {
            setTimeout(() => {
              if (window.charts && window.charts.overtime) window.charts.overtime.resize();
              if (window.charts && window.charts.income) window.charts.income.resize();
              updateCharts();
              updateAnalyticsStats();
            }, 50);
          }
        });
      });
    }

    // ========== 月份過濾 ==========
    function populateMonthFilter() {
      const filter = document.getElementById('monthFilter');
      if (!filter) return;

      // 收集所有月份
      const months = new Set();
      tableData.forEach(e => {
        if (e.date) months.add(e.date.slice(0, 7));
      });

      // 排序（新到舊）
      const sortedMonths = Array.from(months).sort().reverse();
      availableMonths = sortedMonths;

      // 清空並重建
      filter.innerHTML = '<option value="">全部月份</option>';
      sortedMonths.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = m;
        filter.appendChild(opt);
      });

      // 綁定事件
      filter.addEventListener('change', (e) => {
        selectedMonth = e.target.value || null;
        updateAll();
        updateCharts();
        updateAnalyticsStats();
      });
    }

    // ========== Chart.js 圖表 ==========
    function initCharts() {
      if (typeof Chart === 'undefined') return;

      const ctx1 = document.getElementById('overtimeChart');
      if (ctx1) {
        charts.overtime = new Chart(ctx1, {
          type: 'bar',
          data: {
            labels: [],
            datasets: [{
              label: '加班時數',
              data: [],
              backgroundColor: 'rgba(160,231,160,0.8)',
              borderColor: 'rgba(160,231,160,1)',
              borderWidth: 2,
              borderRadius: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
              x: { grid: { display: false } }
            }
          }
        });
      }

      const ctx2 = document.getElementById('incomeChart');
      if (ctx2) {
        charts.income = new Chart(ctx2, {
          type: 'doughnut',
          data: {
            labels: ['Base 薪資', 'Travel 津貼', 'OT 加班費'],
            datasets: [{
              data: [0, 0, 0],
              backgroundColor: [
                'rgba(100,100,100,0.8)',
                'rgba(255,200,124,0.8)',
                'rgba(160,231,160,0.8)'
              ],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } }
          }
        });
      }
    }

    // 更新圖表數據
    function updateCharts() {
      if (!charts.overtime || !charts.income) return;

      // 收入結構數據 (受 filter 影響)
      let totalBase = 0;
      let totalTravel = 0;
      let totalOtPay = 0;

      tableData.forEach(entry => {
        const mKey = entry.date.slice(0, 7);
        if (selectedMonth && mKey !== selectedMonth) return;

        totalBase += parseFloat(entry.base || 0);
        totalTravel += parseFloat(entry.travel || 0);
        totalOtPay += parseFloat(entry.otSalary || 0);
      });

      // 趨勢圖數據 (永遠顯示所有月份)
      const allMonthsData = {};
      tableData.forEach(e => {
        const k = e.date.slice(0, 7);
        if (!allMonthsData[k]) allMonthsData[k] = 0;
        allMonthsData[k] += parseFloat(e.otSum || 0);
      });

      const sortedMonths = Object.keys(allMonthsData).sort();
      charts.overtime.data.labels = sortedMonths;
      charts.overtime.data.datasets[0].data = sortedMonths.map(m => allMonthsData[m]);

      // 高亮選擇的月份 (橘紅色)
      const bgColors = sortedMonths.map(m =>
        m === selectedMonth ? 'rgba(255, 59, 48, 0.9)' : 'rgba(52, 199, 89, 0.6)'
      );
      const borderColors = sortedMonths.map(m =>
        m === selectedMonth ? 'rgba(255, 59, 48, 1)' : 'rgba(52, 199, 89, 1)'
      );

      charts.overtime.data.datasets[0].backgroundColor = bgColors;
      charts.overtime.data.datasets[0].borderColor = borderColors;

      charts.overtime.update();

      // 更新收入結構圖
      charts.income.data.datasets[0].data = [totalBase, totalTravel, totalOtPay];
      charts.income.update();
    }

    // 更新統計卡片
    function updateAnalyticsStats() {
      let workDays = 0;
      let totalOT = 0;
      let travelDays = 0;
      let totalIncome = 0;

      let weekdayDays = 0;
      let weekendDays = 0;
      let thisMonthIncome = 0;

      // 根據篩選器決定計算範圍
      const targetData = selectedMonth
        ? tableData.filter(e => e.date.startsWith(selectedMonth))
        : tableData;

      targetData.forEach(entry => {
        workDays++;
        totalOT += parseFloat(entry.otSum || 0);
        // 檢查 travelCountry 是否為 None
        if (entry.travelCountry && entry.travelCountry !== 'None') travelDays++;
        else if (entry.travelEnabled) travelDays++; // 相容舊資料

        const income = parseFloat(entry.total || 0);
        totalIncome += income;

        // 判斷平日/週末
        const day = new Date(entry.date).getDay();
        if (day === 0 || day === 6) weekendDays++;
        else weekdayDays++;

        // 本月收入
        const currentMonthKey = formatDateYYYYMMDD(new Date()).slice(0, 7);
        if (entry.date.startsWith(currentMonthKey)) {
          thisMonthIncome += income;
        }
      });

      // 如果有選月份，「本月收入」就顯示該月收入
      if (selectedMonth) {
        thisMonthIncome = totalIncome;
      }

      // 平均計算
      const avgDaily = workDays > 0 ? totalIncome / workDays : 0;
      // 平均時薪：總收入 / 總工時
      const totalWorkHours = (workDays * 8) + totalOT;
      const realAvgHourly = totalWorkHours > 0 ? totalIncome / totalWorkHours : 0;

      // 平均月薪：總收入 / 月份數
      const uniqueMonths = new Set(targetData.map(e => e.date.slice(0, 7))).size;
      const avgMonthly = uniqueMonths > 0 ? totalIncome / uniqueMonths : totalIncome;

      const setEl = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.textContent = val;
      };

      const fmt = (n) => Math.round(n).toLocaleString();

      setEl('statWorkDays', workDays);
      setEl('statTravelDays', travelDays);
      setEl('statWeekdayDays', weekdayDays);
      setEl('statWeekendDays', weekendDays);

      setEl('statAvgDaily', fmt(avgDaily));
      setEl('statAvgHourly', fmt(realAvgHourly));
      setEl('statAvgMonthly', fmt(avgMonthly));

      setEl('statTotalIncome', fmt(totalIncome));
      setEl('statThisMonthIncome', fmt(thisMonthIncome));
      setEl('statOTHours', totalOT.toFixed(1));
    }

    // Overview 頁面的匯率更新按鈕
    const refreshOverviewBtn = document.getElementById('refreshRateOverviewBtn');
    if (refreshOverviewBtn) {
      refreshOverviewBtn.addEventListener('click', async () => {
        refreshOverviewBtn.disabled = true;
        const icon = refreshOverviewBtn.querySelector('.material-symbols-outlined');
        if (icon) icon.style.animation = 'spin 1s linear infinite';

        try {
          if (typeof google !== 'undefined' && google.script && google.script.run) {
            google.script.run
              .withSuccessHandler((rate) => {
                document.getElementById('usdRate').value = rate.toFixed(2);
                updateAll();
                showNotification(`✅ 匯率已更新: 1 USD = ${rate.toFixed(2)} TWD`);
                refreshOverviewBtn.disabled = false;
                if (icon) icon.style.animation = '';
              })
              .withFailureHandler(() => {
                showNotification('❌ 匯率更新失敗，請檢查網路連線', true);
                refreshOverviewBtn.disabled = false;
                if (icon) icon.style.animation = '';
              })
              .getExchangeRate('USD', 'TWD');
          } else {
            showNotification('⚠️ 僅在 Apps Script 環境中可用', true);
            refreshOverviewBtn.disabled = false;
            if (icon) icon.style.animation = '';
          }
        } catch (err) {
          refreshOverviewBtn.disabled = false;
          if (icon) icon.style.animation = '';
        }
      });
    }

    // Ripple 效果函數
    function createRipple(event, button) {
      const ripple = document.createElement('span');
      ripple.classList.add('ripple');

      const rect = button.getBoundingClientRect();
      const size = Math.max(rect.width, rect.height);
      const x = event.clientX - rect.left - size / 2;
      const y = event.clientY - rect.top - size / 2;

      ripple.style.width = ripple.style.height = size + 'px';
      ripple.style.left = x + 'px';
      ripple.style.top = y + 'px';

      button.appendChild(ripple);

      setTimeout(() => ripple.remove(), 600);
    }

    // 暴露給全域
    window.updateCharts = updateCharts;
    window.updateAnalyticsStats = updateAnalyticsStats;
    window.populateMonthFilter = populateMonthFilter;
    window.initCharts = initCharts;

    // ========== Smart Stepper 拖曳互動 ==========
    let dragState = null;

    function initSmartStepperEvents() {
      const container = document.getElementById('tableContainer');
      if (!container) return;

      container.addEventListener('mousedown', (e) => {
        const stepper = e.target.closest('.smart-stepper');
        if (!stepper) return;

        e.preventDefault();
        const entryIndex = parseInt(stepper.dataset.entryIndex);
        const key = stepper.dataset.key;
        const entry = tableData[entryIndex];

        dragState = {
          stepper,
          entry,
          key,
          startY: e.clientY,
          lastY: e.clientY,
          accumulatedDelta: 0,
        };

        stepper.classList.add('active');
      });

      document.addEventListener('mousemove', (e) => {
        if (!dragState) return;

        e.preventDefault();
        const deltaY = dragState.lastY - e.clientY; // 上拉為正，下拉為負
        dragState.lastY = e.clientY;
        dragState.accumulatedDelta += deltaY;

        // 每移動30px觸發一次調整（0.5小時）
        const threshold = 30;
        if (Math.abs(dragState.accumulatedDelta) >= threshold) {
          const steps = Math.floor(Math.abs(dragState.accumulatedDelta) / threshold);
          const direction = dragState.accumulatedDelta > 0 ? 1 : -1;

          for (let i = 0; i < steps; i++) {
            adjustOTValue(dragState.entry, dragState.key, direction);
          }

          // 更新視覺
          dragState.stepper.textContent = dragState.entry[dragState.key].toFixed(1);
          if (dragState.entry[dragState.key] > 0) {
            dragState.stepper.classList.add('has-value');
          } else {
            dragState.stepper.classList.remove('has-value');
          }

          dragState.accumulatedDelta = dragState.accumulatedDelta % threshold;
        }
      });

      document.addEventListener('mouseup', () => {
        if (dragState) {
          dragState.stepper.classList.remove('active');
          dragState = null;
        }
      });

      // 觸控支援
      container.addEventListener('touchstart', (e) => {
        const stepper = e.target.closest('.smart-stepper');
        if (!stepper) return;

        const touch = e.touches[0];
        const entryIndex = parseInt(stepper.dataset.entryIndex);
        const key = stepper.dataset.key;
        const entry = tableData[entryIndex];

        dragState = {
          stepper,
          entry,
          key,
          startY: touch.clientY,
          lastY: touch.clientY,
          accumulatedDelta: 0,
        };

        stepper.classList.add('active');
      });

      document.addEventListener('touchmove', (e) => {
        if (!dragState) return;

        e.preventDefault();
        const touch = e.touches[0];
        const deltaY = dragState.lastY - touch.clientY;
        dragState.lastY = touch.clientY;
        dragState.accumulatedDelta += deltaY;

        const threshold = 30;
        if (Math.abs(dragState.accumulatedDelta) >= threshold) {
          const steps = Math.floor(Math.abs(dragState.accumulatedDelta) / threshold);
          const direction = dragState.accumulatedDelta > 0 ? 1 : -1;

          for (let i = 0; i < steps; i++) {
            adjustOTValue(dragState.entry, dragState.key, direction);
          }

          dragState.stepper.textContent = dragState.entry[dragState.key].toFixed(1);
          if (dragState.entry[dragState.key] > 0) {
            dragState.stepper.classList.add('has-value');
          } else {
            dragState.stepper.classList.remove('has-value');
          }

          dragState.accumulatedDelta = dragState.accumulatedDelta % threshold;
        }
      }, { passive: false });

      document.addEventListener('touchend', () => {
        if (dragState) {
          dragState.stepper.classList.remove('active');
          dragState = null;
        }
      });
    }


    // ========== DOM 載入後初始化 ==========
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        initTabNavigation();
        populateMonthFilter();
        initCharts();
        updateCharts();
        updateAnalyticsStats();
        initSmartStepperEvents(); // 初始化拖曳事件
        initAddCardSteppers(); // 初始化新增卡片拖曳
        console.log('[OT] 升級功能已載入 ✅');
      }, 800);
    });
  })(typeof globalThis !== 'undefined' ? globalThis : this);
</script>