<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>OT calculation</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&family=Outfit:wght@300;400;500;600;700;800&display=swap" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script id="init-payload" type="application/json"><?!= INIT_DATA_JSON || '{"data":[]}' ?></script>
  <script>
    // 版本標籤（防止本地環境報錯）
    window.__CW_DEPLOY_TAG = "<?= DEPLOY_TAG ?>";
    if (window.__CW_DEPLOY_TAG && window.__CW_DEPLOY_TAG.startsWith("<" + "?")) window.__CW_DEPLOY_TAG = "LOCAL_DEV";

    // 接收來自 Google Apps Script 定向注入的資料
    // 使用 try-catch 或字串檢查來防止非 GAS 環境下的語法錯誤
    (function () {
      try {
        const rawData = `<?!= typeof INIT_DATA_JSON !== 'undefined' ? INIT_DATA_JSON : 'null' ?>`;
        if (rawData && !rawData.startsWith('<' + '?')) {
          window.__OT_INIT_DATA__ = JSON.parse(rawData);
        } else {
          window.__OT_INIT_DATA__ = null;
        }
      } catch (e) {
        console.warn('[OT] Failed to parse GAS INIT_DATA:', e);
        window.__OT_INIT_DATA__ = null;
      }
    })();

    window.__OT_INIT_PAYLOAD__ = window.__OT_INIT_DATA__ || null;
  </script>
  <style>
    /* =========================================
       Aero Glass Design System
       ========================================= */
    :root {
      /* Vibrant Color Palette */
      --color-primary-rgb: 0, 122, 255;
      --color-primary: #007AFF;
      --color-primary-dark: #0056b3;
      --color-accent-rgb: 139, 92, 246;
      --color-accent: #8b5cf6;
      --color-success: #34C759;
      --color-warning: #FF9500;
      --color-danger: #FF3B30;

      /* Glassmorphism Refined Tokens */
      --glass-bg: rgba(255, 255, 255, 0.65);
      --glass-bg-accent: rgba(255, 255, 255, 0.3);
      --glass-border: rgba(255, 255, 255, 0.45);
      --glass-blur: 24px;
      --glass-shadow: 0 12px 40px rgba(0, 0, 0, 0.06);
      --glass-noise: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");

      /* Surface Colors */
      --surface-bg: #f5f7fa;
      --text-primary: #1d1d1f;
      --text-secondary: #6e6e73;
      --text-tertiary: #86868b;

      /* Elevations */
      --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.12);

      /* Typography */
      --font-main: 'Outfit', -apple-system, system-ui, sans-serif;

      /* Standardized Card Tokens */
      --card-radius: 20px;
      --card-padding: 20px;

      /* Motion */
      --ease-swift: cubic-bezier(0.4, 0, 0.2, 1);
      --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
      --duration-fast: 0.2s;
      --duration-normal: 0.3s;
      --duration-slow: 0.5s;
    }

    body.privacy-mode .privacy-hidden {
      filter: blur(12px) !important;
      opacity: 0.5;
      pointer-events: none !important;
      user-select: none !important;
    }

    /* Dark Mode Tokens (Future Proofing) */
    @media (prefers-color-scheme: dark) {
      :root {
        --glass-bg: rgba(28, 28, 30, 0.8);
        --glass-bg-accent: rgba(255, 255, 255, 0.1);
        --glass-border: rgba(255, 255, 255, 0.1);
        --surface-bg: #000000;
        --text-primary: #f5f5f7;
        --text-secondary: #86868b;
        --text-tertiary: #48484a;
        --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
      }
    }

    /* Neumorphism (Kept for compatibility but prioritized Aero) */
    :root[data-theme="neumorphic"] {
      --neumo-bg: #E0E5EC;
      --neumo-light: #ffffff;
      --neumo-shadow: #b8bec7;
      --neumo-text: #202731;
      --neumo-brand: #6366F1;
      --neumo-raised: 8px 8px 16px var(--neumo-shadow), -8px -8px 16px var(--neumo-light);
      --neumo-pressed: inset 2px 2px 5px var(--neumo-shadow), inset -2px -2px 5px var(--neumo-light);

      background-color: var(--neumo-bg) !important;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      font-family: var(--font-main);
    }

    [data-theme="neumorphic"] body {
      background: var(--neumo-bg) !important;
      background-color: var(--neumo-bg) !important;
      color: var(--neumo-text) !important;
      font-family: 'Quicksand', -apple-system, sans-serif !important;
    }

    [data-theme="neumorphic"] button,
    [data-theme="neumorphic"] .icon-button,
    [data-theme="neumorphic"] .file-label,
    [data-theme="neumorphic"] .promo-action-btn,
    [data-theme="neumorphic"] .ot-btn,
    [data-theme="neumorphic"] .multiplier-badge.green,
    [data-theme="neumorphic"] .circular-toggle-btn,
    [data-theme="neumorphic"] .smart-stepper,
    [data-theme="neumorphic"] .smart-stepper-add,
    [data-theme="neumorphic"] .tab-btn {
      background: var(--neumo-bg) !important;
      border: none !important;
      box-shadow: var(--neumo-raised) !important;
      color: var(--neumo-text) !important;
      transition: all 0.2s ease !important;
      user-select: none !important;
      -webkit-user-select: none !important;
      -webkit-tap-highlight-color: transparent !important;
    }

    [data-theme="neumorphic"] .card,
    [data-theme="neumorphic"] .add-card,
    [data-theme="neumorphic"] .add-card-circular,
    [data-theme="neumorphic"] .data-card,
    [data-theme="neumorphic"] .rule-card,
    [data-theme="neumorphic"] .modal-content,
    [data-theme="neumorphic"] .history-promo-card,
    [data-theme="neumorphic"] .toolbox-card,
    [data-theme="neumorphic"] .stat-column-card,
    [data-theme="neumorphic"] .chart-card {
      background: var(--neumo-bg) !important;
      border: none !important;
      box-shadow: var(--neumo-raised) !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      border-radius: 24px !important;
    }

    [data-theme="neumorphic"] .expand-wrapper:not(.open) {
      overflow: hidden !important;
      grid-template-rows: 0fr !important;
      margin-bottom: 0 !important;
    }

    [data-theme="neumorphic"] .expand-wrapper {
      overflow: visible;
      /* Override to allow shadows when OPEN */
      transition: grid-template-rows 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    [data-theme="neumorphic"] .expand-wrapper.open {
      margin-bottom: 12px;
    }

    /* Fixed Neumorphic Inset Shadow */
    [data-theme="neumorphic"] .neumo-inset {
      box-shadow: var(--neumo-inset) !important;
    }

    /* Fix shadow clipping */
    [data-theme="neumorphic"] .expand-inner {
      padding: 16px 20px !important;
      overflow: visible !important;
    }

    [data-theme="neumorphic"] .calendar-weekday-label {
      background: var(--neumo-bg) !important;
      box-shadow: var(--neumo-inset) !important;
      border: none !important;
      color: var(--neumo-text) !important;
      opacity: 0.8;
      font-weight: 600;
      border-radius: 8px;
      margin: 2px;
    }

    [data-theme="neumorphic"] .scoreboard-badge {
      background: var(--neumo-bg) !important;
      box-shadow: var(--neumo-raised) !important;
      border: 2px solid rgba(255, 255, 255, 0.4) !important;
      color: var(--neumo-text) !important;
    }

    [data-theme="neumorphic"] button.active,
    [data-theme="neumorphic"] .icon-button.active,
    [data-theme="neumorphic"] .smart-stepper.active {
      box-shadow: var(--neumo-pressed) !important;
      color: var(--neumo-brand) !important;
    }

    [data-theme="neumorphic"] button:active,
    [data-theme="neumorphic"] .icon-button:active,
    [data-theme="neumorphic"] .promo-action-btn:active,
    [data-theme="neumorphic"] .ot-btn:active,
    [data-theme="neumorphic"] .multiplier-badge.green:active {
      box-shadow: var(--neumo-pressed) !important;
      transform: translateY(1px);
    }

    [data-theme="neumorphic"] .save-btn:hover,
    [data-theme="neumorphic"] #saveToSheetBtn:hover,
    [data-theme="neumorphic"] .file-label:hover {
      box-shadow: var(--neumo-inset) !important;
    }

    [data-theme="neumorphic"] input,
    [data-theme="neumorphic"] select,
    [data-theme="neumorphic"] textarea,
    [data-theme="neumorphic"] .smart-stepper.active,
    [data-theme="neumorphic"] .capsule-popup {
      background: var(--neumo-bg) !important;
      box-shadow: var(--neumo-inset) !important;
      border: none !important;
      color: var(--neumo-text) !important;
    }

    [data-theme="neumorphic"] .info-chip,
    [data-theme="neumorphic"] .capsule {
      background: var(--neumo-bg) !important;
      box-shadow: var(--neumo-raised) !important;
      border: none !important;
      color: var(--neumo-text) !important;
    }

    [data-theme="neumorphic"] .tab-btn.active {
      box-shadow: var(--neumo-pressed) !important;
      background: var(--neumo-bg) !important;
      color: var(--neumo-brand) !important;
    }

    [data-theme="neumorphic"] .month-header {
      background: var(--neumo-bg) !important;
      box-shadow: var(--neumo-raised) !important;
      margin-bottom: 12px;
      border-radius: 16px;
      color: var(--neumo-text) !important;
    }

    html,
    body {
      max-width: 100%;
      overflow-x: hidden;
      margin: 0;
      /* iOS Viewport Fix */
      height: 100%;
      height: -webkit-fill-available;
    }

    /* 防止 iOS 自動放大輸入框 */
    input,
    select,
    textarea {
      font-size: 16px !important;
    }

    /* iOS 捲動優化 */
    .modal-body,
    .data-list-container,
    .analytics-scroll-container {
      -webkit-overflow-scrolling: touch;
    }

    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in-up {
      animation: fadeInUp var(--duration-normal) var(--ease-swift) both;
    }

    /* Base Styles */
    body {
      font-family: var(--font-main);
      background: var(--surface-bg);
      background-attachment: fixed;
      padding: 0;
      margin: 0;
      max-width: 100%;
      overflow-x: hidden;
      color: var(--text-primary);
      position: relative;
    }

    /* Mesh Gradient Background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background:
        radial-gradient(at 0% 0%, rgba(0, 122, 255, 0.1) 0%, transparent 50%),
        radial-gradient(at 100% 0%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
        radial-gradient(at 50% 100%, rgba(52, 199, 89, 0.1) 0%, transparent 50%);
      filter: blur(80px);
      animation: meshMovement 20s ease-in-out infinite alternate;
    }

    @keyframes meshMovement {
      0% {
        transform: scale(1) translate(0, 0);
      }

      100% {
        transform: scale(1.1) translate(20px, 20px);
      }
    }

    /* Aero Glass Navigation Bar */
    .tab-navigation {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 8px;
      height: 64px;
      align-items: center;
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      background: var(--glass-bg);
      border-bottom: 1px solid var(--glass-border);
      position: sticky;
      top: 0;
      z-index: 1000;
      width: 100%;
      margin-bottom: 32px;
      box-shadow: var(--glass-shadow);
    }

    .tab-btn {
      position: relative;
      flex: 1;
      max-width: 120px;
      height: 48px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      padding: 4px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 0.75rem;
      cursor: pointer;
      border-radius: 12px;
      transition: all var(--duration-normal) var(--ease-swift);
    }

    .tab-btn .material-symbols-outlined {
      font-size: 22px;
      transition: all 0.3s var(--ease-spring);
    }

    .tab-btn.active {
      color: var(--color-primary);
      background: rgba(var(--color-primary-rgb), 0.1);
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      height: 3px;
      background: var(--color-primary);
      border-radius: 3px 3px 0 0;
    }

    .tab-btn:hover:not(.active) {
      background: var(--glass-bg-accent);
      color: var(--text-primary);
    }

    /* Tab 內容區塊 */
    .tab-content {
      display: none;
      padding-top: 0px;
    }

    .tab-content.active {
      display: block;
      animation: fadeInUp 0.5s var(--ease-swift);
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .container {
      display: flex;
      flex-direction: column;
      gap: 32px;
      width: 100%;
      max-width: 1440px;
      margin: 0 auto;
      padding: 0 24px 100px 24px;
    }

    @media (min-width: 1024px) {
      .container {
        flex-direction: row;
        align-items: flex-start;
      }
    }

    /* Layout Panels */
    .left-panel {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
    }

    @media (min-width: 1024px) {
      .left-panel {
        position: sticky;
        top: 100px;
        max-width: 320px;
        flex-shrink: 0;
      }
    }

    .right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 24px;
      width: 100%;
      min-width: 0;
    }

    .expand-wrapper {
      display: grid;
      grid-template-rows: 0fr;
      transition: grid-template-rows 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      min-height: 0;
    }

    .expand-wrapper:not(.open) {
      grid-template-rows: 0fr !important;
      margin-bottom: 0 !important;
      padding-top: 0 !important;
      padding-bottom: 0 !important;
      visibility: hidden;
      pointer-events: none;
    }

    .expand-wrapper.open {
      grid-template-rows: 1fr;
      visibility: visible;
      pointer-events: auto;
    }

    .expand-inner {
      min-height: 0;
      overflow: hidden;
      color: var(--text-primary);
      /* Fix: Use theme variable for visibility */
    }

    /* Month Group Styles */
    .month-group {
      width: 100%;
      display: grid;
      grid-template-rows: 0fr;
      transition: grid-template-rows var(--duration-normal) var(--ease-swift);
      overflow: hidden;
    }

    .month-group.open {
      grid-template-rows: 1fr;
    }

    .month-group .expand-inner {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      padding: 4px 0;
      /* Keep vertical padding, zero side */
      min-height: 0;
    }

    @media (min-width: 1024px) {
      .month-group {
        grid-column: 1 / -1;
      }

      .month-group .expand-inner {
        display: grid !important;
        grid-template-columns: repeat(7, 1fr) !important;
        grid-auto-flow: row !important;
        gap: 12px;
        padding: 12px 0;
      }
    }


    /* 卡片樣式 (Unified Fluid Glass) */
    /* Aero Glass Card System */
    .card {
      width: 100%;
      padding: var(--card-padding);
      border-radius: var(--card-radius);
      background: var(--glass-bg);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--glass-border);
      box-sizing: border-box;
      transition: all var(--duration-normal) var(--ease-swift);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: var(--glass-noise);
      opacity: 0.03;
      pointer-events: none;
    }

    .card:hover {
      transform: translateY(-6px);
      box-shadow: var(--shadow-lg);
      border-color: rgba(var(--color-primary-rgb), 0.3);
    }

    .card h3 {
      margin-top: 0;
      margin-bottom: 20px;
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--text-primary);
      text-align: left;
    }

    /* Aero Glass Widgets */
    .dashboard-widgets-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 12px;
      margin-top: 12px;
      width: 100%;
    }

    .stat-widget {
      padding: 14px;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
      background: rgba(var(--color-primary-rgb), 0.04);
      transition: all var(--duration-normal) var(--ease-spring);
      border: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
      min-width: 0;
      /* Fix overflow */
    }

    .stat-widget::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: var(--glass-noise);
      opacity: 0.03;
      pointer-events: none;
    }

    .stat-widget:hover {
      transform: translateY(-4px);
      background: rgba(var(--color-primary-rgb), 0.08);
      border-color: rgba(var(--color-primary-rgb), 0.1);
    }

    .stat-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 10px;
      box-shadow: var(--shadow-sm);
    }

    .stat-icon .material-symbols-outlined {
      font-size: 20px;
    }

    .stat-info {
      display: flex;
      flex-direction: column;
    }

    .stat-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .stat-value {
      font-size: 1.15rem;
      font-weight: 800;
      color: var(--text-primary);
    }

    .stat-sparkline {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 30px;
      pointer-events: none;
      opacity: 0.6;
    }

    /* Staggered Animations */
    .stagger-1 {
      animation-delay: 0.1s;
    }

    .stagger-2 {
      animation-delay: 0.2s;
    }

    .stagger-3 {
      animation-delay: 0.3s;
    }

    .stagger-4 {
      animation-delay: 0.4s;
    }

    .fade-in-up {
      opacity: 0;
      animation: fadeInUp 0.6s var(--ease-swift) forwards;
    }

    /* Header Styles */
    .header-row {
      padding: 8px 24px 0 24px;
      margin-bottom: 0;
    }

    .header-combined-card {
      display: flex !important;
      align-items: center;
      justify-content: space-between;
      padding: 8px 16px !important;
      width: 100%;
      cursor: default;
      margin-bottom: 0;
    }

    .logo-container {
      display: flex;
      align-items: center;
      cursor: pointer;
      gap: 12px;
    }

    .logo-image {
      max-height: 32px;
      object-fit: contain;
    }

    /* Widget Variants */
    .stat-widget.success {
      background: rgba(52, 199, 89, 0.08);
    }

    .stat-widget.success .stat-icon {
      color: var(--color-success);
    }

    .stat-widget.warning {
      background: rgba(255, 149, 0, 0.08);
    }

    .stat-widget.warning .stat-icon {
      color: var(--color-warning);
    }

    .stat-widget.primary {
      background: rgba(0, 122, 255, 0.08);
    }

    .stat-widget.primary .stat-icon {
      color: var(--color-primary);
    }

    .stat-widget.accent {
      background: rgba(139, 92, 246, 0.08);
    }

    .stat-widget.accent .stat-icon {
      color: var(--color-accent);
    }

    .total-income-highlight {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
      padding: 24px;
      border-radius: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: white;
      box-shadow: 0 12px 32px rgba(var(--color-primary-rgb), 0.25);
      margin-top: 8px;
    }

    .highlight-label {
      font-size: 0.85rem;
      font-weight: 500;
      opacity: 0.9;
    }

    .highlight-value {
      font-size: 2rem;
      font-weight: 800;
      letter-spacing: -1px;
    }

    /* Floating Action Button */
    .fab {
      position: fixed;
      bottom: 32px;
      right: 32px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: var(--color-primary);
      color: white;
      border: none;
      box-shadow: 0 8px 32px rgba(0, 122, 255, 0.4);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      transition: all var(--duration-normal) var(--ease-spring);
    }

    .fab:hover {
      transform: scale(1.1) rotate(90deg);
      background: var(--color-primary-dark);
      box-shadow: 0 12px 48px rgba(0, 122, 255, 0.5);
    }

    .fab:active {
      transform: scale(0.9);
    }

    .fab .material-symbols-outlined {
      font-size: 32px;
    }

    /* Standard Buttons */
    button,
    .icon-button {
      width: auto;
      min-width: 44px;
      height: 44px;
      margin: 4px;
      padding: 0 20px;
      border-radius: 12px;
      border: 1px solid var(--glass-border);
      background: var(--glass-bg);
      color: var(--text-primary);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--duration-normal) var(--ease-spring);
      box-shadow: var(--shadow-sm);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-sizing: border-box;
      font-family: var(--font-main);
    }

    button:hover,
    .icon-button:hover {
      background: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    button.primary,
    #saveToSheetBtn {
      background: var(--color-primary) !important;
      color: white !important;
      border: none !important;
      box-shadow: 0 8px 20px rgba(var(--color-primary-rgb), 0.3);
    }

    button.primary:hover,
    #saveToSheetBtn:hover {
      background: var(--color-primary-dark) !important;
      transform: translateY(-3px);
      box-shadow: 0 12px 28px rgba(var(--color-primary-rgb), 0.4);
    }

    .icon-button {
      width: 44px;
      height: 44px;
      padding: 0;
      border-radius: 12px;
    }

    .material-symbols-outlined {
      pointer-events: none;
      margin: 0;
      padding: 0;
    }

    /* Ensure all MD3 symbols in dashboard/chips are centered */
    .info-chip .material-symbols-outlined,
    .capsule-row .material-symbols-outlined {
      display: flex;
      align-items: center;
      justify-content: center;
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }

    .icon-button.privacy-btn.active {
      background: linear-gradient(135deg, #FF3B30, #FF2D55) !important;
      box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
    }

    button:active,
    .icon-button:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }

    /* OT 上下箭頭：覆蓋一般按鈕樣式，縮小並貼在膠囊左右 */
    .ot-btns {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-left: 6px;
    }

    .ot-btn {
      width: 20px;
      height: 20px;
      font-size: 14px;
      padding: 0;
      background: rgba(255, 255, 255, 0.3);
      color: #333;
      box-shadow: none;
      border: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ot-btn:hover {
      background: rgba(255, 255, 255, 0.8);
      box-shadow: none;
      transform: translateY(-1px);
    }

    /* 隱藏原生數字增減按鈕 */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* 輸入設定卡片內的數字輸入框 */
    .settings-card input[type="number"],
    .settings-card input[type="text"],
    .settings-card select {
      width: 100%;
      box-sizing: border-box;
      margin: 4px 0 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.45);
      background: rgba(255, 255, 255, 0.6);
      outline: none;
      color: #111;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    .settings-card input:focus,
    .settings-card select:focus {
      background: #fff;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
    }

    .settings-card label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #555;
      margin-bottom: 4px;
      display: block;
    }

    /* 設定區按鈕排列 */
    .settings-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      padding: 4px;
    }

    .actions-card {
      margin-top: 0;
      /* Align with standard gap */
      padding: 16px;
      display: flex;
      justify-content: center;
    }

    /* 設定卡片內的 icon 按鈕，縮成小圓形 */
    .settings-card .icon-button {
      width: 44px;
      height: 44px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .file-label {
      cursor: pointer;
    }

    input[type="file"] {
      display: none;
    }

    /* 右側區域 */
    .right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: visible;
      width: 100%;
    }


    /* 新增卡片 - Smart Stepper 統一設計 */
    .add-card-circular {
      display: flex !important;
      flex-direction: row !important;
      flex-wrap: nowrap !important;
      /* Keep everything on one line for the slide-out effect */
      align-items: center !important;
      justify-content: flex-start !important;
      /* Align to start for natural sliding */
      gap: 12px !important;
      margin-bottom: 24px;
      position: relative;
      /* Remove sticky if it was causing issues, or keep it */
      background: rgba(255, 255, 255, 0.65);
      padding: 4px 16px;
      border-radius: 999px;
      z-index: 100;
      /* High enough to be over table but allow popups */
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      box-shadow: var(--glass-shadow);
      border: var(--glass-border);
      width: 100%;
      box-sizing: border-box;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      overflow: visible !important;
      /* Never clip popups */
    }

    /* Handle transition to rounded rectangle when expanded */
    .add-card-circular:has(.expandable-wrapper.expanded) {
      border-radius: 24px;
      padding: 12px 16px;
    }

    .add-card-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      min-width: 0;
    }

    .add-card-item label {
      font-size: 0.7rem;
      font-weight: 600;
      color: #8e8e93;
      text-align: center;
      white-space: nowrap;
    }

    /* Smart Stepper for Add Card (Override Global Button Styles) */
    .smart-stepper-add {
      width: 44px !important;
      height: 44px !important;
      border-radius: 50% !important;
      border: 2px solid rgba(0, 0, 0, 0.08) !important;
      background: rgba(255, 255, 255, 0.95) !important;
      color: #1d1d1f !important;

      /* Flex Alignment */
      display: flex !important;
      align-items: center;
      justify-content: center;

      font-size: 0.8rem;
      font-weight: 700;
      outline: none;
      cursor: ns-resize;
      transition: all 0.2s ease;
      padding: 0 !important;
      user-select: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      margin: 0 !important;
    }

    .circular-toggle-btn:hover {
      transform: scale(1.1);
      background: rgba(0, 0, 0, 0.08) !important;
    }

    .circular-toggle-btn:active {
      transform: scale(0.9);
    }

    .month-group {
      overflow: hidden;
    }

    .smart-stepper-add:hover {
      background: rgba(255, 255, 255, 1) !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
      transform: translateY(-1px);
    }

    .smart-stepper-add.active {
      background: var(--color-primary) !important;
      color: white !important;
      border-color: transparent !important;
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3) !important;
      cursor: grabbing;
    }

    .smart-stepper-add.has-value {
      background: rgba(255, 255, 255, 1) !important;
      border-color: rgba(0, 122, 255, 0.3) !important;
    }

    .smart-stepper-add[data-type="date"] {
      border-color: rgba(0, 122, 255, 0.2) !important;
    }

    .smart-stepper-add[data-type="travel"] {
      border-color: rgba(255, 149, 0, 0.2) !important;
      color: var(--color-warning) !important;
    }

    /* 圓形新增按鈕（與其他按鈕同列） */
    .circular-add-btn-round {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, var(--color-primary) 0%, #5AC8FA 100%);
      color: #ffffff !important;
      /* Force white for primary action button */
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
      flex-shrink: 0;
      margin: 0;
    }

    .circular-add-btn-round:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
    }

    .circular-add-btn-round:active {
      transform: scale(0.95);
    }


    .card-date {
      font: var(--md-sys-typescale-title-medium);
      font-size: 1.1rem;
      color: #1d1d1f !important;
      /* Force dark visibility */
      font-weight: 600;
    }

    /* Scoreboard Badge */
    /* Scoreboard Badge */
    .scoreboard-badge {
      background: #000000;
      color: #ffffff;
      padding: 2px 6px;
      /* Reduced padding */
      border-radius: 999px;
      font-family: 'Inter', monospace;
      font-weight: 700;
      font-size: 0.9rem;
      min-width: 24px;
      /* Reduced width */
      height: 24px;
      /* Fixed height for circle look */
      text-align: center;
      display: inline-flex;
      /* Use inline-flex */
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      line-height: 1;
    }

    /* Scoreboard Colors */
    .scoreboard-badge.green {
      color: #4ade80;
    }

    /* 2 */
    .scoreboard-badge.yellow {
      color: #facc15;
    }

    /* 3 */
    .scoreboard-badge.orange {
      color: #fb923c;
    }

    /* 4 */
    .scoreboard-badge.red {
      color: #f87171;
    }

    /* 5 */
    .scoreboard-badge.purple {
      color: #c084fc;
    }

    /* >6 */

    .card-secondary-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-secondary);
      background: var(--glass-bg-accent);
      padding: 4px 12px;
      border-radius: 12px;
      border: 1px solid var(--glass-border);
      white-space: nowrap;
      transition: all var(--duration-fast) var(--ease-swift);
    }

    .info-chip:hover {
      background: var(--glass-bg);
      transform: translateY(-1px);
    }

    .info-chip.travel-chip.active {
      background: rgba(var(--color-primary-rgb), 0.1);
      color: var(--color-primary);
      border-color: rgba(var(--color-primary-rgb), 0.3);
    }

    .info-chip.yellow {
      background: rgba(255, 149, 0, 0.1);
      color: var(--color-warning);
      border-color: rgba(255, 149, 0, 0.3);
    }

    .info-chip .material-symbols-outlined {
      font-size: 16px;
    }

    .scoreboard-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      font-weight: 800;
      font-size: 1.1rem;
      background: var(--glass-bg-accent);
      border: 1px solid var(--glass-border);
      transition: transform var(--duration-normal) var(--ease-spring);
    }

    .scoreboard-badge:hover {
      transform: scale(1.1);
    }

    /* Scoreboard Coloring using primary/accent system */
    .scoreboard-badge.blue {
      color: var(--color-primary);
      background: rgba(0, 122, 255, 0.1);
    }

    .scoreboard-badge.emerald {
      color: var(--color-success);
      background: rgba(52, 199, 89, 0.1);
    }

    .scoreboard-badge.amber {
      color: var(--color-warning);
      background: rgba(255, 149, 0, 0.1);
    }

    .scoreboard-badge.crimson {
      color: var(--color-danger);
      background: rgba(255, 59, 48, 0.1);
    }

    .card-secondary-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .month-header {
      display: flex !important;
      justify-content: space-between;
      align-items: center;
      padding: 32px 0 12px 0;
      /* No side padding to align with grid edges */
      margin-top: 40px;
      margin-bottom: 20px;
      width: 100%;
      box-sizing: border-box;
      position: relative;
      z-index: 5;
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--text-primary);
      letter-spacing: -0.5px;
      grid-column: 1 / -1;
      border-bottom: 2px solid var(--color-primary);
    }

    .month-header>div {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Universal UI Fixes (Moved to top-level) */
    #saveToSheetBtn {
      background: #FF9500 !important;
      /* Force solid orange over gradients */
      color: white !important;
      border: none !important;
      box-shadow: 0 4px 12px rgba(255, 149, 0, 0.3);
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      position: relative;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    #saveToSheetBtn:hover {
      background: #FFA500 !important;
      transform: translateY(-2px);
    }

    #saveToSheetBtn.loading {
      background: #FF9500 !important;
      opacity: 0.9;
    }

    /* ... progress text and grid levels below ... */
    .progress-text {
      font-size: 14px;
      font-weight: 800;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      display: none;
      color: white;
    }

    #saveToSheetBtn.loading .material-symbols-outlined {
      display: none;
    }

    #saveToSheetBtn.loading .progress-text {
      display: block;
    }

    .contribution-grid {
      display: flex !important;
      flex-direction: row !important;
      gap: 2px;
      padding: 4px;
      background: rgba(255, 255, 255, 0.5) !important;
      border-radius: 6px;
      width: fit-content;
      max-width: 100%;
      overflow-x: auto !important;
      -webkit-overflow-scrolling: touch;
      z-index: 20 !important;
      display: flex !important;
      /* Force show on mobile */
    }

    .contribution-grid::-webkit-scrollbar {
      height: 2px;
    }

    .contribution-grid::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 2px;
    }

    .grid-cell {
      position: relative;
      width: 10px !important;
      height: 10px !important;
      min-width: 10px;
      min-height: 10px;
      border-radius: 2px;
      background: #e0e0e0;
      /* Default empty */
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-sizing: border-box;
    }

    /* Mobile: Shrink calendar to prevent overflow */
    .grid-cell {
      position: relative;
      width: 7px !important;
      height: 7px !important;
      min-width: 7px;
      min-height: 7px;
    }

    /* Ensure amount chips are fully visible on mobile */
    .card-secondary-info {
      flex-wrap: nowrap !important;
      justify-content: flex-end;
      gap: 4px;
    }

    .info-chip {
      flex-shrink: 0;
      white-space: nowrap;
    }

    .grid-cell:hover {
      transform: scale(1.4);
      z-index: 30;
    }

    /* Card Date Wrapper */
    .card-date-wrapper {
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .date-day {
      font-weight: 700;
      font-size: 1.2rem;
      color: #1d1d1f !important;
    }

    .date-weekday {
      font-size: 0.9rem;
      color: #1d1d1f !important;
      /* Nuclear Fix: Forced dark color */
      font-weight: 600;
      text-transform: uppercase;
      opacity: 0.8;
    }

    /* Grid Layout for Hours */
    /* Container Reset */
    #tableContainer {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 0;
      width: 100%;
      max-width: 100%;
      /* Fill available space */
      margin: 0;
      /* Left align */
      box-sizing: border-box;
    }

    /* Weekday Header (Desktop Only) - Strict Alignment */
    .calendar-header {
      display: none;
      grid-template-columns: repeat(7, 1fr);
      gap: 12px;
      margin: 0 0 8px 0;
      /* Left align, no bottom margin */
      padding: 0;
      width: 100%;
      box-sizing: border-box;
    }

    .calendar-weekday-label {
      text-align: center;
      font: var(--md-sys-typescale-label-large);
      color: #1d1d1f !important;
      /* Force dark readability */
      text-transform: uppercase;
      font-weight: 700;
      opacity: 0.9;
    }

    /* =========================================
       Data Card Component (Aero Glass)
       ========================================= */
    .data-card {
      background: var(--glass-bg);
      backdrop-filter: blur(var(--glass-blur)) saturate(180%);
      -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(180%);
      border-radius: var(--card-radius);
      box-shadow: var(--shadow-sm);
      padding: 0;
      overflow: hidden;
      transition: all var(--duration-normal) var(--ease-spring);
      position: relative;
      border: 1px solid var(--glass-border);
      display: flex;
      flex-direction: column;
    }

    .data-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: var(--glass-noise);
      opacity: 0.02;
      pointer-events: none;
    }

    .data-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: var(--shadow-lg);
      z-index: 10;
      border-color: var(--color-primary);
      background: white;
    }

    .data-card:active {
      transform: translateY(0);
      transition-duration: 0.1s;
    }

    /* Card Header (Always Visible) */
    .card-header {
      padding: 8px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      background: transparent;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 56px;
    }

    .card-primary-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    /* Desktop Adaptation */
    @media (min-width: 1024px) {
      #tableContainer {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        grid-auto-flow: row;
        gap: 12px;
        max-width: 100%;
        /* Full width */
        padding: 0;
        margin: 0;
      }

      .calendar-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 12px;
        max-width: 100%;
        padding: 0;
        margin: 0 0 12px 0;
      }

      .data-card {
        height: auto;
        min-height: 0;
      }
    }

    /* Toggle Buttons (Daily Cards) */
    .circular-toggle-btn.leave.active {
      background: rgba(186, 26, 26, 0.15) !important;
    }

    .circular-toggle-btn.leave.active span {
      color: #ba1a1a !important;
    }

    /* Grid Layout for Hours - Mobile Default: 4 columns (Single Row) */
    .hours-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      /* 4 columns on mobile */
      gap: 8px;
      margin-bottom: 12px;
      justify-items: center;
      width: 100%;
    }

    .hour-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      /* background: var(--md-sys-color-surface-container); Removed container bg for cleaner look with circles */
      padding: 4px;
      border-radius: 12px;
      width: 100%;
    }

    .hour-label {
      font: var(--md-sys-typescale-body-small);
      color: var(--md-sys-color-on-surface-variant);
      font-size: 0.7rem;
    }

    /* Circular Smart Stepper */
    .hour-item .smart-stepper {
      width: 44px;
      /* Fixed size */
      height: 44px;
      border-radius: 50%;
      /* Circle */
      font-size: 0.9rem;
      padding: 0;
      /* Reset padding */
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      background: #ffffff;
      /* Solid white for contrast */
    }

    /* Travel Toggle Row (Mobile) */
    .travel-toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px dashed var(--md-sys-color-outline-variant);
    }

    /* Footer Actions */
    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed var(--md-sys-color-outline-variant);
    }

    .remark-text {
      font: var(--md-sys-typescale-body-medium);
      color: var(--md-sys-color-on-surface-variant);
      font-style: italic;
    }

    .card-actions {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      color: var(--md-sys-color-on-surface-variant);
      cursor: pointer;
      transition: background 0.2s;
    }

    .action-btn:hover {
      background: var(--md-sys-color-surface-container);
      color: var(--md-sys-color-on-surface);
    }

    .action-btn.delete {
      color: #ba1a1a;
    }

    .action-btn.delete:hover {
      background: #ffdad6;
      color: #410002;
    }

    /* Desktop Adaptation (Calendar View) */
    @media (min-width: 1024px) {
      #tableContainer {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        /* Sun - Sat */
        grid-auto-flow: row;
        /* Fix staircase effect */
        gap: 12px;
        max-width: 1400px;
        /* Wider for calendar */
        padding: 0 16px;
        /* Ensure padding matches header */
      }

      .calendar-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        /* Sun - Sat */
        gap: 12px;
        max-width: 1400px;
        margin: 0 auto 12px auto;
        padding: 0 16px;
        /* Match container padding */
      }

      /* Month Header Spanning */
      /* Removed redundant mobile-trapped header definition */

      .data-card {
        min-width: 0;
        /* Allow shrinking */
        display: flex;
        flex-direction: column;
        height: 100%;
        /* Uniform height */
      }

      /* Desktop Steppers: 2x2 */
      .hours-grid {
        grid-template-columns: repeat(2, 1fr);
        max-width: 120px;
        /* Constrain width */
        margin: 0 auto 12px auto;
      }

      /* Hide Weekday in Date on Desktop */
      .date-weekday {
        display: none;
      }

      /* Desktop Card Layout Override */
      .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .card-primary-info {
        width: 100%;
        justify-content: space-between;
      }

      .card-secondary-info {
        width: 100%;
        justify-content: space-between;
        flex-wrap: wrap;
      }

      .card-expand-icon {
        display: none;
        /* Hide expand icon on desktop if we want cleaner look, or keep it */
      }

      /* Force Card Body to be Vertical Flex on Desktop (Override Grid Inheritance) */
      .card-body.expand-inner {
        display: flex !important;
        flex-direction: column !important;
        grid-template-columns: none !important;
        height: auto !important;
        padding: 4px 0 !important;
        /* Reduced padding */
        gap: 4px !important;
        /* Reduced gap */
      }

      /* Fix Layout for Content in Desktop Narrow Columns */
      .travel-toggle-row,
      .card-footer {
        display: flex;
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 4px !important;
        margin: 0 !important;
        width: 100%;
      }

      .remark-text {
        width: 100%;
        white-space: normal;
      }

      .card-actions {
        width: 100%;
        display: flex;
        justify-content: flex-end;
      }
    }

    /* 膠囊樣式 */
    .capsule {
      padding: 4px 10px;
      border-radius: 999px;
      margin: 2px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      border: 1px solid rgba(255, 255, 255, 0.35);
      backdrop-filter: blur(14px) saturate(140%);
      -webkit-backdrop-filter: blur(14px) saturate(140%);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }

    .capsule.green {
      background: linear-gradient(135deg,
          rgba(160, 231, 160, 0.9),
          rgba(160, 231, 160, 0.6));
      color: #0f2a0f;
      border-color: rgba(160, 231, 160, 0.9);
    }

    .capsule.orange {
      background: linear-gradient(135deg,
          rgba(255, 200, 124, 0.9),
          rgba(255, 200, 124, 0.6));
      color: #4a2c07;
      border-color: rgba(255, 200, 124, 0.9);
    }

    .capsule.gray {
      background: linear-gradient(135deg,
          rgba(224, 224, 224, 0.9),
          rgba(224, 224, 224, 0.5));
      color: #111;
      border-color: rgba(224, 224, 224, 0.9);
    }

    /* OT 與總計字體加粗 */
    .ot-value {
      font-weight: bold;
      font-size: 1rem;
    }

    .total-value {
      font-weight: bold;
      font-size: 1rem;
    }

    /* Dashboard 專用數值膠囊 */
    .dashboard-value {
      font-weight: 800;
      /* Bolder */
      font-size: 1.1rem;
      /* Slightly larger */
      display: inline-block;
      transform-origin: center bottom;
      color: #1d1d1f !important;
      /* Force dark visibility */
    }

    /* 子列（Base / Travel / OT Salary 細節區） */
    .detail-row {
      background: transparent;
    }

    .detail-row>td {
      padding: 0 !important;
      border-bottom: none;
      background: rgba(230, 230, 230, 0.95);
      width: 100%;
    }

    .detail-wrapper {
      display: none;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px 16px 12px;
      width: 100%;
      min-height: 50px;
      opacity: 0;
      transform: translateY(-4px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      justify-content: flex-start;
    }

    /* 展開狀態 - 增加優先級 */
    .detail-row.open .detail-wrapper,
    tr.detail-row.open .detail-wrapper {
      display: flex !important;
      opacity: 1 !important;
      transform: translateY(0) !important;
    }

    /* 讓 label 與膠囊改成左右排列 */
    .detail-chip {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 6px;
      min-width: 80px;
      flex-shrink: 0;
    }

    /* 子清單內 Travel 左側小 toggle */
    .travel-toggle-inline {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.45);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg,
          rgba(160, 160, 160, 0.95),
          rgba(120, 120, 120, 0.85));
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.18);
      padding: 0;
    }

    .travel-toggle-inline.on {
      background: linear-gradient(135deg,
          rgba(0, 122, 255, 0.95),
          rgba(0, 122, 255, 0.75));
    }

    .detail-label {
      font-size: 0.8rem;
      opacity: 1;
      margin-left: 0;
      color: #1d1d1f !important;
      /* Force dark readability */
    }

    /* Removed redundant header definition */

    /* 每列右側刪除小圓點與確認氣泡 */
    .row-delete-wrapper {
      position: absolute;
      top: 50%;
      right: 2px;
      /* 保持貼齊儲存格右側，避免被瀏覽器裁切 */
      left: auto;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      /* 由內部按鈕接收事件 */
      z-index: 15;
      /* 確保浮在列背景之上 */
    }


    .row-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      padding: 0;
      border: none;
      background: #b4b4b4;
      box-shadow: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: transparent;
      /* 隱藏原文字，改用 ::before 顯示 */
      pointer-events: auto;
    }

    .row-dot::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #6d6d6d;
      display: block;
    }

    .row-dot:hover {
      background: #e53935;
      transform: scale(3);
    }

    .row-dot:hover::before {
      content: '×';
      padding-left: 14px;
      width: auto;
      height: auto;
      background: transparent;
      color: #fff;
      font-size: 0.4rem;
      line-height: 1;
    }

    /* 刪除確認氣泡 */
    .delete-bubble {
      position: absolute;
      top: 50%;
      right: 26px;
      transform: translateY(-50%) translateX(8px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease, transform 0.18s ease;
      z-index: 20;
    }

    .delete-bubble.open {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(-50%) translateX(0);
    }

    .delete-bubble-content {
      background: rgba(0, 0, 0, 0.82);
      color: #fff;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 0.78rem;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
      white-space: nowrap;
    }

    .delete-bubble-content p {
      margin: 0 0 6px;
    }

    .delete-bubble-actions {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
    }

    .delete-bubble-actions .delete-confirm,
    .delete-bubble-actions .delete-cancel {
      padding: 2px 8px;
      border-radius: 999px;
      border: none;
      box-shadow: none;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .delete-bubble-actions .delete-confirm {
      background: #e53935;
      color: #fff;
    }

    .delete-bubble-actions .delete-cancel {
      background: rgba(255, 255, 255, 0.16);
      color: #fff;
    }

    .flip {
      animation: flip-card 0.4s ease;
    }

    @keyframes flip-card {
      0% {
        transform: rotateX(0deg);
        opacity: 1;
      }

      50% {
        transform: rotateX(90deg);
        opacity: 0.2;
      }

      100% {
        transform: rotateX(0deg);
        opacity: 1;
      }
    }

    /* 若 icon-button 被設定成正方形，統一視覺為圓形 */
    .icon-button[style*="width: 44px"],
    .icon-button[style*="height: 44px"] {
      border-radius: 999px;
    }

    /* 手機版響應式版面調整 */
    @media (max-width: 1024px) {
      body {
        padding: 8px 10px;
        /* 左右預留安全距離，且左右對稱 */
        font-size: 16px;
      }

      .container {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
      }

      .left-panel {
        position: static;
        width: 100%;
        gap: 10px;
      }

      .card,
      .logo-card {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        margin-bottom: 0;
      }

      /* Legacy Header Styles Removed */

      /* Privacy toggle in header */
      .toggle-btn-wrapper.privacy.active {
        color: #ba1a1a;
        background: rgba(186, 26, 26, 0.08);
      }

      .toggle-btn-wrapper:hover {
        transform: scale(1.02);
        background: rgba(255, 255, 255, 0.85);
      }

      .toggle-btn-wrapper:active {
        transform: scale(0.92);
        transition-duration: 0.1s;
      }

      .toggle-btn-wrapper .material-symbols-outlined {
        font-size: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }

      /* Styles promoted to top-level for universal visibility */

      /* Logo Card adjustments to fit in flex */
      .logo-card {
        flex: 1;
        margin-bottom: 0 !important;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .right-panel {
        width: 100%;
        flex: 1;
      }

      /* 手機版：避免內容超出螢幕寬度 */
      .container,
      .right-panel,
      table {
        max-width: 100%;
        box-sizing: border-box;
      }

      /* 新增卡片在手機版不固定在畫面頂部，跟著內容往下 */
      .add-card {
        position: static;
        top: auto;
        margin-top: 4px;
      }

      /* 手機版：新增列日期輸入欄縮短，避免擠壓其他欄位 */
      .add-card input[type="date"] {
        flex: 0 0 130px;
        max-width: 130px;
        width: 130px;
      }

      /* 手機版顯示「查看加班明細」按鈕 */
      /* Legacy .mobile-table-toggle width override removed */

      .mobile-table-toggle-label {
        font-size: 0.9rem;
      }

      /* 手機版表格更緊湊（僅套用在主 OT 表格） */
      #tableSection th,
      #tableSection td {
        padding: 6px 4px;
        font-size: 0.78rem;
      }

      .capsule {
        padding: 2px 6px;
        font-size: 0.78rem;
      }

      /* 手機版加班時數調整箭頭放大，點擊區域更友善 */
      .ot-arrow {
        font-size: 1.15rem;
        padding: 3px;
      }

      .ot-arrow .material-symbols-outlined {
        font-size: 1.6rem;
      }

      /* 手機版隱藏備註欄位（假設為最後一欄，限定主 OT 表格） */
      #tableSection thead th:last-child,
      #tableSection tbody td:last-child {
        display: none;
      }

      thead th {
        top: 0;
      }
    }

    /* 桌機版預設隱藏 mobile-table-toggle（上面 media query 會覆蓋） */
    /* 通知氣泡內文左右排版：標題靠左，數字靠右 */
    .ot-notify-bubble .notify-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      margin: 2px 0;
    }

    .ot-notify-bubble .notify-label {
      flex: 1;
      text-align: left;
      white-space: nowrap;
      font-size: 0.9em;
      opacity: 0.9;
    }

    .ot-notify-bubble .notify-value {
      text-align: right;
      font-size: 1em;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
      margin-left: 12px;
    }

    /* .mobile-table-toggle display: none removed to allow desktop visibility */

    /* ========== Analytics 頁面樣式 ========== */
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      padding: 0 20px;
    }

    .month-selector-card {
      grid-column: 1 / -1;
    }

    .month-picker {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
    }

    .month-picker select {
      flex: 1;
      padding: 10px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.45);
      background: rgba(207, 207, 207, 0.95);
      font-family: var(--font-system);
      font-size: 0.95rem;
      font-weight: 600;
      color: #111;
      outline: none;
      transition: all var(--duration-fast) var(--easing-standard);
    }

    .month-nav {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: var(--color-primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: var(--elevation-2);
    }

    .stats-cards-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      grid-column: 1 / -1;
    }

    /* Analytics Adaptive Grid */
    .stats-columns {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
      width: 100%;
    }

    .stat-column-card,
    .chart-card {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 24px;
      box-shadow: var(--elevation-1);
      border: 1px solid rgba(255, 255, 255, 0.5);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .stat-column-card:hover,
    .chart-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--elevation-2);
      background: rgba(255, 255, 255, 0.85);
    }

    .chart-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 16px;
      width: 100%;
    }

    .column-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .column-header h3 {
      margin: 0;
      font-size: 1.1rem;
      color: #333;
    }

    .icon-blue {
      color: #2196F3;
      background: #E3F2FD;
      padding: 8px;
      border-radius: 12px;
    }

    .icon-green {
      color: #4CAF50;
      background: #E8F5E9;
      padding: 8px;
      border-radius: 12px;
    }

    .icon-orange {
      color: #FF9800;
      background: #FFF3E0;
      padding: 8px;
      border-radius: 12px;
    }

    .stat-card {
      padding: 20px 16px;
      background: rgba(255, 255, 255, 0.16);
      backdrop-filter: blur(20px) saturate(160%);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: var(--elevation-2);
      text-align: center;
      transition: all var(--duration-normal) var(--easing-standard);
      cursor: pointer;
    }

    .stat-card:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: var(--elevation-4);
    }

    .stat-icon {
      font-size: 2.8rem;
      display: block;
      margin-bottom: 10px;
    }

    .stat-value {
      font-size: 2.2rem;
      font-weight: 800;
      color: var(--color-primary);
    }

    .stat-label {
      font-size: 0.85rem;
      color: rgba(0, 0, 0, 0.65);
      font-weight: 600;
    }

    .chart-card {
      grid-column: span 2;
      min-height: 420px;
      padding: 24px;
    }

    .chart-card canvas {
      max-height: 360px;
      width: 100% !important;
    }

    /* Number Stepper */
    .number-stepper {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: rgba(255, 255, 255, 0.18);
      backdrop-filter: blur(12px);
      border-radius: 999px;
      box-shadow: var(--elevation-1);
    }

    .stepper-btn {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: none;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      box-shadow: var(--elevation-1);
      padding: 0;
      margin: 0;
    }

    .stepper-btn:hover {
      transform: scale(1.15);
    }

    .stepper-btn.minus {
      background: linear-gradient(135deg, #FF6B6B, #EE5A6F);
    }

    .stepper-btn.plus {
      background: linear-gradient(135deg, var(--color-success), #2ecc71);
    }

    .stepper-value {
      min-width: 42px;
      text-align: center;
      font-weight: 700;
      font-size: 1.15rem;
    }

    /* Ripple */
    .ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.7);
      transform: scale(0);
      animation: ripple-animation 0.6s var(--easing-decelerate);
      pointer-events: none;
    }

    @keyframes ripple-animation {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }

    /* Number Stepper 玻璃風格 */
    .number-stepper {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: rgba(255, 255, 255, 0.18);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.35);
      box-shadow: var(--elevation-1);
    }

    .stepper-btn {
      width: 34px;
      height: 34px;
      min-width: 34px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: rgba(0, 0, 0, 0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--duration-fast) var(--easing-standard);
      position: relative;
      overflow: hidden;
      box-shadow: var(--elevation-1);
      padding: 0;
      margin: 0;
    }

    .stepper-btn:hover {
      transform: scale(1.15);
      box-shadow: var(--elevation-3);
      background: rgba(255, 255, 255, 0.35);
    }

    .stepper-btn:active {
      transform: scale(0.92);
      box-shadow: var(--elevation-1);
    }

    .stepper-btn.minus:hover {
      background: rgba(255, 107, 107, 0.25);
      border-color: rgba(255, 107, 107, 0.4);
    }

    .stepper-btn.plus:hover {
      background: rgba(52, 199, 89, 0.25);
      border-color: rgba(52, 199, 89, 0.4);
    }

    .stepper-btn .material-symbols-outlined {
      font-size: 20px;
      line-height: 1;
      font-weight: 600;
    }

    .stepper-value {
      min-width: 42px;
      text-align: center;
      font-weight: 700;
      font-size: 1.15rem;
      color: #111;
      font-family: var(--font-system);
      user-select: none;
    }

    /* Analytics 優化 - 減少空白 */
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      padding: 0 16px;
    }

    .chart-card {
      grid-column: span 2;
      min-height: 380px;
      padding: 20px;
    }

    .stat-icon {
      font-size: 2.4rem !important;
      display: block;
      margin-bottom: 8px;
      color: var(--color-primary);
    }

    /* Spin 動畫 */
    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }


    /* ========== UX 優化樣式 ========== */

    /* Stepper 按鈕：預設透明白色，hover 才顯示顏色 */
    .stepper-btn {
      width: 34px !important;
      height: 34px !important;
      border: 1px solid rgba(255, 255, 255, 0.4) !important;
      background: rgba(255, 255, 255, 0.2) !important;
      color: rgba(0, 0, 0, 0.5) !important;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12) !important;
    }

    .stepper-btn:hover {
      transform: scale(1.15) !important;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16) !important;
    }

    .stepper-btn.minus:hover {
      background: rgba(255, 107, 107, 0.3) !important;
      border-color: rgba(255, 107, 107, 0.6) !important;
      color: rgba(255, 59, 48, 0.9) !important;
    }

    .stepper-btn.plus:hover {
      background: rgba(52, 199, 89, 0.3) !important;
      border-color: rgba(52, 199, 89, 0.6) !important;
      color: rgba(52, 199, 89, 0.9) !important;
    }

    /* 數字：0時為灰色細字，>0才為黑色粗體 */
    .stepper-value {
      font-weight: 400 !important;
      color: rgba(0, 0, 0, 0.4) !important;
    }

    .stepper-value.has-value {
      font-weight: 700 !important;
      color: #111 !important;
    }

    /* 分頁導航固定頂部 */
    body>.tab-navigation {
      margin: 2px auto !important;
      max-width: 800px !important;
      position: sticky;
      top: 20px;
      z-index: 100;
    }

    /* Analytics 緊湊布局 */
    .analytics-grid {
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)) !important;
      gap: 14px !important;
      padding: 0 14px !important;
      max-width: 1400px;
      margin: 0 auto;
    }

    .month-selector-card {
      padding: 16px !important;
    }

    .stats-cards-row {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)) !important;
      gap: 10px !important;
    }

    .stat-card {
      padding: 16px 12px !important;
    }

    .chart-card {
      grid-column: span 1 !important;
      min-height: 320px !important;
      padding: 18px !important;
    }

    .chart-card canvas {
      max-height: 280px !important;
    }

    @media (min-width: 1024px) {
      .chart-card {
        grid-column: auto !important;
      }
    }

    /* 優化刪除按鈕 */
    .row-dot {
      width: 28px !important;
      height: 28px !important;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.35);
      backdrop-filter: blur(8px);
      transition: all 0.2s ease;
      font-size: 16px;
      color: rgba(0, 0, 0, 0.4);
    }

    .row-dot:hover {
      background: rgba(255, 59, 48, 0.15) !important;
      border-color: rgba(255, 59, 48, 0.4) !important;
      color: rgba(255, 59, 48, 0.9) !important;
      transform: scale(1.1);
    }

    .delete-confirm {
      background: rgba(255, 59, 48, 0.9) !important;
      color: white !important;
      border-color: rgba(255, 59, 48, 1) !important;
    }

    /* 手機版響應式優化 */
    @media (max-width: 768px) {
      /* 隱藏次要欄位 */
      th:nth-child(6),
      td:nth-child(6),
      /* 費用 Total */
      th:nth-child(7),
      td:nth-child(7),
      /* 月薪 */
      th:nth-child(8),
      td:nth-child(8)

      /* 備註 */
        {
        display: none;
      }

      /* 調整表格容器 */
      #tableContainer {
        overflow-x: hidden;
        /* 禁止橫向捲動 */
        width: 100%;
      }

      table {
        width: 100%;
        table-layout: fixed;
      }

      /* 調整欄寬分配 */
      th:nth-child(1) {
        width: 25%;
      }

      /* 日期 */
      th:nth-child(2),
      th:nth-child(3),
      th:nth-child(4),
      th:nth-child(5) {
        width: 15%;
      }

      /* OT */
      th:last-child {
        width: 15%;
      }

      /* 刪除 */

      /* 在子選單顯示隱藏的資訊 */
      .mobile-detail-item {
        display: flex !important;
      }
    }

    /* 桌面版隱藏手機專用資訊 */
    .mobile-detail-item {
      display: none;
    }

    /* Mobile Toggle Button for Table Rows */
    .mobile-toggle-btn {
      display: none;
      position: absolute;
      left: 4px;
      top: 50%;
      transform: translateY(-50%);
      width: 28px;
      height: 28px;
      padding: 0;
      border: none;
      background: rgba(0, 122, 255, 0.1);
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 10;
      align-items: center;
      justify-content: center;
    }

    .mobile-toggle-btn .material-symbols-outlined {
      font-size: 20px;
      color: var(--color-primary);
      transition: transform 0.2s ease;
    }

    .mobile-toggle-btn.open .material-symbols-outlined {
      transform: rotate(180deg);
    }

    .mobile-toggle-btn:active {
      background: rgba(0, 122, 255, 0.2);
      transform: translateY(-50%) scale(0.95);
    }

    @media (max-width: 768px) {
      .mobile-toggle-btn {
        display: flex;
      }

      /* 確保日期欄位有足夠空間容納按鈕 */
      table td:first-child {
        padding-left: 40px !important;
      }
    }

    /* ========== Tab Navigation (Like Mac Settings) ========== */
    .tab-navigation {
      display: flex;
      justify-content: center;
      background: transparent;
      /* No background */
      padding: 4px;
      margin: 0 auto 20px auto;
      border-radius: 999px;
      width: fit-content;
      /* box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); Remove shadow if transparent */
    }

    .tab-btn {
      padding: 8px 24px;
      border-radius: 999px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--md-sys-color-on-surface-variant);
      transition: all 0.2s ease;
      position: relative;
    }

    /* Smart Stepper (Drag-to-Adjust) */
    .smart-stepper {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 32px;
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 16px;
      font-weight: 600;
      font-size: 14px;
      color: #333;
      cursor: ns-resize;
      /* 上下拖曳游標 */
      user-select: none;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .smart-stepper:hover {
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .smart-stepper.active {
      background: var(--color-primary);
      color: white;
      border-color: transparent;
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
      cursor: grabbing;
    }

    .smart-stepper.has-value {
      background: rgba(255, 255, 255, 0.9);
      color: #000;
      border-color: rgba(0, 0, 0, 0.2);
      font-weight: 700;
    }

    /* Analytics macOS Style Grid */
    .analytics-container {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 24px;
      padding: 0px 16px 24px 16px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .analytics-header {
      grid-column: span 12;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .analytics-header h2 {
      font-size: 2rem;
      font-weight: 700;
      color: #1d1d1f !important;
      margin: 0;
    }

    /* 篩選 Bar 優化 */
    .month-filter-wrapper {
      position: relative;
    }

    .month-select {
      appearance: none;
      -webkit-appearance: none;
      padding: 12px 40px 12px 20px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 600;
      color: #1d1d1f;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      min-width: 180px;
    }

    .month-select:hover {
      background: rgba(255, 255, 255, 1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      border-color: rgba(0, 122, 255, 0.3);
    }

    .month-select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 4px 16px rgba(0, 122, 255, 0.15);
    }

    .stats-columns {
      grid-column: span 12;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
    }

    .stat-column-card {
      background: var(--glass-bg);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      border-radius: var(--card-radius);
      padding: var(--card-padding);
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow-sm);
      transition: all var(--duration-normal) var(--ease-swift);
      color: var(--text-primary);
    }

    .stat-column-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
      border-color: var(--color-primary);
    }

    .column-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--glass-border);
    }

    .column-header h3 {
      margin: 0;
      font-size: 1.15rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .column-header .material-symbols-outlined {
      font-size: 32px;
    }

    .icon-blue {
      color: var(--color-primary);
    }

    .icon-green {
      color: var(--color-success);
    }

    .icon-orange {
      color: var(--color-warning);
    }

    .stat-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: rgba(var(--color-primary-rgb), 0.03);
      border-radius: 12px;
      transition: all var(--duration-fast) var(--ease-swift);
      border: 1px solid transparent;
    }

    .stat-item:hover {
      background: rgba(var(--color-primary-rgb), 0.08);
      transform: translateX(4px);
    }

    .stat-item .label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .stat-item .value {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--text-primary);
      font-variant-numeric: tabular-nums;
      letter-spacing: -0.5px;
    }

    .stat-item .value.highlight {
      color: var(--color-primary);
    }

    .chart-section {
      grid-column: span 12;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
    }

    .chart-card {
      background: var(--glass-bg);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      border-radius: var(--card-radius);
      padding: var(--card-padding);
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow-sm);
      min-height: 380px;
      transition: all var(--duration-normal) var(--ease-swift);
    }

    .chart-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
      border-color: var(--color-primary);
    }

    .chart-card h3 {
      margin: 0 0 24px 0;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    @media (max-width: 1024px) {
      .stats-columns {
        grid-template-columns: 1fr;
      }

      .chart-section {
        grid-template-columns: 1fr;
      }
    }

    /* 配合左側導航調整主內容區域 */
    @media (min-width: 769px) {
      body {
        padding-left: 0;
        /* Removed legacy sidebar padding */
      }

      .container {
        padding: 16px 24px;
      }

      .tab-navigation {
        top: 0;
        left: 0;
        border-radius: 0;
      }

      .left-panel {
        padding-top: 0;
      }

      .analytics-container {
        padding-top: 32px;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }

      .analytics-container {
        padding: 20px 16px;
      }
    }

    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.active {
      display: flex;
      opacity: 1;
    }

    .modal-content {
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s ease;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 24px;
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      position: sticky;
      top: 0;
      background: inherit;
      z-index: 10;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    /* Salary Record List */
    .salary-record-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }

    .salary-item {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 12px;
      align-items: center;
      background: rgba(255, 255, 255, 0.5);
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.8);
      transition: all 0.2s ease;
    }

    .salary-item:hover {
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .salary-item input {
      border: none;
      background: rgba(0, 0, 0, 0.05);
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 0.95rem;
      font-weight: 600;
      width: 100%;
      text-align: center;
    }

    .salary-item .stepper-btn {
      border: none;
      padding: 8px 16px;
      border-radius: 10px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: ns-resize;
      text-align: center;
    }

    /* Modal Sections */
    .modal-body section h4 {
      margin: 0 0 12px 0;
      color: var(--primary);
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-body hr {
      border: none;
      border-top: 1px solid rgba(0, 0, 0, 0.05);
      margin: 20px 0;
    }

    /* Fixed Travel Chip in Data Card (Compact) */
    .info-chip.travel-chip {
      padding: 2px 6px !important;
      min-width: 32px;
      justify-content: center;
      font-size: 0.75rem !important;
      font-weight: 700;
      gap: 0;
    }

    .info-chip.travel-chip span:not(.material-symbols-outlined) {
      margin: 0;
    }

    /* Hide flight icon in card chips as requested */
    .data-card .travel-chip .material-symbols-outlined {
      display: none;
    }

    .salary-item .stepper-btn {
      user-select: none;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .salary-item .stepper-btn.active {
      background: var(--color-primary);
      color: white;
    }

    .add-salary-btn {
      width: 100%;
      padding: 14px;
      border-radius: 16px;
      border: 2px dashed rgba(0, 0, 0, 0.1);
      background: transparent;
      color: var(--color-primary);
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .add-salary-btn:hover {
      background: rgba(0, 122, 255, 0.05);
      border-color: var(--color-primary);
    }

    .salary-actions {
      display: flex;
      gap: 8px;
    }

    /* Action Icons */
    .salary-actions .material-symbols-outlined {
      font-size: 22px;
    }

    .salary-actions .btn-v {
      color: #34c759;
      cursor: pointer;
    }

    .salary-actions .btn-x {
      color: #ff3b30;
      cursor: pointer;
    }

    /* Capsule Selector Styles */
    .capsule-container {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      overflow: visible;
      margin-top: 4px;
    }

    .capsule-toggle {
      height: 32px;
      padding: 0 12px;
      background: rgba(0, 122, 255, 0.1);
      color: var(--color-primary);
      border-radius: 16px;
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      white-space: nowrap;
      z-index: 2;
    }

    .capsule-toggle:hover {
      background: rgba(0, 122, 255, 0.15);
    }

    .capsule-toggle.active {
      background: var(--color-primary);
      color: white;
    }

    .capsule-popup {
      display: flex;
      flex-direction: column;
      gap: 2px;
      background: white;
      padding: 6px;
      border-radius: 16px;
      position: absolute;
      left: 50%;
      top: calc(100% + 12px);
      /* Open DOWNWARD to avoid being clipped by top edge */
      width: 140px;
      /* Solid width for vertical list */
      max-height: 200px;
      opacity: 0;
      visibility: hidden;
      transform: translateX(-50%) translateY(-10px) scale(0.95);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 99999 !important;
      /* Maximum priority */
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      scrollbar-width: none;
    }

    .capsule-popup::-webkit-scrollbar {
      display: none;
      /* Hide scrollbar Chrome/Safari */
    }

    .capsule-popup.open {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0) scale(1);
    }

    .capsule-option {
      padding: 8px 12px;
      width: 100%;
      border-radius: 10px;
      background: transparent;
      color: #444;
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s ease;
    }

    .capsule-option:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    /* Sub-capsule Unit for Leave Controls */
    .leave-capsule-unit {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 0;
      padding: 2px;
      border-radius: 999px;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      background: transparent;
      height: 48px;
      width: auto;
      min-width: 44px;
      flex-shrink: 0 !important;
    }

    @media (max-width: 600px) {
      .add-card-item:has(#newLeaveToggle.on) {
        flex: 1 1 100% !important;
        order: 10;
      }
    }

    .leave-capsule-unit.expanded {
      background: rgba(0, 0, 0, 0.05);
      box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
      padding: 2px 12px 2px 2px;
      gap: 8px;
    }

    .expandable-wrapper {
      display: grid;
      grid-template-columns: 0fr;
      grid-template-rows: 1fr;
      transition: grid-template-columns 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
        grid-template-rows 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      overflow: hidden;
    }

    .expandable-wrapper.expanded {
      grid-template-columns: 1fr;
      overflow: visible;
    }

    .expandable-content {
      min-width: 0;
      min-height: 0;
      width: 100%;
    }

    #leaveInfoRow {
      margin-top: 0 !important;
      padding-top: 8px;
      display: flex;
    }

    .capsule-option.selected {
      background: rgba(0, 122, 255, 0.1) !important;
      color: var(--color-primary);
      font-weight: 700;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    body.is-dragging {
      user-select: none !important;
      -webkit-user-select: none !important;
    }

    /* 手機版新增列兩排顯示優化 */
    @media (max-width: 600px) {
      .add-card-circular {
        display: flex !important;
        flex-wrap: wrap !important;
        border-radius: 20px !important;
        padding: 12px 6px !important;
        gap: 4px !important;
        justify-content: center !important;
        height: auto !important;
      }

      .add-card-item {
        flex: 1 1 auto !important;
        /* Allow items to grow/shrink naturally */
        min-width: 60px;
      }

      .leave-capsule-unit {
        height: 40px !important;
        min-width: 44px !important;
        /* Fixed! No more overlap */
      }
    }

    /* =========================================
       Rules Modal & Cards
       ========================================= */
    .rules-modal-content {
      max-width: 600px !important;
    }

    .rules-sub-header {
      font-size: 0.75rem;
      font-weight: 700;
      color: #8e8e93;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-left: 4px;
    }

    .rules-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .rule-card {
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 16px;
      position: relative;
      overflow: hidden;
      transition: transform 0.2s ease;
    }

    .rule-card:hover {
      transform: translateY(-2px);
    }

    .rule-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .rule-icon-box {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .rule-icon-box.blue {
      background: rgba(0, 122, 255, 0.1);
      color: #007AFF;
    }

    .rule-icon-box.purple {
      background: rgba(142, 68, 173, 0.1);
      color: #8E44AD;
    }

    .rule-icon-box.amber {
      background: rgba(255, 149, 0, 0.1);
      color: #FF9500;
    }

    .rule-card-header h4 {
      margin: 0;
      font-size: 0.95rem;
      font-weight: 700;
      color: #1d1d1f;
    }

    .rule-card-header p {
      margin: 0;
      font-size: 0.75rem;
      color: #86868b;
    }

    .rule-items {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .rule-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 14px;
      background: rgba(255, 255, 255, 0.45);
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      font-size: 0.85rem;
      color: #48484a;
      font-weight: 500;
    }

    .rule-item.highlight-alt {
      background: rgba(52, 199, 89, 0.05);
      border-color: rgba(52, 199, 89, 0.2);
    }

    .multiplier-badge.green {
      font-size: 0.85rem;
      font-weight: 800;
      color: #1a7f37;
      /* GitHub Green */
      background: rgba(45, 164, 78, 0.1);
      padding: 6px 14px;
      border-radius: 8px;
      border: 1.5px solid rgba(45, 164, 78, 0.4);
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      min-width: 60px;
      text-align: center;
    }

    .multiplier-badge.green:hover {
      background: rgba(45, 164, 78, 0.2);
      border-color: rgba(45, 164, 78, 0.8);
      transform: scale(1.08);
      box-shadow: 0 4px 10px rgba(45, 164, 78, 0.2);
    }

    .multiplier-badge.green:active {
      transform: scale(0.95);
    }

    .rate-link {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      font-weight: 700;
      color: #8e8e93;
      background: rgba(0, 0, 0, 0.05);
      padding: 4px 10px;
      border-radius: 6px;
    }

    .history-promo-card {
      background: linear-gradient(135deg, rgba(94, 92, 230, 0.1), rgba(0, 122, 255, 0.1));
      border: 1px solid rgba(94, 92, 230, 0.2);
      border-radius: 20px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .promo-header {
      display: flex;
      gap: 12px;
    }

    .history-icon {
      color: #5E5CE6;
      background: rgba(94, 92, 230, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .promo-header h5 {
      margin: 0;
      font-size: 0.9rem;
      font-weight: 700;
      color: #1d1d1f;
    }

    .promo-header p {
      margin: 4px 0 0 0;
      font-size: 0.7rem;
      color: #48484a;
      line-height: 1.4;
    }

    .promo-action-btn {
      background: white;
      color: #5E5CE6;
      border: none;
      border-radius: 12px;
      padding: 12px;
      font-size: 0.85rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(94, 92, 230, 0.15);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .promo-action-btn:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 16px rgba(94, 92, 230, 0.2);
    }

    .promo-action-btn:active {
      transform: scale(0.98);
    }

    /* Analytics Neumorphic Fixes */
    [data-theme="neumorphic"] .analytics-container {
      background: var(--neumo-bg) !important;
    }

    [data-theme="neumorphic"] .stat-column-card,
    [data-theme="neumorphic"] .chart-card {
      background: var(--neumo-bg) !important;
      box-shadow: var(--neumo-raised) !important;
    }

    [data-theme="neumorphic"] .stat-item {
      background: var(--neumo-bg) !important;
      box-shadow: var(--neumo-inset) !important;
      border-radius: 12px;
      margin-bottom: 8px;
      border: none !important;
    }

    [data-theme="neumorphic"] .stat-item .value {
      color: var(--neumo-brand) !important;
      text-shadow: none !important;
    }
  </style>```
</head>

<body>

  <!-- 分頁導航列（固定顯示） -->
  <!-- 分頁導航列（桌面版為左側邊欄，手機版為頂部導航） -->
  <!-- 分頁導航列已移除，改為 Header Toggle -->

  <!-- Global Persistent Header -->
  <div class="header-row">
    <div class="card header-combined-card">
      <!-- Logo (Left) -->
      <div id="logoCard" class="logo-container">
        <img
          src="https://static.wixstatic.com/media/f31164_8fb3a217689346059f1c7a5e599fa050~mv2.png/v1/fill/w_282,h_50,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/logoFONT.png"
          alt="OT Logo" class="logo-image">
      </div>

      <!-- View Toggle (Right in Header) -->
      <button id="viewToggleBtn" aria-label="View Detailed List" class="icon-button"
        onclick="location.href='#tableSection'" title="查看加班明細">
        <span class="material-symbols-outlined">table_view</span>
      </button>
    </div>
  </div>

  <!-- Overview Tab (原有內容) -->
  <div class="tab-content active" id="overview-tab">
    <div class="container" style="padding-top: 16px;">

      <!-- 左側區域 -->
      <div class="left-panel">
        <!-- 工具 (操作按鈕卡片) -->
        <div class="card actions-card">
          <div class="settings-actions" style="justify-content: center; gap: 16px;">
            <button id="exportCSVCard" class="icon-button">
              <span class="material-symbols-outlined">save</span>
            </button>
            <label for="importCSVCard" class="icon-button file-label">
              <span class="material-symbols-outlined">upload</span>
            </label>
            <button id="saveToSheetBtn" class="icon-button" aria-label="Save to Google Sheet">
              <span class="material-symbols-outlined">cloud_upload</span>
            </button>
            <button id="fillMissingDatesBtn" class="icon-button" aria-label="Fill missing dates">
              <span class="material-symbols-outlined">calendar_month</span>
            </button>

            <button id="privacyToggleBtn" class="icon-button privacy-btn" onclick="togglePrivacyMode()" title="切換隱私模式">
              <span class="material-symbols-outlined">visibility</span>
            </button>
            <button id="themeToggleBtn" class="icon-button theme-btn" onclick="toggleTheme()" title="切換主題 (新擬態/玻璃擬態)">
              <span class="material-symbols-outlined">palette</span>
            </button>
            <input type="file" id="importCSVCard" accept=".csv">
          </div>
        </div>

        <!-- 總計 (Dashboard 總計) -->
        <div class="card dashboard-card" id="dashboardCard">
          <div class="card-header" onclick="toggleDashboardCard()"
            style="padding: 16px 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; text-align: left;">本月統計</h3>
            <span class="material-symbols-outlined card-expand-icon" id="dashboardExpandIcon">expand_less</span>
          </div>

          <div class="expand-wrapper open" id="dashboardBody">
            <div class="expand-inner">
              <div class="dashboard-widgets-container">
                <!-- Stat Card: Travel -->
                <div class="stat-widget success fade-in-up stagger-1">
                  <div class="stat-icon">
                    <span class="material-symbols-outlined">flight_takeoff</span>
                  </div>
                  <div class="stat-info">
                    <span class="stat-label">出差天數</span>
                    <span class="stat-value" id="travelDays">0</span>
                  </div>
                  <canvas id="travelSparkline" class="stat-sparkline"></canvas>
                </div>

                <!-- Stat Card: OT Hours -->
                <div class="stat-widget warning fade-in-up stagger-2">
                  <div class="stat-icon">
                    <span class="material-symbols-outlined">timer</span>
                  </div>
                  <div class="stat-info">
                    <span class="stat-label">加班總時數</span>
                    <span class="stat-value" id="totalOT">0</span>
                  </div>
                  <canvas id="otSparkline" class="stat-sparkline"></canvas>
                </div>

                <!-- Stat Card: Travel Allowance -->
                <div class="stat-widget primary fade-in-up stagger-3">
                  <div class="stat-icon">
                    <span class="material-symbols-outlined">account_balance_wallet</span>
                  </div>
                  <div class="stat-info">
                    <span class="stat-label">Travel 津貼</span>
                    <span class="stat-value" id="totalTravel">0</span>
                  </div>
                  <canvas id="travelPaySparkline" class="stat-sparkline"></canvas>
                </div>

                <!-- Stat Card: OT Salary -->
                <div class="stat-widget accent fade-in-up stagger-4">
                  <div class="stat-icon">
                    <span class="material-symbols-outlined">payments</span>
                  </div>
                  <div class="stat-info">
                    <span class="stat-label">OT 加班費</span>
                    <span class="stat-value" id="totalOTSalary">0</span>
                  </div>
                  <canvas id="otPaySparkline" class="stat-sparkline"></canvas>
                </div>

                <!-- Total Income Highlights -->
                <div class="total-income-highlight">
                  <div class="highlight-label">本月總收入</div>
                  <div class="highlight-value" id="totalCost">0</div>
                </div>
              </div>
            </div>
          </div>

          <!-- 出差費率設定卡片 [NEW] -->
          <div class="card settings-card" id="travelRateCard">
            <div class="card-header" onclick="toggleTravelRateCard()"
              style="padding: 16px 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span class="material-symbols-outlined" style="color: var(--color-primary);">public</span>
                <h3 style="margin: 0; text-align: left;">出差費率 (USD)</h3>
              </div>
              <span class="material-symbols-outlined card-expand-icon" id="travelRateExpandIcon">expand_more</span>
            </div>

            <div class="expand-wrapper" id="travelRateBody">
              <div class="expand-inner">
                <div class="usd-rate-container"
                  style="background: rgba(var(--color-primary-rgb), 0.05); padding: 12px; border-radius: 12px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-weight: 600; font-size: 0.9rem;">美金匯率</span>
                  <input type="number" id="usdRate" value="32.5" step="0.1"
                    style="width: 80px; text-align: right; padding: 4px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1);">
                </div>
                <section class="travel-rate-section">
                  <div id="travelRateList" class="salary-record-list"
                    style="max-height: 200px; overflow-y: auto; margin-bottom: 12px;"></div>
                  <button class="promo-action-btn" onclick="addTravelRateRecord()"
                    style="width: 100%; justify-content: center; margin: 0;">
                    <span class="material-symbols-outlined">add</span>
                    <span>新增地區</span>
                  </button>
                </section>
              </div>
            </div>
          </div>

          <!-- 特休管理卡片 [NEW] -->
          <div class="card settings-card" id="leaveManagementCard">
            <div class="card-header" onclick="toggleLeaveManagementCard()"
              style="padding: 16px 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span class="material-symbols-outlined" style="color: var(--color-danger);">person_pin</span>
                <h3 style="margin: 0; text-align: left;">特休給假管理</h3>
              </div>
              <span class="material-symbols-outlined card-expand-icon" id="leaveManagementExpandIcon">expand_more</span>
            </div>

            <div class="expand-wrapper" id="leaveManagementBody">
              <div class="expand-inner">
                <section class="salary-section">
                  <div style="background: rgba(var(--color-danger-rgb), 0.05); padding: 16px; border-radius: 12px;">
                    <div
                      style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                      <span style="font-weight: 600; font-size: 0.9rem;">核給總時數 (天)</span>
                      <input type="number" id="annualLeaveQuoata" value="5.25" step="0.125"
                        onchange="saveLeaveQuota(this.value)"
                        style="width: 80px; text-align: right; padding: 4px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1);">
                    </div>
                    <div id="leaveSummaryUI"
                      style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.5;"></div>
                  </div>
                </section>
              </div>
            </div>
          </div>
        </div>

        <!-- 系統工具 (Toolbox - 摺疊設計) -->
        <div class="card system-tools-card" id="toolboxCard">
          <div class="card-header" onclick="toggleToolboxCard()"
            style="padding: 16px 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; text-align: left;">系統工具 (Toolbox)</h3>
            <span class="material-symbols-outlined card-expand-icon" id="toolboxExpandIcon">expand_more</span>
          </div>

          <div class="expand-wrapper" id="toolboxBody">
            <div class="expand-inner">
              <div class="settings-actions"
                style="margin-top: 16px; display: flex; flex-direction: column; gap: 12px; align-items: stretch;">
                <button class="promo-action-btn" onclick="openSalaryModal()">
                  <span class="material-symbols-outlined">payments</span>
                  <span>薪資紀錄管理</span>
                </button>
                <button class="promo-action-btn" onclick="openRulesModal()">
                  <span class="material-symbols-outlined">gavel</span>
                  <span>加班計算規則</span>
                </button>
                <button class="promo-action-btn" id="runDiagnosticsBtn" onclick="runDiagnostics()">
                  <span class="material-symbols-outlined">analytics</span>
                  <span>執行系統診斷</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div> <!-- End of left-panel -->

      <!-- 右側區域 -->
      <div class="right-panel">

        <!-- 新增資料卡片 (Smart Stepper 統一設計) -->
        <div class="add-card add-card-circular">
          <div class="add-card-item">
            <label>日期</label>
            <button type="button" id="newDate" class="smart-stepper-add" data-type="date">--/--</button>
          </div>
          <div class="add-card-item">
            <label>Hour</label>
            <button type="button" id="newHour" class="smart-stepper-add" data-type="hour">17</button>
          </div>
          <div class="add-card-item">
            <label>Min</label>
            <button type="button" id="newMinute" class="smart-stepper-add" data-type="minute">30</button>
          </div>
          <div class="add-card-item">
            <label>Holiday</label>
            <button type="button" id="newHolidayToggle" class="smart-stepper-add"
              style="border: none; background: rgba(0,0,0,0.05) !important;">
              <span class="material-symbols-outlined" style="font-size: 20px;">event_busy</span>
            </button>
          </div>
          <div class="add-card-item" id="newLeaveItem">
            <label>Leave</label>
            <div class="leave-capsule-unit" id="leaveCapsuleUnit">
              <button type="button" id="newLeaveToggle" class="smart-stepper-add" title="切換請假狀態">
                <span class="material-symbols-outlined">person</span>
              </button>
              <div class="expandable-wrapper" id="leaveInfoWrapper">
                <div class="expandable-content" style="display: flex; align-items: center; height: 100%;">
                  <div class="add-card-item" id="leaveInfoRow"
                    style="flex-direction: row; gap: 8px; margin-top: 0; padding-top: 0; white-space: nowrap;">
                    <!-- Capsules dynamically injected here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="add-card-item">
            <label>Travel</label>
            <button type="button" id="newTravelCountry" class="smart-stepper-add" data-type="travel">
              <span class="material-symbols-outlined" style="font-size: 20px;">flight</span>
            </button>
          </div>
          <div class="add-card-item">
            <label>&nbsp;</label>
            <button id="addRowCard" class="circular-add-btn-round">
              <span class="material-symbols-outlined">add</span>
            </button>
          </div>
        </div>

        <!-- 表格容器 -->
        <div id="tableContainer">
          <!-- 表格由 JS 動態生成 -->
        </div>

      </div> <!-- End of right-panel -->

    </div> <!-- End of container -->

  </div>
  <!-- End of Overview Tab -->

  <!-- Analytics Tab -->
  <div class="tab-content" id="analytics-tab">
    <div class="analytics-container">

      <!-- 頂部控制列 -->
      <div class="analytics-header">
        <h2>Analytics</h2>
        <div class="month-filter-wrapper">
          <select id="monthFilter" class="month-select">
            <option value="">全部月份</option>
          </select>
        </div>
      </div>

      <!-- 統計專欄區 (Grid 佈局) -->
      <div class="stats-columns">

        <!-- 天數專欄 -->
        <div class="stat-column-card">
          <div class="column-header">
            <span class="material-symbols-outlined icon-blue">calendar_month</span>
            <h3>天數統計</h3>
          </div>
          <div class="stat-list">
            <div class="stat-item">
              <span class="label">統計日期</span>
              <span class="value" id="statDateRange" style="font-size: 0.85rem;">--/--/-- - --/--/--</span>
            </div>
            <div class="stat-item">
              <span class="label">工作天數</span>
              <span class="value" id="statWorkDays">0</span>
            </div>
            <div class="stat-item">
              <span class="label">出差天數</span>
              <span class="value" id="statTravelDays">0</span>
            </div>
            <div class="stat-item">
              <span class="label">平日加班</span>
              <span class="value" id="statWeekdayDays">0</span>
            </div>
            <div class="stat-item">
              <span class="label">週末加班</span>
              <span class="value" id="statWeekendDays">0</span>
            </div>
          </div>
        </div>

        <!-- 薪資專欄 -->
        <div class="stat-column-card">
          <div class="column-header">
            <span class="material-symbols-outlined icon-green">payments</span>
            <h3>薪資概況</h3>
          </div>
          <div class="stat-list">
            <div class="stat-item">
              <span class="label">平均日薪</span>
              <span class="value" id="statAvgDaily">0</span>
            </div>
            <div class="stat-item">
              <span class="label">平均時薪</span>
              <span class="value" id="statAvgHourly">0</span>
            </div>
            <div class="stat-item">
              <span class="label">平均月薪</span>
              <span class="value" id="statAvgMonthly">0</span>
            </div>
            <div class="stat-item highlight-alt">
              <span class="label">實質時薪 (有效)</span>
              <span class="value" id="statEffectiveHourly">0</span>
            </div>
          </div>
        </div>

        <!-- 收入專欄 -->
        <div class="stat-column-card">
          <div class="column-header">
            <span class="material-symbols-outlined icon-orange">savings</span>
            <h3>收入分析</h3>
          </div>
          <div class="stat-list">
            <div class="stat-item"
              style="display: flex; flex-direction: row; justify-content: space-between; align-items: center; gap: 8px;">
              <div style="flex: 1; display: flex; flex-direction: column;">
                <span class="label">總收入 (All)</span>
                <span class="value highlight" id="statTotalIncome">0</span>
              </div>
              <div style="width: 1px; height: 30px; background: rgba(0,0,0,0.1);"></div>
              <div style="flex: 1; display: flex; flex-direction: column; align-items: flex-end;">
                <span class="label">近一年 (1Y)</span>
                <span class="value" id="statTotalIncomeLastYear"
                  style="color: var(--color-primary); font-weight: 700;">0</span>
              </div>
            </div>
            <div class="stat-item">
              <span class="label">本月收入</span>
              <span class="value" id="statThisMonthIncome">0</span>
            </div>
            <div class="stat-item" style="display: flex; align-items: center; justify-content: space-between;">
              <span class="label">加班總時數</span>
              <div style="display: flex; align-items: center; gap: 6px;">
                <span class="value" id="statOTHours">0</span>
                <span class="capsule" id="statOTHoursThisMonth"
                  style="background: var(--color-primary); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; opacity: 0.9;">+0</span>
              </div>
            </div>
            <div class="stat-item">
              <span class="label">出差補貼佔比</span>
              <span class="value" id="statTravelRatio">0%</span>
            </div>
            <div class="stat-item highlight-alt" style="background: rgba(var(--color-primary-rgb), 0.1);">
              <span class="label">平均年薪 (估算)</span>
              <span class="value" id="statAvgAnnual">0</span>
            </div>
          </div>
        </div>

      </div>

      <!-- 圖表區 (Grid 佈局) -->
      <div class="chart-section">
        <div class="chart-card">
          <h3>月度加班趨勢</h3>
          <div style="position: relative; height: 100%; width: 100%;">
            <canvas id="overtimeChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3>收入結構</h3>
          <div style="display: flex; gap: 16px; height: 100%; width: 100%;">
            <div style="flex: 1; position: relative;">
              <div style="font-size: 0.7rem; text-align: center; color: #999; margin-bottom: 4px;">所有資料平均</div>
              <canvas id="incomeChart"></canvas>
            </div>
            <div style="flex: 1; position: relative;">
              <div style="font-size: 0.7rem; text-align: center; color: #999; margin-bottom: 4px;">近三個月平均</div>
              <canvas id="incomeChart3M"></canvas>
            </div>
          </div>
        </div>
        <!-- Attendance Analysis (Merged Office & Travel) -->
        <div class="chart-card">
          <div class="chart-header">
            <span class="material-symbols-outlined icon-blue">analytics</span>
            <h3>月度出勤統計 (Office vs Travel)</h3>
          </div>
          <div class="chart-container" style="position: relative; height: 100%; width: 100%;">
            <canvas id="attendanceChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3>月度薪資趨勢</h3>
          <div style="position: relative; height: 100%; width: 100%;">
            <canvas id="salaryTrendChart"></canvas>
          </div>
        </div>
      </div>

    </div>
  </div>
  <!-- End of Analytics Tab -->

  <!-- 薪資紀錄彈窗 -->
  <div id="salaryModal" class="modal-overlay">
    <div class="modal-content glass-window">
      <div class="modal-header">
        <h3>薪資紀錄管理</h3>
        <button class="icon-button close-btn" onclick="closeSalaryModal()">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="salarySummary"
          style="background: rgba(var(--color-primary-rgb), 0.05); padding: 12px; border-radius: 12px; margin-bottom: 16px; font-size: 0.9rem;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
            <span>目前薪資:</span>
            <span id="currentSalaryVal" style="font-weight: 700;">-</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span>預估年薪:</span>
            <span id="estimatedAnnualSalary" style="font-weight: 700; color: var(--color-primary);">-</span>
          </div>
        </div>
        <section class="salary-section">
          <div id="salaryList" class="salary-record-list"></div>
          <button class="add-salary-btn" onclick="addSalaryRecord()">
            <span class="material-symbols-outlined">add</span>
            <span>新增調薪紀錄</span>
          </button>
        </section>
        <div class="modal-footer">
          <button class="icon-button" onclick="closeSalaryModal()" style="width: 100%; background: #666;">
            <span>關閉視窗</span>
          </button>
        </div>
      </div>
    </div>
  </div>


  <!-- 加班計算規則彈窗 -->
  <div id="rulesModal" class="modal-overlay">
    <div class="modal-content glass-window rules-modal-content">
      <div class="modal-header">
        <h3 style="display: flex; align-items: center; gap: 8px;">
          <span class="material-symbols-outlined">calculate</span>
          <span>加班計算規則</span>
        </h3>
        <button class="icon-button close-btn" onclick="closeRulesModal()">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <div class="modal-body no-scrollbar" style="max-height: 75vh; overflow-y: auto;">

        <div class="rules-section">
          <div class="rules-grid">
            <!-- Weekdays -->
            <div class="rule-card">
              <div class="rule-card-header">
                <div class="rule-icon-box blue">
                  <span class="material-symbols-outlined">work</span>
                </div>
                <div>
                  <h4>平日 (Weekdays)</h4>
                  <p>17:30 起算</p>
                </div>
              </div>
              <div class="rule-items">
                <div class="rule-item">
                  <span>前 2 小時 (First 2h)</span>
                  <div class="multiplier-badge green" onclick="editMultiplier('weekday_134')" id="m_weekday_134">1.34x
                  </div>
                </div>
                <div class="rule-item">
                  <span>之後 (Thereafter)</span>
                  <div class="multiplier-badge green" onclick="editMultiplier('weekday_167')" id="m_weekday_167">1.67x
                  </div>
                </div>
              </div>
            </div>

            <!-- Rest Days -->
            <div class="rule-card">
              <div class="rule-card-header">
                <div class="rule-icon-box purple">
                  <span class="material-symbols-outlined">weekend</span>
                </div>
                <div>
                  <h4>例假日 (Rest Days)</h4>
                  <p>週末或休息日</p>
                </div>
              </div>
              <div class="rule-items">
                <div class="rule-item">
                  <span>前 2 小時 (First 2h)</span>
                  <div class="multiplier-badge green" onclick="editMultiplier('weekend_134')" id="m_weekend_134">1.34x
                  </div>
                </div>
                <div class="rule-item">
                  <span>3 - 8 小時</span>
                  <div class="multiplier-badge green" onclick="editMultiplier('weekend_167')" id="m_weekend_167">1.67x
                  </div>
                </div>
                <div class="rule-item">
                  <span>9+ 小時</span>
                  <div class="multiplier-badge green" onclick="editMultiplier('weekend_267')" id="m_weekend_267">2.67x
                  </div>
                </div>
              </div>
            </div>

            <!-- Holidays -->
            <div class="rule-card">
              <div class="rule-card-header">
                <div class="rule-icon-box amber">
                  <span class="material-symbols-outlined">celebration</span>
                </div>
                <div>
                  <h4>國定假日 (Holidays)</h4>
                  <p>法定假日</p>
                </div>
              </div>
              <div class="rule-items">
                <div class="rule-item">
                  <span>前 8 小時 (First 8h)</span>
                  <div class="multiplier-badge green" onclick="editMultiplier('holiday_200')" id="m_holiday_200">2.00x
                  </div>
                </div>
                <div class="rule-item">
                  <span>之後 (Thereafter)</span>
                  <div class="rate-link">
                    <span class="material-symbols-outlined">arrow_outward</span>
                    比照平日
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="rules-section" style="margin-top: 24px;">
          <div class="history-promo-card">
            <div class="promo-header">
              <span class="material-symbols-outlined history-icon">history</span>
              <div>
                <h5>薪資調整溯源</h5>
                <p>Calculations automatically use the monthly salary effective on the specific overtime date.</p>
              </div>
            </div>
            <button class="promo-action-btn" onclick="closeRulesModal(); openSalaryModal();">
              查看或新增薪資紀錄
              <span class="material-symbols-outlined">chevron_right</span>
            </button>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button class="icon-button" onclick="closeRulesModal()" style="width: 100%; background: #666;">
          <span>關閉視窗</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // 全域變數（供 Analytics 功能使用）
    let tableData = [];
    let newRowTravelEnabled = true;
    let selectedMonth = null;
    let charts = {};
    let chartsInitialized = false;
    let availableMonths = [];

    ; (function (global) {
      // 在 Apps Script（後端）也會載入這個檔案，但沒有 window / document，所以這裡用 globalThis/this 做防呆
      if (!global || !global.document) {
        return;
      }

      // --- Mobile & Error Handling ---
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // 全域錯誤捕捉 (供手機版診斷)
      window.onerror = function (msg, url, line, col, error) {
        const errStr = `[OT Error] ${msg} at ${line}:${col}`;
        console.error(errStr, error);
        if (typeof showNotification === 'function') {
          showNotification('⚠️ 系統發生錯誤，正在嘗試恢復...', true);
        }
        return false;
      };

      window.onunhandledrejection = function (event) {
        console.error('[OT Promise Error]', event.reason);
      };

      global.__BUILD_TAG__ = '2026-01-23-v28-fix-permissions';
      console.log('[OT] BUILD', global.__BUILD_TAG__, isMobile ? '(Mobile)' : '(Desktop)');

      // 變數已移至全域
      // --- Helper Functions ---
      function safeParseFloat(val) {
        if (val === undefined || val === null || val === '') return 0;
        if (typeof val === 'number') return val;
        // 移除逗號後再轉換
        const clean = val.toString().replace(/,/g, '');
        return parseFloat(clean) || 0;
      }

      // iOS Safari 兼容的日期解析 (YYYY/MM/DD 或 YYYY-MM-DD)
      function parseDateSafe(dateStr) {
        if (!dateStr) return new Date();
        if (dateStr instanceof Date) return dateStr;
        let s = String(dateStr).trim();
        if (s.indexOf('T') !== -1) return new Date(s);
        // 將 - 替換為 / 是 iOS Safari 最保險的做法
        return new Date(s.replace(/-/g, '/'));
      }

      // 將各種格式 (ISO, Date 字串, 數值) 轉為 HH:mm 格式
      function normalizeTime(val) {
        if (!val) return '';
        const s = val.toString().trim();
        if (!s) return '';

        // 情況 A: ISO 格式或包含 T 的字串 (Google Sheets 常見)
        // 例如 1899-12-30T17:30:00.000Z 或 2024-01-01T21:00:00
        if (s.includes('T') || (s.includes(' ') && s.includes('-'))) {
          const d = new Date(s);
          if (!isNaN(d.getTime())) {
            return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
          }
        }

        // 情況 B: 只有時間部分 或包含 1899 的空格字串
        // 例如 "23:23" 或 "1899/12/30 23:23:00"
        const timeMatch = s.match(/(\d{1,2}):(\d{1,2})/);
        if (timeMatch) {
          // 即使匹配到了，如果是 1899/12/30 這種，直接用 Regex 抓最後的時間段最保險
          const parts = s.split(' ');
          const lastPart = parts[parts.length - 1];
          if (lastPart.includes(':')) {
            const [h, m] = lastPart.split(':');
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
          }
        }

        return s;
      }

      // 強化版本 localStorage 存取 (避免 GAS iframe 或無痕模式失效)
      const storage = {
        get: (key) => {
          try {
            return localStorage.getItem(key);
          } catch (e) {
            console.warn(`[OT] localStorage.get(${key}) failed:`, e);
            return null;
          }
        },
        set: (key, val) => {
          try {
            localStorage.setItem(key, val);
            return true;
          } catch (e) {
            console.warn(`[OT] localStorage.set(${key}) failed:`, e);
            return false;
          }
        }
      };

      function getWeekdayChar(dateStr) {
        const date = parseDateSafe(dateStr);
        const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
        return weekdays[date.getDay()];
      }

      function debounce(func, wait) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      const debouncedUpdateAnalytics = debounce(() => {
        updateCharts();
        updateAnalyticsStats();
      }, 300);

      function formatDateYYYYMMDD(d) {
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
      }

      // 根據國家代碼取得每日 Travel USD (Dynamic from localStorage)
      function getTravelUsdByCountry(country) {
        if (!country || country === 'None') return 0;
        const rates = getTravelRates();
        return safeParseFloat(rates[country]) || 40; // Default to 40 if not found
      }

      function getCountryAbbr(country) {
        if (!country || country === 'None') return '';
        const mapping = {
          'Vietnam': 'VN',
          'India': 'IN',
          'China': 'CN',
          'Taiwan': 'TW',
          'Japan': 'JP',
          'Thailand': 'TH',
          'Korea': 'KR'
        };
        return mapping[country] || country.slice(0, 2).toUpperCase();
      }

      // Centralized settings state
      let globalSettings = {
        salaryHistory: [{ date: '2000-01', amount: 68000 }],
        travelRates: { 'Vietnam': 40, 'China': 32.05, 'India': 75 },
        usdRate: 32.5,
        rules: {} // Placeholder for OT calculation rules
      };

      function loadLocalSettings() {
        try {
          const stored = storage.get('globalSettings');
          if (stored) {
            globalSettings = JSON.parse(stored);
          } else {
            // Fallback to old keys for backward compatibility
            const sh = storage.get('salaryHistory');
            const tr = storage.get('travelRates');
            if (sh) globalSettings.salaryHistory = JSON.parse(sh);
            if (tr) globalSettings.travelRates = JSON.parse(tr);
          }
        } catch (e) { console.warn('[OT] Failed to load local settings:', e); }

        // Ensure sorting
        if (globalSettings.salaryHistory) {
          globalSettings.salaryHistory.sort((a, b) => b.date.localeCompare(a.date));
        }
      }
      loadLocalSettings();

      function getTravelRates() {
        return globalSettings.travelRates;
      }

      // 更新: 重新計算所有資料，並重新渲染
      function updateAll(openIndex = null, skipRender = false) {
        try {
          if (!globalSettings.salaryHistory) globalSettings.salaryHistory = [];
          const salaryHistory = [...globalSettings.salaryHistory].sort((a, b) => b.date.localeCompare(a.date));
          const rateInput = document.getElementById('usdRate');
          let rate = globalSettings.usdRate || 32.5;
          if (rateInput && rateInput.value !== '') {
            rate = safeParseFloat(rateInput.value);
          }
          globalSettings.usdRate = rate;
          if (rateInput && document.activeElement !== rateInput) {
            rateInput.value = rate;
          }
          // const travelUsdPerDay = getTravelUsdByCountry(); // 不再使用全域設定

          // 1. 先按日期「由舊到新」排序，確保累加計算 (accum) 正確
          tableData.sort((a, b) => parseDateSafe(a.date) - parseDateSafe(b.date));

          let accum = 0;
          const monthTravelSums = {}; // key: 'YYYY-MM' -> 該月 Travel 加總
          const monthOtSalarySums = {}; // key: 'YYYY-MM' -> 該月 OT Salary 加總

          // 由前端依 salary / rate / travel 設定重新計算
          tableData.forEach((entry) => {
            const date = parseDateSafe(entry.date);
            const isWeekend = (date.getDay() === 0 || date.getDay() === 6);
            const isHoliday = !!entry.isHoliday;

            const mults = getOTMultipliers();
            let m134 = mults.weekday_134;
            let m167 = mults.weekday_167;
            let m166 = mults.holiday_200; // Holiday base bucket
            let m267 = mults.weekend_267; // Default for 9h+ if weekend? (logic below overrides)

            if (isWeekend && !isHoliday) {
              // Saturday/Sunday: Base (1.0) is already in monthly salary. 
              // We use the configured weekend multipliers
              m134 = mults.weekend_134 - 1.0; // i.e. 1.34 - 1.0 = 0.34
              m167 = mults.weekend_167 - 1.0; // i.e. 1.67 - 1.0 = 0.67
              m267 = mults.weekend_267; // 9h+ (no base usually)
            } else if (isHoliday) {
              // Holiday rules
              m166 = mults.holiday_200 - 1.0; // i.e. 2.0 - 1.0 = 1.0
              m134 = mults.weekday_134;
              m167 = mults.weekday_167;
            }

            const otSum =
              (safeParseFloat(entry.v167) || 0) * m167 +
              (safeParseFloat(entry.v134) || 0) * m134 +
              (safeParseFloat(entry.v166) || 0) * m166 +
              (safeParseFloat(entry.v267) || 0) * m267;

            // 資料遷移：舊資料 travelEnabled=true 轉為 Vietnam，false 轉為 None
            if (!entry.travelCountry) {
              if (entry.travelEnabled === false) entry.travelCountry = 'None';
              else entry.travelCountry = 'Vietnam';
            }

            const isLeave = !!entry.isLeave;
            if (isLeave && !entry.leaveType) {
              entry.leaveType = '特休';
              entry.leaveAmount = 1;
            }
            const otHours = (safeParseFloat(entry.v167) || 0) + (safeParseFloat(entry.v134) || 0) + (safeParseFloat(entry.v166) || 0) + (safeParseFloat(entry.v267) || 0);

            // Find applicable salary from history (latest record where h.date <= entryMonth)
            const entryMonth = entry.date ? entry.date.slice(0, 7) : '0000-00';
            const applicable = salaryHistory.find(h => h.date <= entryMonth) || salaryHistory[salaryHistory.length - 1];
            const salary = applicable ? safeParseFloat(applicable.amount) : 68000;

            const base = (isLeave && entry.leaveType !== '特休') ? 0 : (salary / 30);
            const travelUsd = isLeave ? 0 : getTravelUsdByCountry(entry.travelCountry);
            const travel = travelUsd * rate;
            const otSalary = isLeave ? 0 : ((salary / 30 / 8) * otSum);
            const total = base + travel + otSalary;

            accum += total;

            entry.isLeave = isLeave; // Ensure boolean
            entry.otSum = (otSum || 0).toFixed(2);
            entry.otHours = (otHours || 0).toFixed(1);
            entry.totalOtHoursNumeric = otHours; // Real number for display logic
            entry.base = (base || 0).toFixed(2);
            entry.travel = (travel || 0).toFixed(2);
            entry.otSalary = (otSalary || 0).toFixed(2);
            entry.total = (total || 0).toFixed(2);
            entry.accum = (accum || 0).toFixed(2);
            entry.weekday = getWeekdayChar(entry.date);

            // 依月份累積：當月 Travel 與 OT Salary（不含 Base）
            const monthKey = entry.date ? entry.date.slice(0, 7) : '';
            if (monthKey) {
              monthTravelSums[monthKey] = (monthTravelSums[monthKey] || 0) + travel;
              monthOtSalarySums[monthKey] = (monthOtSalarySums[monthKey] || 0) + otSalary;
            }
          });

          // 依月份回寫「月薪」欄位
          tableData.forEach((entry) => {
            const monthKey = entry.date ? entry.date.slice(0, 7) : '';
            if (monthKey) {
              const travelSum = monthTravelSums[monthKey] || 0;
              const otSalarySum = monthOtSalarySums[monthKey] || 0;

              const applicable = salaryHistory.find(h => h.date <= monthKey) || salaryHistory[salaryHistory.length - 1];
              const salary = applicable ? safeParseFloat(applicable.amount) : 68000;

              entry.monthSLR = (salary + travelSum + otSalarySum).toFixed(0);
            }
          });

          // 2. 計算完畢後，還原為「顯示用排序」：月份由新到舊，日期由舊到新 (Calendar Style)
          tableData.sort((a, b) => {
            const dA = parseDateSafe(a.date);
            const dB = parseDateSafe(b.date);
            const mA = dA.getFullYear() * 12 + dA.getMonth();
            const mB = dB.getFullYear() * 12 + dB.getMonth();
            if (mA !== mB) return mB - mA;
            return dA - dB;
          });

          if (!skipRender) {
            renderDataList(openIndex);
            updateTableValues();
            // Ensure charts and stats stay in sync
            updateCharts();
            updateAnalyticsStats();
          }
          // 更新全域 Month Header Chiplist
          if (global.updateMonthStatsDOM) {
            global.updateMonthStatsDOM();
          }

          updateDashboard();
          updateLeaveSummaryDOM();
          debouncedUpdateAnalytics();

          // [Audit Fix] Add local persistence fallback
          storage.set('overtimeData', JSON.stringify(tableData));
        } catch (err) {
          console.error('[OT] updateAll 發生預期外錯誤:', err);
          showNotification('❌ 計算更新失敗，請檢查資料格式', true);
        }
      }

      // 更新表格中已渲染的數值（不重新建立 DOM）
      function updateTableValues() {
        const rows = document.querySelectorAll('.data-row');
        rows.forEach((row, index) => {
          const entry = tableData[index];
          if (!entry) return;

          // 更新 OT 數值顯示
          const steppers = row.querySelectorAll('.stepper-value');
          steppers.forEach((valueSpan, i) => {
            const keys = ['v167', 'v134', 'v166', 'v267'];
            if (entry[keys[i]] !== undefined) {
              valueSpan.textContent = entry[keys[i]];
              // 更新 class
              if (entry[keys[i]] > 0) {
                valueSpan.classList.add('has-value');
              } else {
                valueSpan.classList.remove('has-value');
              }
            }
          });

          // 更新總計
          const totalSpan = row.querySelector('.total-value');
          if (totalSpan) {
            totalSpan.textContent = Math.round(entry.total);
            totalSpan.classList.add('privacy-hidden');
          }
        });
      }
      function fillMissingDatesToToday() {
        if (!tableData.length) {
          showNotification('❌ 目前沒有任何資料，無法自動補滿日期', true);
          return;
        }

        // 找出目前資料中「最新」日期
        let latest = null;
        tableData.forEach((entry) => {
          if (!entry.date) return;
          const d = parseDateSafe(entry.date);
          if (!latest || d > latest) {
            latest = d;
          }
        });

        if (!latest) {
          showNotification('❌ 目前資料日期格式異常，無法自動補滿日期', true);
          return;
        }

        const latestDateStr = formatDateYYYYMMDD(latest); // Corrected this line
        const latestDateObj = parseDateSafe(latestDateStr);
        const startDate = new Date(latestDateObj.getFullYear(), latestDateObj.getMonth(), latestDateObj.getDate() + 1);
        const today = new Date();
        const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        let added = 0; // Initialize added counter
        const addedDates = []; // Initialize addedDates array

        if (startDate > todayDateOnly) {
          showNotification('✅ 目前已補滿至今日，沒有新增資料');
          return;
        }

        for (let d = new Date(startDate); d <= todayDateOnly; d.setDate(d.getDate() + 1)) {
          const dateStr = formatDateYYYYMMDD(d);
          const newEntry = {
            date: dateStr,
            v167: 0,
            v134: 0,
            v166: 0,
            v267: 0,
            remark: '',
            travelEnabled: newRowTravelEnabled,
          };
          tableData.push(newEntry);
          added++;
          addedDates.push(dateStr);
        }

        if (!added) {
          showNotification('✅ 目前已補滿至今日，沒有新增資料');
          return;
        }

        // 重新排序並重算 (月份由新到舊，日期由舊到新)
        tableData.sort((a, b) => {
          const dA = new Date(a.date);
          const dB = new Date(b.date);
          const mA = dA.getFullYear() * 12 + dA.getMonth();
          const mB = dB.getFullYear() * 12 + dB.getMonth();
          if (mA !== mB) return mB - mA;
          return dA - dB;
        });
        updateAll();

        const first = addedDates[0];
        const last = addedDates[addedDates.length - 1];

        const formatMMDD = (iso) => {
          const mm = iso.slice(5, 7);
          const dd = iso.slice(8, 10);
          return `${mm}${dd}`;
        };

        const msg = `✅ 新增 ${added} 筆，從 ${formatMMDD(first)} 到 ${formatMMDD(last)}`;
        showNotification(msg);
      }

      // 新增資料
      function addNewEntry(entry) {
        tableData.push(entry);
        tableData.sort((a, b) => {
          const dA = new Date(a.date);
          const dB = new Date(b.date);
          const mA = dA.getFullYear() * 12 + dA.getMonth();
          const mB = dB.getFullYear() * 12 + dB.getMonth();
          if (mA !== mB) return mB - mA;
          return dA - dB;
        });
        updateAll();
      }

      // 刪除資料
      function deleteEntry(index) {
        if (index >= 0 && index < tableData.length) {
          tableData.splice(index, 1);
          updateAll();
          showNotification('🗑️ 資料已刪除');
        }
      }

      // 調整 OT 數值（不重新渲染表格，只更新數值）
      function adjustOTValue(entry, key, delta) {
        if (key === 'vH' || key === 'vM') {
          const timeStr = normalizeTime(entry.endTime) || '17:30';
          let [hStr, mStr] = timeStr.split(':');
          let h = parseInt(hStr, 10);
          let m = parseInt(mStr, 10);

          // Fallback for NaN (should not happen with normalizeTime but stay safe)
          if (isNaN(h)) h = 17;
          if (isNaN(m)) m = 30;

          if (key === 'vH') {
            h = (h + delta + 24) % 24;
          } else {
            m = (m + delta * 10 + 60) % 60; // 10 min steps
          }
          entry.endTime = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;

          // Recalculate buckets
          const res = calculateOvertime(h, m, entry.date, entry.isHoliday);
          entry.v134 = res.v134;
          entry.v167 = res.v167;
          entry.v267 = res.v267;
          entry.v166 = res.v166;
          entry.totalOtHoursNumeric = res.total;

          updateAll(null, true);
          return;
        }
        const newVal = Math.max(0, (entry[key] || 0) + delta);
        entry[key] = newVal;

        // 只更新該列的數值和計算結果，不重新渲染整個表格
        updateAll(null, true); // 傳入 skipRender=true
      }

      // --- Rules Modal Logic ---
      function getOTMultipliers() {
        const stored = storage.get('otMultipliers');
        const defaults = {
          weekday_134: 1.34,
          weekday_167: 1.67,
          weekend_134: 1.34,
          weekend_167: 1.67,
          weekend_267: 2.67,
          holiday_200: 2.00
        };
        if (!stored) return defaults;
        try {
          return { ...defaults, ...JSON.parse(stored) };
        } catch (e) {
          return defaults;
        }
      }

      function editMultiplier(key) {
        const mults = getOTMultipliers();
        const current = mults[key];
        const newVal = prompt(`請輸入新的倍率 (目前: ${current}x):`, current);

        if (newVal !== null) {
          const floatVal = parseFloat(newVal);
          if (isNaN(floatVal)) {
            showNotification('❌ 請輸入有效的數字', true);
            return;
          }
          mults[key] = floatVal;
          storage.set('otMultipliers', JSON.stringify(mults));
          renderMultiplierRules();
          updateAll();
          showNotification('✅ 倍率已更新並儲存');
        }
      }

      function renderMultiplierRules() {
        const mults = getOTMultipliers();
        const mapping = {
          'weekday_134': 'm_weekday_134',
          'weekday_167': 'm_weekday_167',
          'weekend_134': 'm_weekend_134',
          'weekend_167': 'm_weekend_167',
          'weekend_267': 'm_weekend_267',
          'holiday_200': 'm_holiday_200'
        };

        for (const [key, id] of Object.entries(mapping)) {
          const el = document.getElementById(id);
          if (el) {
            el.textContent = `${mults[key].toFixed(2)}x`;
          }
        }
      }

      function openRulesModal() {
        const modal = document.getElementById('rulesModal');
        if (modal) {
          renderMultiplierRules();
          modal.classList.add('active');
          document.body.style.overflow = 'hidden';
        }
      }

      function closeRulesModal() {
        const modal = document.getElementById('rulesModal');
        if (modal) {
          modal.classList.remove('active');
          document.body.style.overflow = '';
        }
      }

      global.openRulesModal = openRulesModal;
      global.closeRulesModal = closeRulesModal;
      global.editMultiplier = editMultiplier;

      // 數字翻牌動畫通用 helper（逐位數）
      function setAnimatedNumber(element, newValue) {
        if (!element) return;
        const newText = String(newValue);
        const oldText = element.dataset.value ?? element.textContent;

        if (oldText === newText) {
          element.dataset.value = newText;
          return;
        }

        element.dataset.value = newText;
        element.innerHTML = '';

        for (let i = 0; i < newText.length; i++) {
          const ch = newText[i];
          const span = document.createElement('span');
          span.textContent = ch;
          span.classList.add('digit');
          if (oldText[i] !== ch) {
            span.classList.add('flip');
          }
          element.appendChild(span);
        }
      }

      // 簡單的通知氣泡（成功 / 失敗提示）
      function showNotification(message, isError = false) {
        let bubble = document.getElementById('otNotifyBubble');
        if (!bubble) {
          bubble = document.createElement('div');
          bubble.id = 'otNotifyBubble';
          bubble.classList.add('ot-notify-bubble');

          const old = document.querySelector('.ot-notify-bubble:not(#otNotifyBubble)');
          if (old) old.remove();

          // 樣式設定
          bubble.style.position = 'fixed';
          bubble.style.padding = '12px 24px';
          bubble.style.borderRadius = '12px';
          bubble.style.color = '#fff';
          bubble.style.fontWeight = '500';
          bubble.style.boxShadow = '0 8px 24px rgba(0,0,0,0.25)';
          bubble.style.zIndex = '9999';
          bubble.style.backdropFilter = 'blur(10px)';
          bubble.style.webkitBackdropFilter = 'blur(10px)';
          bubble.style.transition = 'all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
          bubble.style.opacity = '0';
          bubble.style.pointerEvents = 'none';
          bubble.style.whiteSpace = 'pre-wrap'; /* Support multiline text */
          bubble.style.textAlign = 'left';      /* Align text to left for list */
          bubble.style.lineHeight = '1.5';
          bubble.style.left = '50%';
          bubble.style.top = '50%';
          bubble.style.transform = 'translate(-50%, -50%)';
          bubble.style.maxWidth = '320px';

          document.body.appendChild(bubble);
        }

        if (isError) {
          bubble.style.background = 'rgba(255, 59, 48, 0.9)';
        } else {
          bubble.style.background = 'rgba(0, 0, 0, 0.8)';
        }

        bubble.textContent = message;
        document.body.appendChild(bubble);

        // 定位計算
        const logoCard = document.querySelector('.logo-card');
        if (logoCard) {
          const rect = logoCard.getBoundingClientRect();
          bubble.style.left = rect.left + 'px';
          bubble.style.width = rect.width + 'px'; // 與 Logo 同寬
          bubble.style.boxSizing = 'border-box'; // 確保 padding 不撐大
          bubble.style.textAlign = 'center';

          // 初始位置：在 Logo 底部上方一點（隱藏狀態）
          const startTop = rect.bottom - 20;
          const endTop = rect.bottom + 10;

          bubble.style.top = endTop + 'px';
          bubble.style.transform = `translateY(-${endTop - startTop}px) scale(0.9)`;

          // 觸發重繪
          requestAnimationFrame(() => {
            bubble.style.opacity = '1';
            bubble.style.transform = 'translateY(0) scale(1)';
          });
        } else {
          // Fallback: 置中顯示
          bubble.style.top = '20px';
          bubble.style.left = '50%';
          bubble.style.transform = 'translateX(-50%) translateY(-20px)';
          requestAnimationFrame(() => {
            bubble.style.opacity = '1';
            bubble.style.transform = 'translateX(-50%) translateY(0)';
          });
        }

        // 自動消失
        setTimeout(() => {
          bubble.style.opacity = '0';
          bubble.style.transform = 'translateY(-20px) scale(0.9)'; // 向上收回
          setTimeout(() => bubble.remove(), 400);
        }, 3000);
      }

      // 同步 Travel Toggle UI（新增列上的 Travel 按鈕）
      function syncTravelToggleUI() {
        const travelToggleBtn = document.getElementById('travelToggle');
        if (travelToggleBtn) {
          if (newRowTravelEnabled) {
            travelToggleBtn.classList.add('on');
          } else {
            travelToggleBtn.classList.remove('on');
          }
        }
      }

      // --- OT Calculation Logic (Time-Based) ---
      const OT_RULES = {
        weekday: { offTime: 17.5, break: 0 }, // 17:30
        weekend: { startTime: 8.0, breakStart: 12.0, breakEnd: 13.5 }
      };

      /**
    * Calculate OT hours based on End Time and Date
    * @param {number} h - Hour (0-23)
    * @param {number} m - Minute (0-59)
    * @param {string} dateStr - YYYY-MM-DD
    * @param {boolean} isHoliday - Manually toggled National Holiday
    */
      function calculateOvertime(h, m, dateStr, isHoliday = false) {
        // Defensive checks for NaN
        if (isNaN(h) || isNaN(m)) {
          console.warn('[OT] calculateOvertime called with NaN values:', h, m);
          return { v134: 0, v167: 0, v166: 0, v267: 0, total: 0 };
        }
        const date = parseDateSafe(dateStr);
        const isWeekend = (date.getDay() === 0 || date.getDay() === 6); // Sat or Sun
        const timeVal = h + (m / 60);

        let v134 = 0, v167 = 0, v267 = 0; // v267 is effectively 2.67 rate OR holiday 2.0 bucket if we misuse it?
        // User requested: "Database columns c/d/e/f originally 1.67/1.34/1.66/2.67. 
        // I have merged 1.66 into 1.67, and changed 1.66 to 2 (Holiday 1x + 1x = 2x total for first 8h)."
        // So: 
        // v167 field -> 1.67x
        // v134 field -> 1.34x
        // v166 field -> 2.0x (National Holiday First 8h)
        // v267 field -> 2.67x (Weekend >8h)

        // Wait, let's map strictly to what user asked: 
        // "前8小時給付1倍薪資(共2倍)，超過部分按平日加班費率（9-10小時 1.34倍，11-12小時 1.67倍）加給"
        // So Holiday:
        // 0-8h: 1x (Total 2x) -> Map to v166 (renamed concept to v200 internally or just use v166 slot)
        // 8-10h: 1.34x -> Map to v134
        // 10h+: 1.67x -> Map to v167

        const mults = getOTMultipliers();

        if (isHoliday) {
          // ...規則與平日相同部分保持不變，但使用變量...
          let workDuration = 0;
          const start = OT_RULES.weekend.startTime;
          const bStart = OT_RULES.weekend.breakStart;
          const bEnd = OT_RULES.weekend.breakEnd;

          if (timeVal <= start) workDuration = 0;
          else if (timeVal <= bStart) workDuration = timeVal - start;
          else if (timeVal <= bEnd) workDuration = bStart - start;
          else workDuration = (bStart - start) + (timeVal - bEnd);

          if (workDuration > 0) {
            const v200Hours = Math.min(8, workDuration);
            const rem = Math.max(0, workDuration - 8);
            const v134Hours = Math.min(2, rem);
            const v167Hours = Math.max(0, rem - 2);
            return { v134: v134Hours, v167: v167Hours, v166: v200Hours, v267: 0, total: (v134Hours + v167Hours + v200Hours) };
          }
          return { v134: 0, v167: 0, v166: 0, v267: 0, total: 0 };

        } else if (isWeekend) {
          let workDuration = 0;
          const start = OT_RULES.weekend.startTime;
          const bStart = OT_RULES.weekend.breakStart;
          const bEnd = OT_RULES.weekend.breakEnd;

          if (timeVal <= start) workDuration = 0;
          else if (timeVal <= bStart) workDuration = timeVal - start;
          else if (timeVal <= bEnd) workDuration = bStart - start;
          else workDuration = (bStart - start) + (timeVal - bEnd);

          if (workDuration > 0) {
            v134 = Math.min(2, workDuration);
            const rem1 = Math.max(0, workDuration - 2);
            v167 = Math.min(6, rem1);
            v267 = Math.max(0, rem1 - 6);
          }
          return { v134, v167, v267, v166: 0, total: workDuration };
        } else {
          let effectiveTime = timeVal;
          if (effectiveTime < 6) effectiveTime += 24;
          const otDuration = effectiveTime - OT_RULES.weekday.offTime;
          if (otDuration > 0) {
            v134 = Math.min(2, otDuration);
            v167 = Math.max(0, otDuration - 2);
          }
          return { v134, v167, v267: 0, v166: 0, total: (v134 + v167) };
        }
      }

      /**
       * Reverse calculate End Time from existing OT data
       * Used for recreating HH:MM state from loaded data
       */
      function getReverseTime(entry) {
        // Check if we have explicit endTime stored
        const explicitTime = normalizeTime(entry.endTime);
        if (explicitTime) {
          const [h, m] = explicitTime.split(':').map(Number);
          if (!isNaN(h) && !isNaN(m)) {
            return { h, m };
          }
        }

        // Otherwise derive from OT hours
        const date = parseDateSafe(entry.date);
        const isWeekend = (date.getDay() === 0 || date.getDay() === 6);
        const isHoliday = !!entry.isHoliday;
        const v134 = safeParseFloat(entry.v134);
        const v167 = safeParseFloat(entry.v167);
        const v267 = safeParseFloat(entry.v267);
        const v166 = safeParseFloat(entry.v166);
        const otSum = v134 + v167 + v267 + v166;

        let timeVal = 0;

        if (isHoliday || isWeekend) {
          // Holiday or Weekend: Reverse work duration
          // For Holidays, otSum includes the first 8h. For Weekends, it depends on start time.
          // Actually, let's treat BOTH as 8:00 start + sum of hours (including break if > 4h)
          if (otSum <= 4) {
            timeVal = OT_RULES.weekend.startTime + otSum;
          } else {
            timeVal = OT_RULES.weekend.breakEnd + (otSum - 4);
          }
        } else {
          // Normal Weekday: 17.5 + OT
          timeVal = OT_RULES.weekday.offTime + otSum;
        }

        // If timeVal is NaN for some reason, fallback to default
        if (isNaN(timeVal)) {
          timeVal = OT_RULES.weekday.offTime;
        }

        // Convert decimal to H:M (Round to nearest 10m)
        let h = Math.floor(timeVal);
        let m = Math.round((timeVal - h) * 60);

        // Snap to 10m
        m = Math.round(m / 10) * 10;
        if (m === 60) { h++; m = 0; }

        // Fix edges: Allow up to 30.0 (6 AM) for internal tracking, but usually h % 24 for display
        h = h % 24;
        return { h, m };
      }

      function renderCapsuleSelector(options, currentValue, onSelect) {
        const container = document.createElement('div');
        container.className = 'capsule-container';

        const toggle = document.createElement('button');
        toggle.className = 'capsule-toggle';
        toggle.textContent = currentValue || '請選擇';
        container.appendChild(toggle);

        const popup = document.createElement('div');
        popup.className = 'capsule-popup';

        options.forEach(opt => {
          const optionEl = document.createElement('div');
          optionEl.className = 'capsule-option';
          const isSelected = (opt.value === currentValue || opt === currentValue);
          if (isSelected) optionEl.classList.add('selected');
          optionEl.textContent = opt.label || opt;
          optionEl.onclick = (e) => {
            e.stopPropagation();
            onSelect(opt.value || opt);
            toggle.textContent = opt.label || opt;
            popup.classList.remove('open');
            toggle.classList.remove('active');
          };
          popup.appendChild(optionEl);
        });
        container.appendChild(popup);

        toggle.onclick = (e) => {
          e.stopPropagation();
          const isOpen = popup.classList.contains('open');

          // Close other open popups
          document.querySelectorAll('.capsule-popup.open').forEach(p => {
            if (p !== popup) {
              p.classList.remove('open');
              p.previousElementSibling.classList.remove('active');
            }
          });

          popup.classList.toggle('open');
          toggle.classList.toggle('active');

          if (!isOpen) {
            // Scroll selected into view after opening
            setTimeout(() => {
              const selected = popup.querySelector('.capsule-option.selected');
              if (selected) {
                selected.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
              }
            }, 50);
          }
        };

        // Close on outside click
        const closeHandler = (e) => {
          if (!container.contains(e.target)) {
            popup.classList.remove('open');
          }
        };
        document.addEventListener('click', closeHandler);

        return container;
      }

      // 渲染資料列表 (Material Design 3 Card List with Calendar View & Month Grouping)
      let openCardId = null;
      let monthsToShowRequested = 1;
      function renderDataList(targetId = null) {
        if (targetId) openCardId = targetId;
        const container = document.getElementById('tableContainer');
        container.innerHTML = '';

        // 添加桌面版星期標題 (只顯示一次)
        if (window.innerWidth >= 1024) {
          const header = document.createElement('div');
          header.classList.add('calendar-header');
          ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
            const el = document.createElement('div');
            el.classList.add('calendar-weekday-label');
            el.textContent = day;
            header.appendChild(el);
          });
          const existingHeader = document.querySelector('.calendar-header');
          if (existingHeader) existingHeader.remove();
          container.parentNode.insertBefore(header, container);
        }

        // 若尚未載入任何資料，渲染空狀態卡片
        if (tableData.length === 0) {
          const payload = window.__OT_INIT_PAYLOAD__;
          const errorMsg = payload && payload.error ? payload.error : '';
          const isLocal = window.location.protocol === 'file:';

          const card = document.createElement('div');
          card.classList.add('data-card');
          card.style.textAlign = 'center';
          card.style.padding = '32px';
          card.style.cursor = 'pointer';
          card.style.display = 'flex';
          card.style.flexDirection = 'column';
          card.style.alignItems = 'center';
          card.style.justifyContent = 'center';
          if (window.innerWidth >= 1024) card.style.gridColumn = '1 / -1';

          const statusIcon = errorMsg ? 'error' : (isLocal ? 'developer_mode' : 'upload_file');
          const statusTitle = errorMsg ? 'Data Loading Error' : (isLocal ? 'Development Mode' : 'No Data Available');
          const statusDesc = errorMsg ? `Error: ${errorMsg}` : (isLocal ? 'Local mock data loaded. Connect to GAS for live data.' : 'Tap here to import CSV or add a new entry above');

          card.innerHTML = `
          <div style="color: ${errorMsg ? 'var(--color-danger)' : 'var(--md-sys-color-primary)'}; margin-bottom: 16px;">
            <span class="material-symbols-outlined" style="font-size: 48px;">${statusIcon}</span>
          </div>
          <div style="font: var(--md-sys-typescale-title-medium); margin-bottom: 8px;">${statusTitle}</div>
          <div style="font: var(--md-sys-typescale-body-medium); color: var(--md-sys-color-on-surface-variant); max-width: 250px;">
            ${statusDesc}
          </div>
        `;

          card.addEventListener('click', () => {
            if (!errorMsg) {
              const importInput = document.getElementById('importCSVCard');
              if (importInput) importInput.click();
            }
          });

          container.appendChild(card);
          updateDashboard();
          return;
        }

        // 1. 先按月份「由新至舊」排序，但月分內日期「由舊至新」排 (Calendar consistency)
        // 用原始 index 追蹤，確保 UI 異動能正確回流到 tableData
        const sortedEntries = tableData.map((e, idx) => {
          e.originalIndex = idx;
          return e;
        }).sort((a, b) => {
          const dA = parseDateSafe(a.date);
          const dB = parseDateSafe(b.date);
          const monthA = dA.getFullYear() * 12 + dA.getMonth();
          const monthB = dB.getFullYear() * 12 + dB.getMonth();
          if (monthA !== monthB) return monthB - monthA; // 月份由新到舊
          return dA - dB; // 日期由舊到新
        });

        let lastMonthKey = '';

        // Pre-calculate Monthly Totals
        const monthlyOTMap = {};
        const monthlyTravelMap = {}; // New: Trave summary
        const monthSalaryMap = {};
        tableData.forEach(entry => {
          const d = parseDateSafe(entry.date);
          const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;

          if (!monthlyOTMap[key]) monthlyOTMap[key] = 0;
          monthlyOTMap[key] += (Number(entry.otSalary) || 0);

          if (!monthlyTravelMap[key]) monthlyTravelMap[key] = 0;
          monthlyTravelMap[key] += (Number(entry.travel) || 0);

          if (entry.monthSLR) {
            const val = parseFloat(entry.monthSLR);
            if (val > 0) monthSalaryMap[key] = val;
          }
        });

        console.log('[OT] Redrawing data list with', tableData.length, 'entries');
        let renderedMonthsSet = new Set();
        let currentMonthGroup = null;
        let globalIndex = 0;
        sortedEntries.forEach((entry, displayIdx) => {
          const index = entry.originalIndex;
          globalIndex++;
          // Month Grouping Logic
          const dateObj = parseDateSafe(entry.date);
          const currentMonthKey = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}`;

          if (!renderedMonthsSet.has(currentMonthKey)) {
            if (renderedMonthsSet.size >= monthsToShowRequested) return;
            renderedMonthsSet.add(currentMonthKey);
          }
          if (currentMonthKey !== lastMonthKey) {
            const monthHeader = document.createElement('div');
            monthHeader.classList.add('month-header');
            // monthHeader.classList.add('expand-wrapper'); // REMOVED: Headers should not be expand-wrappers themselves
            // Add data key for real-time updates
            monthHeader.dataset.monthKey = currentMonthKey;
            const isFirstMonth = (lastMonthKey === '');
            if (isFirstMonth) monthHeader.classList.add('open');
            monthHeader.style.cursor = 'pointer'; // Clickable
            monthHeader.title = "Click to toggle month view";

            const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];

            // Left: Title + Collapse Icon
            const leftWrapper = document.createElement('div');
            leftWrapper.style.display = 'flex';
            leftWrapper.style.alignItems = 'center';
            leftWrapper.style.gap = '8px';

            const expandIcon = document.createElement('span');
            expandIcon.classList.add('material-symbols-outlined');
            expandIcon.textContent = 'expand_more';
            expandIcon.style.transition = 'transform 0.2s';

            const title = document.createElement('span');
            title.textContent = `${monthNames[dateObj.getMonth()]} ${dateObj.getFullYear()} `;

            // 3. Contribution Calendar (Mini-grid)
            const monthEntries = tableData.filter(e => {
              if (!e.date) return false;
              const d = parseDateSafe(e.date);
              const mKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
              return mKey === currentMonthKey;
            });
            console.log(`[OT] Month ${currentMonthKey} has ${monthEntries.length} entries for grid`);

            const gridWrapper = document.createElement('div');
            gridWrapper.style.marginLeft = '12px'; // Gap from title
            gridWrapper.appendChild(renderContributionCalendar(currentMonthKey, monthEntries));

            leftWrapper.appendChild(title);
            leftWrapper.appendChild(gridWrapper); // Insert grid next to title
            leftWrapper.appendChild(expandIcon);

            // Right: Chips (OT Total + Salary)
            const rightWrapper = document.createElement('div');
            rightWrapper.style.display = 'flex';
            rightWrapper.style.gap = '8px';
            rightWrapper.style.alignItems = 'center';
            rightWrapper.style.paddingRight = '12px'; // Extra padding requested

            // 1. Monthly Travel Total (Blue)
            const travelTotalVal = Math.round(monthlyTravelMap[currentMonthKey] || 0);
            const travelChip = document.createElement('div');
            travelChip.classList.add('info-chip', 'blue', 'travel-chip');
            travelChip.innerHTML = `<span class="material-symbols-outlined" style="font-size: 1.1rem;">flight</span> <span class="privacy-hidden">${travelTotalVal}</span>`;

            // 2. Monthly OT Total (Yellow)
            const otTotalVal = Math.round(monthlyOTMap[currentMonthKey] || 0);
            const otChip = document.createElement('div');
            otChip.classList.add('info-chip', 'yellow', 'ot-chip');
            otChip.innerHTML = `<span class="material-symbols-outlined" style="font-size: 1.1rem;">more_time</span> <span class="privacy-hidden">+${otTotalVal}</span>`;

            // 3. Monthly Salary (Original)
            const salaryChip = document.createElement('div');
            salaryChip.classList.add('info-chip', 'salary-chip');
            salaryChip.style.background = '#fff9c4';
            salaryChip.style.color = '#5f5200';
            salaryChip.innerHTML = `<span class="material-symbols-outlined" style="font-size: 1.1rem;">monetization_on</span> <span class="privacy-hidden">${Math.round(monthSalaryMap[currentMonthKey] || 0)}</span>`;

            rightWrapper.appendChild(travelChip);
            rightWrapper.appendChild(otChip);
            rightWrapper.appendChild(salaryChip);

            monthHeader.appendChild(leftWrapper);
            monthHeader.appendChild(rightWrapper);
            container.appendChild(monthHeader);

            // Create Group Container (Wrapper)
            const thisMonthGroup = document.createElement('div');
            thisMonthGroup.classList.add('month-group', 'expand-wrapper');
            if (isFirstMonth) thisMonthGroup.classList.add('open');
            container.appendChild(thisMonthGroup);

            // Create Inner Grid/Content Container
            const innerGroup = document.createElement('div');
            innerGroup.classList.add('expand-inner');
            thisMonthGroup.appendChild(innerGroup);

            // Update global tracker for card appending
            currentMonthGroup = innerGroup; // Cards go into inner

            // Toggle Logic (Reference thisMonthGroup wrapper)
            monthHeader.addEventListener('click', () => {
              // Toggle class '.open'
              thisMonthGroup.classList.toggle('open');
              const isOpen = thisMonthGroup.classList.contains('open');
              expandIcon.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(-90deg)';
            });
            // Set initial rotation
            expandIcon.style.transform = isFirstMonth ? 'rotate(0deg)' : 'rotate(-90deg)';

            lastMonthKey = currentMonthKey;
          }

          const card = document.createElement('div');
          card.classList.add('data-card', 'fade-in-up');
          const cardUniqueId = entry.__id || entry.date;
          card.style.animationDelay = `${globalIndex * 0.05}s`;
          if (openCardId === cardUniqueId) card.classList.add('expanded');

          // Desktop Calendar Alignment
          if (window.innerWidth >= 1024) {
            // Use Date object for reliable day index (0=Sun -> 1, 6=Sat -> 7)
            const col = dateObj.getDay() + 1;
            card.style.gridColumn = `${col} / span 1`;
          }

          // --- Header (Card Content) ---
          const header = document.createElement('div');
          header.classList.add('card-header');
          // Sunday Style Logic (Apply to CARD, not just header)
          if (dateObj.getDay() === 0) {
            card.classList.add('sunday');
          }

          // Primary Info: Date & Scoreboard
          const primaryInfo = document.createElement('div');
          primaryInfo.classList.add('card-primary-info');

          const dateWrapper = document.createElement('div');
          dateWrapper.classList.add('card-date-wrapper');

          const dd = String(dateObj.getDate()).padStart(2, '0');

          const dateDay = document.createElement('span');
          dateDay.classList.add('date-day');
          dateDay.textContent = dd;

          const dateWeekday = document.createElement('span');
          dateWeekday.classList.add('date-weekday');
          // Dynamic locale-independent weekday for display (e.g. 'Sun', 'Mon')
          dateWeekday.textContent = dateObj.toLocaleDateString('en-US', { weekday: 'short' });

          dateWrapper.appendChild(dateDay);
          dateWrapper.appendChild(dateWeekday);

          // OT Scoreboard Badge
          const otTotal = entry.totalOtHoursNumeric || (Number(entry.v167 || 0) + Number(entry.v134 || 0) + Number(entry.v166 || 0) + Number(entry.v267 || 0));
          const val = otTotal.toFixed(1); // One decimal precision

          const scoreboard = document.createElement('div');
          scoreboard.classList.add('scoreboard-badge');

          // Color Logic
          const numericVal = parseFloat(val);
          if (numericVal >= 2 && numericVal < 3) scoreboard.classList.add('emerald');
          else if (numericVal >= 3 && numericVal < 4) scoreboard.classList.add('blue');
          else if (numericVal >= 4 && numericVal < 5) scoreboard.classList.add('amber');
          else if (numericVal >= 5) scoreboard.classList.add('crimson');

          scoreboard.textContent = val;

          primaryInfo.appendChild(dateWrapper);
          primaryInfo.appendChild(scoreboard);

          // Secondary Info: Salary & Daily OT
          const secondaryInfo = document.createElement('div');
          secondaryInfo.classList.add('card-secondary-info');



          // Daily OT Salary
          const dailyTotalChip = document.createElement('div');
          dailyTotalChip.classList.add('info-chip', 'yellow', 'daily-total-chip'); // Added yellow class and specific class
          dailyTotalChip.id = `chip-daily-${index}`;
          dailyTotalChip.innerHTML = `<span class="privacy-hidden">+${Math.round(entry.total)}</span>`;

          // Travel Icon (Compact)
          const travelChip = document.createElement('div');
          travelChip.classList.add('info-chip', 'travel-chip');
          travelChip.id = `chip-travel-${index}`;

          // Ensure getCountryAbbr is reachable or define it locally if needed
          const countryCode = (typeof getCountryAbbr === 'function')
            ? getCountryAbbr(entry.travelCountry)
            : (entry.travelCountry && entry.travelCountry !== 'None' ? entry.travelCountry.slice(0, 2).toUpperCase() : '--');

          if (entry.travelCountry && entry.travelCountry !== 'None') {
            travelChip.classList.add('active'); // Blue background style
            travelChip.innerHTML = `<span>${countryCode}</span>`;
          } else {
            travelChip.innerHTML = `<span>--</span>`;
          }

          // secondaryInfo.appendChild(salaryChip); // Removed from card
          secondaryInfo.appendChild(dailyTotalChip);
          secondaryInfo.appendChild(travelChip);

          const expandIcon = document.createElement('span');
          expandIcon.classList.add('material-symbols-outlined', 'card-expand-icon');
          expandIcon.textContent = 'expand_more';

          header.appendChild(primaryInfo);
          header.appendChild(secondaryInfo);
          header.appendChild(expandIcon);

          // --- Body (Collapsible Wrapper) ---
          const bodyWrapper = document.createElement('div');
          bodyWrapper.className = 'expand-wrapper';
          if (openCardId === entry.date) bodyWrapper.classList.add('open');

          const body = document.createElement('div');
          body.classList.add('card-body', 'expand-inner');
          body.style.padding = '8px 16px'; // Reduced padding for shorter look

          // Hours Grid (Time Input: Hour & Minute)
          const grid = document.createElement('div');
          grid.classList.add('hours-grid');
          // Override grid layout for 2 columns (Hour, Min)
          grid.style.gridTemplateColumns = 'repeat(2, 1fr)';
          grid.style.maxWidth = '200px';
          grid.style.margin = '0 auto 12px auto';

          // Initial Time
          const { h, m } = getReverseTime(entry);
          let currH = h;
          let currM = m;

          // Helper to update Entry & UI
          // Helper to update Entry & UI
          const updateTimeCalc = () => {
            // Update Entry Time String
            entry.endTime = `${String(currH).padStart(2, '0')}:${String(currM).padStart(2, '0')}`;

            // Calculate OT
            const res = calculateOvertime(currH, currM, entry.date, entry.isHoliday); // Pass isHoliday
            entry.v134 = res.v134;
            entry.v167 = res.v167;
            entry.v267 = res.v267;
            entry.v166 = res.v166; // Update v166 for holiday
            entry.totalOtHoursNumeric = res.total; // Consistent with Scoreboard

            // Update Local Card UI (Badge & Chips)
            // Scoreboard
            const otTotal = res.total;
            const val = otTotal.toFixed(1);
            if (scoreboard) {
              scoreboard.textContent = val;
              scoreboard.className = 'scoreboard-badge'; // Reset
              const numericVal = parseFloat(val);
              if (numericVal >= 2 && numericVal < 3) scoreboard.classList.add('green');
              else if (numericVal >= 3 && numericVal < 4) scoreboard.classList.add('yellow');
              else if (numericVal >= 4 && numericVal < 5) scoreboard.classList.add('orange');
              else if (numericVal >= 5 && numericVal < 6) scoreboard.classList.add('red');
              else if (numericVal >= 6) scoreboard.classList.add('purple');
            }

            /* 
               Fix: Call updateAll with skipRender=true to prevent destroying the DOM 
               and causing the card to "collapse" (reset to closed state).
            */
            updateAll(entry.date, true);

            // Daily Total Chip
            const dailyChip = document.getElementById(`chip-daily-${index}`);
            if (dailyChip) {
              dailyChip.innerHTML = `<span class="privacy-hidden">+${Math.round(entry.total || 0)}</span>`;
            }
          };

          // --- Hour Stepper ---
          const hourItem = document.createElement('div');
          hourItem.classList.add('hour-item');

          const hourLabel = document.createElement('div');
          hourLabel.classList.add('hour-label');
          hourLabel.textContent = 'Hour';

          const hourStepper = document.createElement('div');
          hourStepper.classList.add('smart-stepper');
          hourStepper.dataset.entryIndex = index;
          hourStepper.dataset.key = 'vH';
          if (currH >= 0) hourStepper.classList.add('has-value');
          hourStepper.textContent = String(currH).padStart(2, '0');

          // --- Minute Stepper ---
          const minItem = document.createElement('div');
          minItem.classList.add('hour-item');

          const minLabel = document.createElement('div');
          minLabel.classList.add('hour-label');
          minLabel.textContent = 'Min';

          const minStepper = document.createElement('div');
          minStepper.classList.add('smart-stepper');
          minStepper.dataset.entryIndex = index;
          minStepper.dataset.key = 'vM';
          if (currM >= 0) minStepper.classList.add('has-value');
          minStepper.textContent = String(currM).padStart(2, '0');

          const moveHDrag = (y) => {
            if (!hDrag) return;
            const delta = Math.floor((hDrag.startY - y) / 10);
            let newVal = (hDrag.startVal + delta) % 24;
            if (newVal < 0) newVal += 24;
            if (newVal !== currH) {
              currH = newVal;
              hourStepper.textContent = String(newVal).padStart(2, '0');
              updateTimeCalc();
            }
          };
          const endHDrag = () => {
            if (hDrag) {
              hourStepper.classList.remove('active');
              hDrag = null;
            }
          };

          const onHMove = (e) => moveHDrag(e.clientY);
          const textHMouseUp = () => {
            endHDrag();
            document.removeEventListener('mousemove', onHMove);
            document.removeEventListener('mouseup', textHMouseUp);
          };

          hourStepper.addEventListener('mousedown', (e) => {
            e.preventDefault();
            hDrag = { startY: e.clientY, startVal: currH };
            hourStepper.classList.add('active');
            document.addEventListener('mousemove', onHMove);
            document.addEventListener('mouseup', textHMouseUp);
          });

          const onHTouchMove = (e) => moveHDrag(e.touches[0].clientY);
          const touchHEnd = () => {
            endHDrag();
            document.removeEventListener('touchmove', onHTouchMove);
            document.removeEventListener('touchend', touchHEnd);
          };

          hourStepper.addEventListener('touchstart', (e) => {
            e.preventDefault();
            hDrag = { startY: e.touches[0].clientY, startVal: currH };
            hourStepper.classList.add('active');
            document.addEventListener('touchmove', onHTouchMove, { passive: false });
            document.addEventListener('touchend', touchHEnd);
          });

          // Min Drag
          const moveMDrag = (y) => {
            if (!mDrag) return;
            const steps = Math.floor((mDrag.startY - y) / 10);
            let newVal = (mDrag.startVal + (steps * 10)) % 60;
            if (newVal < 0) newVal += 60;
            if (newVal !== currM) {
              currM = newVal;
              minStepper.textContent = String(newVal).padStart(2, '0');
              updateTimeCalc();
            }
          };
          const endMDrag = () => {
            if (mDrag) {
              minStepper.classList.remove('active');
              mDrag = null;
            }
          };

          const onMMove = (e) => moveMDrag(e.clientY);
          const textMMouseUp = () => {
            endMDrag();
            document.removeEventListener('mousemove', onMMove);
            document.removeEventListener('mouseup', textMMouseUp);
          };

          minStepper.addEventListener('mousedown', (e) => {
            e.preventDefault();
            mDrag = { startY: e.clientY, startVal: currM };
            minStepper.classList.add('active');
            document.addEventListener('mousemove', onMMove);
            document.addEventListener('mouseup', textMMouseUp);
          });

          const onMTouchMove = (e) => moveMDrag(e.touches[0].clientY);
          const touchMEnd = () => {
            endMDrag();
            document.removeEventListener('touchmove', onMTouchMove);
            document.removeEventListener('touchend', touchMEnd);
          };

          minStepper.addEventListener('touchstart', (e) => {
            e.preventDefault();
            mDrag = { startY: e.touches[0].clientY, startVal: currM };
            minStepper.classList.add('active');
            document.addEventListener('touchmove', onMTouchMove, { passive: false });
            document.addEventListener('touchend', touchMEnd);
          });

          hourItem.appendChild(hourLabel);
          hourItem.appendChild(hourStepper);
          grid.appendChild(hourItem);

          minItem.appendChild(minLabel);
          minItem.appendChild(minStepper);
          grid.appendChild(minItem);

          // Create Icon Toggle Row (Holiday & Travel)
          const iconToggleRow = document.createElement('div');
          iconToggleRow.classList.add('icon-toggle-row');
          iconToggleRow.style.display = 'flex';
          iconToggleRow.style.gap = '12px';
          iconToggleRow.style.marginTop = '12px';
          iconToggleRow.style.justifyContent = 'center';

          // Holiday Icon Button
          const holidayBtn = document.createElement('div');
          holidayBtn.classList.add('circular-toggle-btn');
          holidayBtn.style.width = '44px';
          holidayBtn.style.height = '44px';
          holidayBtn.style.borderRadius = '12px';
          holidayBtn.style.display = 'flex';
          holidayBtn.style.alignItems = 'center';
          holidayBtn.style.justifyContent = 'center';
          holidayBtn.style.cursor = 'pointer';
          holidayBtn.style.background = entry.isHoliday ? 'rgba(255, 149, 0, 0.15)' : 'rgba(0,0,0,0.05)';
          holidayBtn.style.transition = 'all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)';

          const holidayIcon = document.createElement('span');
          holidayIcon.classList.add('material-symbols-outlined');
          holidayIcon.textContent = entry.isHoliday ? 'holiday_village' : 'event_busy';
          holidayIcon.style.fontSize = '24px';
          holidayIcon.style.color = entry.isHoliday ? 'var(--color-warning)' : 'rgba(0,0,0,0.4)';

          holidayBtn.appendChild(holidayIcon);

          holidayBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            entry.isHoliday = !entry.isHoliday;
            updateTimeCalc();
            renderDataList(index);
          });

          // Leave Icon Button (New)
          const leaveBtn = document.createElement('div');
          leaveBtn.classList.add('circular-toggle-btn', 'leave');
          if (entry.isLeave) leaveBtn.classList.add('active');
          leaveBtn.style.width = '38px'; // Slightly smaller to fit 3 in a row
          leaveBtn.style.height = '38px';
          leaveBtn.style.borderRadius = '10px';
          leaveBtn.style.display = 'flex';
          leaveBtn.style.alignItems = 'center';
          leaveBtn.style.justifyContent = 'center';
          leaveBtn.style.cursor = 'pointer';
          leaveBtn.style.background = entry.isLeave ? 'rgba(186, 26, 26, 0.15)' : 'rgba(0,0,0,0.05)';
          leaveBtn.style.transition = 'all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)';

          const leaveIcon = document.createElement('span');
          leaveIcon.classList.add('material-symbols-outlined');
          leaveIcon.textContent = entry.isLeave ? 'person_off' : 'person';
          leaveIcon.style.fontSize = '24px';
          leaveIcon.style.color = entry.isLeave ? '#ba1a1a' : 'rgba(0,0,0,0.4)';
          leaveBtn.appendChild(leaveIcon);

          // Leave Details UI (inside footer or body?)
          // Let's create a dedicated section for leave details in the card body if isLeave is true
          if (entry.isLeave) {
            const wrapper = document.createElement('div');
            wrapper.className = 'expandable-wrapper expanded'; // Standard expanded state for existing records
            const content = document.createElement('div');
            content.className = 'expandable-content';

            const leaveDetail = document.createElement('div');
            leaveDetail.style.display = 'flex';
            leaveDetail.style.flexDirection = 'column';
            leaveDetail.style.gap = '8px';
            leaveDetail.style.paddingTop = '8px';
            leaveDetail.style.width = '100%';

            const types = [
              '特休', '事假', '病假', '公假', '婚假', '公傷假', '喪假',
              '有薪產假', '無薪產假', '補休', '產檢假', '陪產檢及陪產假',
              '駐地休假', '生理假', '家庭照顧假', '住院病假', '健檢假'
            ];
            const typeSelector = renderCapsuleSelector(types, entry.leaveType, (val) => {
              entry.leaveType = val;
              updateAll(index);
            });

            const amts = [
              { value: 1, label: '1.0 天' }, { value: 0.5, label: '0.5 天' }, { value: 0.125, label: '1 小時' }, { value: 0.25, label: '2 小時' }, { value: 0.375, label: '3 小時' }, { value: 0.5, label: '4 小時' }
            ];
            const amtSelector = renderCapsuleSelector(amts, entry.leaveAmount, (val) => {
              entry.leaveAmount = parseFloat(val);
              updateAll(index);
            });
            const amtToggle = amtSelector.querySelector('.capsule-toggle');
            const currentAmt = amts.find(a => a.value == entry.leaveAmount);
            if (amtToggle && currentAmt) amtToggle.textContent = currentAmt.label;

            leaveDetail.appendChild(typeSelector);
            leaveDetail.appendChild(amtSelector);
            content.appendChild(leaveDetail);
            wrapper.appendChild(content);
            body.appendChild(wrapper);

            // Trigger expansion after append if it was just toggled (hard to detect here, but updateAll(index) handles it)
          }

          leaveBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            entry.isLeave = !entry.isLeave;
            if (entry.isLeave && !entry.leaveType) {
              entry.leaveType = '特休';
              entry.leaveAmount = 1;
            }
            updateAll(index);
          });
          // Travel Icon Button
          const travelBtn = document.createElement('div');
          travelBtn.classList.add('circular-toggle-btn');
          travelBtn.style.width = '38px';
          travelBtn.style.height = '38px';
          travelBtn.style.borderRadius = '10px';
          travelBtn.style.display = 'flex';
          travelBtn.style.alignItems = 'center';
          travelBtn.style.justifyContent = 'center';
          travelBtn.style.cursor = 'pointer';
          travelBtn.style.position = 'relative'; // For badge
          const travels = ['None', ...Object.keys(getTravelRates())];
          const countryCodes = { 'Vietnam': 'VN', 'China': 'CN', 'India': 'IN', 'None': '' };
          const isTraveling = entry.travelCountry && entry.travelCountry !== 'None';
          travelBtn.style.background = isTraveling ? 'rgba(0, 122, 255, 0.15)' : 'rgba(0,0,0,0.05)';
          travelBtn.style.transition = 'all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)';

          const travelIcon = document.createElement('span');
          travelIcon.classList.add('material-symbols-outlined');
          travelIcon.textContent = 'flight';
          travelIcon.style.fontSize = '24px';
          travelIcon.style.color = isTraveling ? 'var(--color-primary)' : 'rgba(0,0,0,0.4)';

          // Badge for Country Code
          if (isTraveling) {
            const badge = document.createElement('span');
            const code = countryCodes[entry.travelCountry] || (entry.travelCountry ? entry.travelCountry.slice(0, 2).toUpperCase() : '');
            badge.textContent = code;
            badge.style.position = 'absolute';
            badge.style.bottom = '4px';
            badge.style.right = '4px';
            badge.style.fontSize = '8px';
            badge.style.fontWeight = '800';
            badge.style.color = 'var(--color-primary)';
            badge.style.background = 'white';
            badge.style.padding = '1px 2px';
            badge.style.borderRadius = '3px';
            badge.style.lineHeight = '1';
            travelBtn.appendChild(badge);
          }

          travelBtn.appendChild(travelIcon);

          travelBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const currentIdx = travels.indexOf(entry.travelCountry || 'None');
            const nextIdx = (currentIdx + 1) % travels.length;
            entry.travelCountry = travels[nextIdx];

            // Fix: Call updateAll(index) to recalculate travel amount and update UI immediately
            updateAll(index);
          });

          holidayBtn.style.width = '38px';
          holidayBtn.style.height = '38px';
          holidayBtn.style.borderRadius = '10px';

          iconToggleRow.appendChild(holidayBtn);
          iconToggleRow.appendChild(leaveBtn);
          iconToggleRow.appendChild(travelBtn);
          body.appendChild(iconToggleRow);

          // Footer
          const footer = document.createElement('div');
          footer.classList.add('card-footer');

          const remark = document.createElement('div');
          remark.classList.add('remark-text');
          remark.contentEditable = "true";
          remark.style.cursor = "text";
          remark.style.outline = "none";
          remark.style.padding = "4px 8px";
          remark.style.borderRadius = "8px";
          remark.style.background = "rgba(0,0,0,0.03)";
          remark.textContent = entry.remark || 'No remarks';
          remark.addEventListener('blur', () => {
            entry.remark = remark.innerText.trim();
            updateAll(index, true); // Update but skip full re-render
          });

          const actions = document.createElement('div');
          actions.classList.add('card-actions');

          const actionBtn = document.createElement('button');
          actionBtn.classList.add('action-btn', 'delete');
          actionBtn.innerHTML = '<span class="material-symbols-outlined">delete</span>';
          actionBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (confirm('確定刪除?')) {
              deleteEntry(index);
            }
          });

          actions.appendChild(actionBtn);
          footer.appendChild(remark);
          footer.appendChild(actions);

          body.appendChild(grid);
          body.appendChild(footer);

          bodyWrapper.appendChild(body); // Add content to wrapper

          card.appendChild(header);
          card.appendChild(bodyWrapper); // Append wrapper to card
          // Append to Current Month Group instead of container directly
          if (currentMonthGroup) {
            currentMonthGroup.appendChild(card);
          } else {
            container.appendChild(card); // Fallback
          }

          // Expansion Logic (Animation)
          header.addEventListener('click', () => {
            if (openCardId === cardUniqueId) {
              openCardId = null;
              bodyWrapper.classList.remove('open');
              card.classList.remove('expanded');
            } else {
              // Close others
              document.querySelectorAll('.data-card.expanded').forEach(c => {
                c.classList.remove('expanded');
                const wrapper = c.querySelector('.expand-wrapper');
                if (wrapper) wrapper.classList.remove('open');
              });

              openCardId = cardUniqueId;
              bodyWrapper.classList.add('open');
              card.classList.add('expanded');
            }
          });
        });
        // Pagination: Load More Button
        const allMonths = Object.keys(monthlyOTMap).sort().reverse();
        if (allMonths.length > renderedMonthsSet.size) {
          const loadMoreRow = document.createElement('div');
          loadMoreRow.style.padding = '32px 0';
          loadMoreRow.style.display = 'flex';
          loadMoreRow.style.justifyContent = 'center';

          const loadMoreBtn = document.createElement('button');
          loadMoreBtn.className = 'promo-action-btn load-more-btn';
          loadMoreBtn.style.padding = '12px 32px';
          loadMoreBtn.style.borderRadius = '24px';
          loadMoreBtn.style.fontWeight = '700';
          loadMoreBtn.innerHTML = `<span>讀取更多 Load More</span><span style="margin-left:8px; opacity:0.6; font-size:0.8rem;">(${allMonths.length - renderedMonthsSet.size} 剩餘)</span>`;
          loadMoreBtn.onclick = () => {
            monthsToShowRequested += 3;
            renderDataList();
          };
          loadMoreRow.appendChild(loadMoreBtn);
          container.appendChild(loadMoreRow);
        }

        updateDashboard();
      }
      /* Logic removed */


      // === 將目前表格資料整理成可寫回 Sheet 的結構 ===
      function buildSheetPayload() {
        const headers = [
          'date',
          'weekday',
          '1.67',
          '1.34',
          '2.0',
          '2.67',
          'OT hr SUM',
          'Base',
          'Travel',
          'OT Salary',
          'Total',
          'Month SLR',
          'Remark',
          'isLeave',
          'isHoliday',
          'travelCountry',
          'endTime',
          'leaveType',
          'leaveAmount'
        ];
        const rows = tableData.map((entry) => [
          entry.date || '',
          entry.weekday || getWeekdayChar(entry.date || ''),
          Number(entry.v167 || 0),
          Number(entry.v134 || 0),
          Number(entry.v166 || 0),
          Number(entry.v267 || 0),
          String(entry.otSum || 0),
          String(entry.base || 0),
          String(entry.travel || 0),
          String(entry.otSalary || 0),
          String(entry.total || 0),
          String(entry.monthSLR || 0),
          entry.remark || '',
          entry.isLeave ? 'TRUE' : 'FALSE',
          entry.isHoliday ? 'TRUE' : 'FALSE',
          entry.travelCountry || 'None',
          entry.endTime || '',
          entry.leaveType || '',
          entry.leaveAmount || 0
        ]);
        return { headers, rows };
      }

      // === 統計用工具函式（方便其他地方重用） ===
      function getTotalRecordCount() {
        return tableData.length;
      }

      function getLatestMonthKey() {
        let latestDate = null;
        tableData.forEach((entry) => {
          if (!entry.date) return;
          const d = parseDateSafe(entry.date);
          if (!latestDate || d > latestDate) {
            latestDate = d;
          }
        });
        if (!latestDate) return '';
        const yyyy = latestDate.getFullYear();
        const mm = String(latestDate.getMonth() + 1).padStart(2, '0');
        return `${yyyy}-${mm}`;
      }

      function getMonthlyTravelDays(monthKey) {
        if (!monthKey) return 0;
        return tableData.filter(
          (entry) => entry.date && entry.date.slice(0, 7) === monthKey
        ).length;
      }

      function getMonthlyOtHours(monthKey) {
        if (!monthKey) return 0;
        let sum = 0;
        tableData.forEach((entry) => {
          if (!entry.date || entry.date.slice(0, 7) !== monthKey) return;
          sum +=
            (parseFloat(entry.v167) || 0) +
            (parseFloat(entry.v134) || 0) +
            (parseFloat(entry.v166) || 0) +
            (parseFloat(entry.v267) || 0);
        });
        return sum;
      }

      function getMonthlySalary(monthKey) {
        if (!monthKey) return 0;
        const found = tableData.find(
          (entry) => entry.date && entry.date.slice(0, 7) === monthKey && entry.monthSLR
        );
        return found ? parseFloat(found.monthSLR) || 0 : 0;
      }

      function getMonthlyAverageDailySalary(monthKey) {
        if (!monthKey) return 0;
        let sum = 0;
        let count = 0;
        tableData.forEach((entry) => {
          if (!entry.date || entry.date.slice(0, 7) !== monthKey) return;
          const total = parseFloat(entry.total || 0);
          if (!isNaN(total)) {
            sum += total;
            count += 1;
          }
        });
        if (!count) return 0;
        return sum / count;
      }

      // 共用：取得當月摘要訊息
      function getMonthlySummaryText() {
        const totalCount = getTotalRecordCount();
        const monthKey = getLatestMonthKey();

        if (!monthKey) {
          return `已記錄 ${totalCount} 筆資料`;
        }

        const travelDays = getMonthlyTravelDays(monthKey);
        const otHours = getMonthlyOtHours(monthKey);
        const monthSalary = getMonthlySalary(monthKey);
        const avgDaily = getMonthlyAverageDailySalary(monthKey);

        const [year, month] = monthKey.split('-');
        const prettyMonth = `${year}/${month}`;

        const msgLines = [
          `已記錄 ${totalCount} 筆資料`,
          `${prettyMonth} 已出差 ${travelDays} 天`,
          `${prettyMonth} 已加班 ${otHours.toFixed(2)} 小時`,
          `${prettyMonth} 月薪：${Math.round(monthSalary)}`,
          `${prettyMonth} 平均日薪：約 ${Math.round(avgDaily)}`,
        ];

        return msgLines.join('\n');
      }

      // === 觸發寫回 Google Sheet ===
      async function saveToSheet() {
        const payload = buildSheetPayload();
        const settingsPayload = {
          salaryHistory: globalSettings.salaryHistory,
          travelRates: globalSettings.travelRates,
          usdRate: globalSettings.usdRate,
          rules: globalSettings.rules
        };

        const btn = document.getElementById('saveToSheetBtn');
        let progressInterval = null;

        if (btn) {
          btn.classList.add('loading');
          let pText = btn.querySelector('.progress-text');
          if (!pText) {
            pText = document.createElement('span');
            pText.className = 'progress-text';
            btn.appendChild(pText);
          }

          let percent = 0;
          pText.textContent = '0%';
          progressInterval = setInterval(() => {
            if (percent < 98) {
              const increment = percent < 80 ? (Math.floor(Math.random() * 8) + 2) : (Math.floor(Math.random() * 2) + 1);
              percent += increment;
              if (percent > 98) percent = 98;
              pText.textContent = `${percent}%`;
            }
          }, 100);
        }

        const finishLoading = (res, success) => {
          if (progressInterval) clearInterval(progressInterval);
          if (btn) {
            const pText = btn.querySelector('.progress-text');
            if (pText) pText.textContent = success ? '100%' : '❌';
            setTimeout(() => {
              btn.classList.remove('loading');
              if (success) {
                const summary = getMonthlySummaryText();
                showNotification(`✅ 已同步至 ${res.sheetName || '試算表'}\n${summary}`);
              } else {
                const errMsg = (res && res.error) || '未知錯誤';
                alert('同步失敗。\n原因：' + errMsg);
                showNotification('❌ 同步失敗：' + errMsg, true);
              }
            }, 700);
          }
        };

        // --- Attempt GAS Environment ---
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          try {
            // Save Settings
            google.script.run
              .withSuccessHandler(() => {
                console.log('[OT] Settings persisted.');
                storage.set('globalSettings', JSON.stringify(settingsPayload));
              })
              .saveSettings(settingsPayload);

            // Save Data
            google.script.run
              .withSuccessHandler((res) => {
                if (res.ok) finishLoading(res, true);
                else finishLoading(res, false);
              })
              .withFailureHandler((err) => {
                finishLoading({ error: err.toString() }, false);
              })
              .saveOvertimeData(payload);
            return;
          } catch (e) {
            console.warn('[OT] GAS Call failed, falling back to Proxy:', e);
          }
        }

        // --- Fallback to Vercel Proxy (/api) ---
        console.log('[OT] Using Vercel Proxy for saving...');
        try {
          // Save Settings via Proxy
          fetch('/api/?api=1', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: 'settings', data: settingsPayload })
          }).then(r => r.json()).then(res => {
            if (res.ok) storage.set('globalSettings', JSON.stringify(settingsPayload));
          }).catch(e => console.warn('[OT] Proxy Settings Save Fail:', e));

          // Save Data via Proxy
          const res = await fetch('/api/?api=1', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }).then(r => r.json());

          if (res.ok) finishLoading(res, true);
          else finishLoading(res, false);
        } catch (err) {
          console.error('[OT] Proxy Save Error:', err);
          finishLoading({ error: err.message }, false);
        }
      }

      // === Contribution Calendar Rendering ===
      function renderContributionCalendar(monthKey, monthEntries) {
        console.log(`[OT] renderContributionCalendar called for ${monthKey}`, monthEntries);
        const grid = document.createElement('div');
        grid.className = 'contribution-grid';

        // Get days in month
        const [year, month] = monthKey.split('-').map(Number);
        const daysInMonth = new Date(year, month, 0).getDate();

        // Create a map of date -> { ot, travel, presence, leave }
        const statMap = {};
        monthEntries.forEach(e => {
          // [Audit Fix] Robust date parsing (avoid timezone offset issues)
          const dStr = e.date.split('-')[2];
          const d = parseInt(dStr, 10);
          if (!statMap[d]) statMap[d] = { ot: 0, travel: 0, presence: 0, leave: 0 };

          statMap[d].ot += (parseFloat(e.otSum) || 0);
          statMap[d].travel += (parseFloat(e.travel) || 0);
          statMap[d].presence += (parseFloat(e.base) || 0);
          if (e.isLeave) statMap[d].leave += 1;
        });

        // Render all days of the month in a single row
        for (let i = 1; i <= daysInMonth; i++) {
          const cell = document.createElement('div');
          cell.className = 'grid-cell';

          const stats = statMap[i] || { ot: 0, travel: 0, presence: 0 };
          const ot = stats.ot;
          const travel = stats.travel;
          const presence = stats.presence;

          const isNeumo = document.documentElement.getAttribute('data-theme') === 'neumorphic';
          if (stats.leave > 0) {
            cell.style.background = isNeumo ? '#c4c8cc' : '#8B0000';
          } else if (travel > 0) {
            if (ot >= 4) cell.style.background = isNeumo ? '#5d6268' : '#004ea2';
            else if (ot >= 2) cell.style.background = isNeumo ? '#7d8288' : '#007AFF';
            else if (ot > 0) cell.style.background = isNeumo ? '#9da1a6' : '#80bdff';
            else cell.style.background = isNeumo ? '#bdc2c6' : '#e0f0ff';
          } else if (ot >= 4) {
            cell.style.background = isNeumo ? '#6d7276' : '#004d00';
          } else if (ot >= 2) {
            cell.style.background = isNeumo ? '#8d9296' : '#006400';
          } else if (ot > 0 || presence > 0) {
            cell.style.background = isNeumo ? '#bdc2c6' : '#7CFC00';
          } else {
            cell.style.background = isNeumo ? '#e0e5e9' : '#e0e0e0';
          }

          cell.title = `${monthKey}-${i}: ${Math.round(ot)} OT, ${Math.round(presence)} Presence, ${Math.round(travel)} Travel`;
          grid.appendChild(cell);
        }

        return grid;
      }

      // 匯出 CSV
      document
        .getElementById('exportCSVCard')
        .addEventListener('click', () => {
          let csv =
            'date,weekday,1.67,1.34,2.0,2.67,OT hr SUM,Base,Travel,OT Salary,Total,Month SLR,Remark,isLeave,isHoliday,travelCountry,endTime,leaveType,leaveAmount\n';
          tableData.forEach((entry) => {
            csv +=
              [
                entry.date,
                entry.weekday,
                entry.v167,
                entry.v134,
                entry.v166,
                entry.v267,
                entry.otSum,
                entry.base,
                entry.travel,
                entry.otSalary,
                entry.total,
                entry.monthSLR,
                entry.remark ? `"${entry.remark.replace(/"/g, '""')}"` : '',
                entry.isLeave ? 'TRUE' : 'FALSE',
                entry.isHoliday ? 'TRUE' : 'FALSE',
                entry.travelCountry || 'None',
                entry.endTime || '',
                entry.leaveType || '',
                entry.leaveAmount || 0
              ].join(',') + '\n';
          });

          const blob = new Blob([csv], { type: 'text/csv' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);

          // 以本地時間產生 yyyymmdd（例如：20251112）
          const now = new Date();
          const yyyy = now.getFullYear();
          const mm = String(now.getMonth() + 1).padStart(2, '0');
          const dd = String(now.getDate()).padStart(2, '0');
          const filename = `overtime_${yyyy}${mm}${dd}.csv`;

          link.download = filename;
          link.click();
        });

      // 匯入 CSV
      document
        .getElementById('importCSVCard')
        .addEventListener('change', function (e) {
          const file = e.target.files[0];
          const reader = new FileReader();
          reader.onload = function (event) {
            const text = event.target.result;
            parseCSV(text);
            updateAll();
          };
          reader.readAsText(file);
        });

      function parseCSV(text) {
        const lines = text
          .split('\n')
          .filter((line) => line.trim() !== '');
        if (lines.length <= 1) return;

        tableData = lines.slice(1).map((line) => {
          // Handle potential commas in remarks by using a smarter split if needed, 
          // but for now simple split and join for remaining columns if remark has commas is better.
          // Actually a proper CSV parser would be better, but let's stick to consistent indices for now.
          const cols = line.split(',');
          return {
            date: cols[0],
            v167: parseFloat(cols[2]) || 0,
            v134: parseFloat(cols[3]) || 0,
            v166: parseFloat(cols[4]) || 0,
            v267: parseFloat(cols[5]) || 0,
            remark: (cols[12] || '').replace(/^"|"$/g, ''),
            isLeave: cols[13] === 'TRUE',
            isHoliday: cols[14] === 'TRUE',
            travelCountry: cols[15] || 'None',
            endTime: cols[16] || '',
            leaveType: cols[17] || '',
            leaveAmount: parseFloat(cols[18]) || 0
          };
        });
      }

      // 更新 Dashboard 總計
      function updateDashboard() {
        let totalOT = 0,
          totalTravel = 0,
          totalOTSalary = 0,
          totalCost = 0;

        const today = new Date();
        const currentMonthKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;

        const monthData = tableData.filter(e => e.date && e.date.startsWith(currentMonthKey));

        const travelDays = monthData.filter(e => {
          const trv = parseFloat(e.travel || 0);
          return trv > 0;
        }).length;

        monthData.forEach((entry) => {
          const isLeave = !!entry.isLeave;
          const otHours = isLeave ? 0 : (
            (parseFloat(entry.v167) || 0) +
            (parseFloat(entry.v134) || 0) +
            (parseFloat(entry.v166) || 0) +
            (parseFloat(entry.v267) || 0)
          );
          totalOT += otHours;
          totalTravel += parseFloat(entry.travel || 0);
          totalOTSalary += parseFloat(entry.otSalary || 0);
          totalCost += parseFloat(entry.total || 0);
        });

        const items = [
          { id: 'travelDays', val: travelDays },
          { id: 'totalOT', val: totalOT.toFixed(1) },
          { id: 'totalTravel', val: Math.round(totalTravel) },
          { id: 'totalOTSalary', val: Math.round(totalOTSalary) },
          { id: 'totalCost', val: Math.round(totalCost) }
        ];

        items.forEach(item => {
          const el = document.getElementById(item.id);
          if (el) {
            el.classList.add('privacy-hidden');
            setAnimatedNumber(el, String(item.val));
          }
        });
      }

      // Toggle Dashboard Card
      global.toggleDashboardCard = function () {
        const body = document.getElementById('dashboardBody');
        const icon = document.getElementById('dashboardExpandIcon');
        if (!body || !icon) return;
        body.classList.toggle('open');
        const isOpen = body.classList.contains('open');
        icon.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(-90deg)';
        icon.textContent = isOpen ? 'expand_less' : 'expand_more';
      };

      global.toggleToolboxCard = function () {
        const body = document.getElementById('toolboxBody');
        const icon = document.getElementById('toolboxExpandIcon');
        if (!body || !icon) return;
        body.classList.toggle('open');
        const isOpen = body.classList.contains('open');
        icon.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(-90deg)';
        icon.textContent = isOpen ? 'expand_less' : 'expand_more';
      };

      global.toggleTravelRateCard = function () {
        const body = document.getElementById('travelRateBody');
        const icon = document.getElementById('travelRateExpandIcon');
        if (!body || !icon) return;
        body.classList.toggle('open');
        const isOpen = body.classList.contains('open');
        if (isOpen) renderTravelRateList();
        icon.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(-90deg)';
        icon.textContent = isOpen ? 'expand_less' : 'expand_more';
      };

      global.toggleLeaveManagementCard = function () {
        const body = document.getElementById('leaveManagementBody');
        const icon = document.getElementById('leaveManagementExpandIcon');
        if (!body || !icon) return;
        body.classList.toggle('open');
        const isOpen = body.classList.contains('open');
        if (isOpen) updateLeaveSummaryDOM();
        icon.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(-90deg)';
        icon.textContent = isOpen ? 'expand_less' : 'expand_more';
      };

      // Privacy Mode Global Toggle
      function togglePrivacyMode() {
        document.body.classList.toggle('privacy-mode');
        const btn = document.getElementById('privacyToggleBtn');
        if (btn) {
          const isActive = document.body.classList.contains('privacy-mode');
          btn.classList.toggle('active', isActive);
          const icon = btn.querySelector('.material-symbols-outlined');
          if (icon) {
            icon.textContent = isActive ? 'visibility_off' : 'visibility';
          }
        }
      }

      function toggleTheme() {
        const html = document.documentElement;
        const current = html.getAttribute('data-theme');
        const next = current === 'neumorphic' ? 'default' : 'neumorphic';
        html.setAttribute('data-theme', next);
        storage.set('appTheme', next);
        showNotification(next === 'neumorphic' ? '🎨 已切換至新擬態主題' : '✨ 已切換至玻璃擬態主題');

        // Dynamic theme update for charts and colors
        if (typeof initCharts === 'function') initCharts(true);
        if (typeof updateAll === 'function') updateAll();
        setTimeout(() => { if (typeof updateCharts === 'function') updateCharts(); }, 300);
      }

      function initTheme() {
        const saved = storage.get('appTheme') || 'neumorphic';
        document.documentElement.setAttribute('data-theme', saved);
      }
      global.togglePrivacyMode = togglePrivacyMode;
      global.toggleTheme = toggleTheme;

      // 當匯率輸入變更時，自動重新計算
      const usdRateEl = document.getElementById('usdRate');
      if (usdRateEl) {
        usdRateEl.addEventListener('input', () => {
          updateAll();
        });
      }

      // === Google Sheet 相關工具（HtmlService 版：優先走 google.script.run） ===

      // === Google Sheet 相關工具（HtmlService 版：直接吃 Template 注入的初始資料） ===
      let isLoadingFromSheet = false;
      async function loadFromSheet() {
        console.log('[OT] 嘗試載入資料...');
        if (isLoadingFromSheet) return;
        isLoadingFromSheet = true;
        try {
          let payload = window.__OT_INIT_PAYLOAD__;
          console.log('[OT] 初始 Payload 狀態:', payload ? '已讀取' : '未讀取');

          // 如果是本地開發環境且沒有 Payload，提供模擬資料
          // Fix: strict check for localhost or file protocol to avoid triggering on Vercel
          const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:';

          if (!payload && isLocalDev) {
            console.log('[OT] 本地環境偵測：載入模擬資料 (Dev Mode)');
            payload = {
              data: [
                { date: '2025-12-01', v167: 1, v134: 0, v166: 0, v267: 0, remark: '本地測試資料 A', travelCountry: 'Vietnam' },
                { date: '2025-12-02', v167: 0, v134: 3, v166: 0, v267: 0, remark: '本地測試資料 B', travelCountry: 'None' }
              ]
            };
            window.__OT_INIT_PAYLOAD__ = payload;
          }
          let rows = [];
          if (Array.isArray(payload)) {
            rows = payload;
          } else if (payload && Array.isArray(payload.data)) {
            rows = payload.data;
          }

          console.log('[OT] 最終 rows 資料筆數:', rows ? rows.length : 0);

          if (rows && rows.length > 0) {
            console.log('[OT] 開始執行 initTableFromPayload');
            initTableFromPayload({ data: rows });
            showNotification(`✅ 已載入 ${rows.length} 筆資料`);
          } else {
            // [Audit Fix] Try local cache if Template payload is empty
            const cached = storage.get('overtimeData');
            if (cached) {
              const cachedRows = JSON.parse(cached);
              if (cachedRows.length > 0) {
                console.log('[OT] 使用本地快取資料初始化');
                initTableFromPayload({ data: cachedRows });
                initTableFromPayload({ data: cachedRows });
                showNotification(`✅ 已從本地快取載入 ${cachedRows.length} 筆資料 (正在同步最新資料...)`);
                // Fix: Do not return here. Continue to fetch from API to ensure data is fresh and not stale mock data.
              }
            }

            console.warn('[OT] Template 資料為空，嘗試透過 API 重新抓取...');
            // Fallback: 嘗試用 google.script.run 抓取
            if (typeof google !== 'undefined' && google.script && google.script.run) {
              google.script.run
                .withSuccessHandler((res) => {
                  console.log('[OT] API 抓取成功:', res);
                  if (res && res.data && res.data.length > 0) {
                    initTableFromPayload(res);
                    showNotification(`✅ 透過 API 載入 ${res.data.length} 筆資料`);
                  } else {
                    console.warn('[OT] API 資料也為空');
                    renderDataList(); // 顯示空表
                    showNotification('⚠️ 無法讀取資料，請檢查 Google Sheet 是否有資料', true);
                  }
                })
                .withFailureHandler((err) => {
                  console.error('[OT] API 抓取失敗:', err);
                  renderDataList(); // 顯示空表
                  showNotification('❌ 資料讀取失敗，請檢查網路或權限', true);
                })
                .getOvertimeData();
            } else {
              console.warn('[OT] 無法使用 google.script.run，嘗試透過 Vercel Proxy (/api) 抓取...');
              try {
                let res;
                try {
                  res = await fetch('/api/?api=1');
                  if (!res.ok) throw new Error(`Proxy status: ${res.status}`);
                } catch (proxyErr) {
                  console.warn('[OT] Vercel Proxy 失敗，嘗試直接連線 GAS (Client-Side)...', proxyErr);
                  // Fallback: Direct Client-Side Fetch
                  const GAS_URL = "https://script.google.com/macros/s/AKfycbzDY3zDdmGbldTMbra2oPrQ4KWJiqC7kRxT7nIprQugP71KoL28Lj-9L53hYeh6nTxrYw/exec";
                  res = await fetch(`${GAS_URL}?api=1`);
                  if (!res.ok) throw new Error(`Direct Fetch status: ${res.status}`);
                }

                const json = await res.json();
                if (json && (json.data || json.settings)) {
                  console.log('[OT] 資料抓取成功:', json);
                  initTableFromPayload(json);
                  showNotification(`✅ 成功載入 ${json.data ? json.data.length : 0} 筆資料`);
                } else {
                  console.warn('[OT] 資料格式異常:', json);
                  throw new Error('Invalid Data Format');
                }
              } catch (err) {
                console.error('[OT] 所有連線方式皆失敗:', err);
                renderDataList();
                syncTravelToggleUI();
                showNotification('❌ 無法連線至 Google Sheets，請檢查網路或權限', true);
              }
            }
          }

          // --- Fetch Settings from Sheet ---
          if (typeof google !== 'undefined' && google.script && google.script.run) {
            google.script.run
              .withSuccessHandler((res) => {
                if (res && res.ok && res.data && Object.keys(res.data).length > 0) {
                  console.log('[OT] Settings loaded from sheet:', res.data);
                  globalSettings = { ...globalSettings, ...res.data };
                  // Apply UI changes
                  if (document.getElementById('usdRate')) {
                    document.getElementById('usdRate').value = globalSettings.usdRate;
                  }
                  updateAll();
                }
              })
              .getSettings();
          } else {
            // Fallback settings fetch via Vercel Proxy
            try {
              const res = await fetch('/api/?api=1&mode=settings').then(r => r.json());
              if (res && res.ok && res.data) {
                console.log('[OT] Settings loaded via Vercel Proxy:', res.data);
                globalSettings = { ...globalSettings, ...res.data };
                if (document.getElementById('usdRate')) {
                  document.getElementById('usdRate').value = globalSettings.usdRate;
                }
                updateAll();
              }
            } catch (e) {
              console.warn('[OT] Vercel Proxy settings fetch failed (ignore if not on Vercel)');
            }
          }
        } catch (err) {
          console.error('[OT] loadFromSheet 發生錯誤:', err);
          renderDataList();
          syncTravelToggleUI();
          showNotification('❌ 初始化失敗: ' + err.message, true);
        } finally {
          isLoadingFromSheet = false;
        }
      }

      // === 診斷工具：手動檢查連線與資料 ===
      function runDiagnostics() {
        showNotification('正在診斷連線與資料...');
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          alert('❌ 診斷失敗：未偵測到 Google Apps Script 環境。\n請確保您是在 Google 部署後的網址（script.google.com）中執行此功能。\n本地預覽模式下無法呼叫後端 API。');
          return;
        }

        google.script.run
          .withSuccessHandler((res) => {
            console.log('[OT Diagnostics] Response:', res);
            let msg = '✅ 連線成功！\n\n';
            if (res && res.data) {
              msg += `資料筆數: ${res.data.length}\n`;
              if (res.data.length > 0) {
                msg += `第一筆日期: ${res.data[0].date || '無'}\n`;
                msg += `試算表目前偵測到內容，請檢查篩選器或隱私模式是否導致顯示空白。\n`;
              } else {
                if (res.sheetNames) {
                  msg += `偵測到的工作表: ${res.sheetNames.join(', ')}\n`;
                }
                if (res.error) {
                  msg += `後端回報錯誤: ${res.error}\n`;
                } else {
                  msg += '提示: 目前連線到的試算表內容是空的 (只有標題列)，請檢查工作表內容。\n';
                }
              }
            } else {
              msg += '⚠️ 收到無效的回傳格式。';
            }
            alert(msg);
          })
          .withFailureHandler((err) => {
            console.error('[OT Diagnostics] Error:', err);
            alert('❌ API 呼叫失敗: ' + err);
          })
          .getOvertimeData();
      }

      function initTableFromPayload(payload) {
        console.log('[OT] initTableFromPayload called with:', payload);
        const rows = payload && payload.data ? payload.data : [];
        if (rows.length > 0) {
          console.log('[OT] First row sample:', JSON.stringify(rows[0]));
        }

        tableData = rows.map((row, index) => {
          try {
            let rawDate = row.date;

            // Apps Script 透過 google.script.run 傳過來，date 可能是 Date 物件，也可能是字串
            // Normalize date to YYYY-MM-DD
            function normalizeDate(val) {
              if (!val) return '';
              // If it's already a Date object
              if (val instanceof Date) {
                const yyyy = val.getFullYear();
                const mm = String(val.getMonth() + 1).padStart(2, '0');
                const dd = String(val.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
              }

              const s = val.toString().trim();

              // Detect ISO strings like 2025-12-23T17:00:00.000Z
              // If it has T and Z, parse normally and get LOCAL date parts
              if (s.includes('T') && s.includes('Z')) {
                const d = parseDateSafe(s);
                if (!isNaN(d.getTime())) {
                  const yyyy = d.getFullYear(); // Local Year
                  const mm = String(d.getMonth() + 1).padStart(2, '0'); // Local Month
                  const dd = String(d.getDate()).padStart(2, '0'); // Local Date
                  return `${yyyy}-${mm}-${dd}`;
                }
              }

              // Simple YYYY-MM-DD or YYYY/MM/DD
              const match = s.match(/^(\d{4})[/\-](\d{1,2})[/\-](\d{1,2})/);
              if (match) {
                const yyyy = match[1];
                const mm = match[2].padStart(2, '0');
                const dd = match[3].padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
              }

              // Fallback: replace dash with slash to avoid UTC interpretation for short date strings
              const dateStr = s.includes('-') && !s.includes(':') ? s.replace(/-/g, '/') : s;
              const d = parseDateSafe(dateStr);
              if (isNaN(d.getTime())) return s.slice(0, 10);
              const yyyy = d.getFullYear();
              const mm = String(d.getMonth() + 1).padStart(2, '0');
              const dd = String(d.getDate()).padStart(2, '0');
              return `${yyyy}-${mm}-${dd}`;
            }
            rawDate = normalizeDate(rawDate);

            if (index === 0) {
              console.log('[OT] Diagnostic - First Row Keys:', Object.keys(row));
              console.log('[OT] Diagnostic - First Row Data:', row);
            }
            const v167 = safeParseFloat(row.v167 ?? row['1.67'] ?? row['1.66'] ?? 0);
            const v134 = safeParseFloat(row.v134 ?? row['1.34'] ?? 0);
            const v166 = safeParseFloat(row.v166 ?? row['2'] ?? row['2.0'] ?? row['2.00'] ?? row['假日'] ?? 0);
            const v267 = safeParseFloat(row.v267 ?? row['2.67'] ?? 0);

            const baseRaw = row.base ?? row.Base ?? row['Base'] ?? '';
            const travelRaw = row.travel ?? row.Travel ?? row['Travel'] ?? '';
            const otSalaryRaw = row.otSalary ?? row['OT Salary'] ?? row['otSalary'] ?? '';
            const totalRaw = row.total ?? row.Total ?? row['Total'] ?? '';
            const monthSlrRaw = row.monthSLR ?? row['Month SLR'] ?? row['MonthSLR'] ?? '';
            const otSumRaw = row.otSum ?? row['OT hr SUM'] ?? row['otSum'] ?? '';
            const remarkRaw = row.remark ?? row.Remark ?? row['Remark'] ?? '';

            const travelNum = safeParseFloat(travelRaw) || 0;
            const travelEnabled = travelNum > 0;

            const isLeaveRaw = row.isLeave ?? '';
            const isLeave = (isLeaveRaw === 'TRUE' || isLeaveRaw === true);

            const trvCountryRaw = row.travelCountry ?? row['Travel Country'] ?? '';
            return {
              date: rawDate,
              weekday: row.weekday || (rawDate ? getWeekdayChar(rawDate) : ''),
              v167,
              v134,
              v166,
              v267,
              base: (baseRaw || '').toString(),
              travel: (travelRaw || '').toString(),
              otSalary: (otSalaryRaw || '').toString(),
              total: (totalRaw || '').toString(),
              monthSLR: (monthSlrRaw || '').toString(),
              otSum: (otSumRaw || '').toString(),
              remark: (remarkRaw || '').toString(),
              travelCountry: trvCountryRaw || (travelEnabled ? 'Vietnam' : 'None'),
              endTime: (row.endTime && row.endTime.toString().includes('NaN')) ? '' : (row.endTime || ''),
              isLeave: isLeave,
              leaveType: row.leaveType || (isLeave ? '特休' : ''),
              leaveAmount: safeParseFloat(row.leaveAmount || row['leaveAmount'] || (isLeave ? 1 : 0)),
              travelEnabled,
              isHoliday: String(row.isHoliday || row['isHoliday'] || '').toUpperCase() === 'TRUE' || row.isHoliday === true,
              __id: 'rec_' + Math.random().toString(36).substr(2, 9) + '_' + index
            };
          } catch (e) {
            console.error(`[OT] 第 ${index} 筆資料轉換失敗:`, e, row);
            return null;
          }
        }).filter(r => r !== null);

        // 排序: 由新到舊 (Newest First)
        tableData.sort((a, b) => {
          return parseDateSafe(b.date) - parseDateSafe(a.date);
        });
        updateAll();
      }

      // === End Google Sheet 相關工具 ===

      // === Smart Stepper Add Card 互動邏輯 ===
      const newAddCardState = {
        date: null, // YYYY-MM-DD
        v167: 0,
        v134: 0,
        v166: 0,
        v267: 0,
        travel: 'Vietnam',
        isHoliday: false,
        isLeave: false,
        leaveType: '特休',
        leaveAmount: 1
      };

      const travelOptions = ['None', 'Vietnam', 'China', 'India'];
      const travelDisplay = { 'None': '-', 'Vietnam': 'VN', 'China': 'CN', 'India': 'IN' };

      // 初始化 Smart Stepper Add按鈕
      function initAddCardSteppers() {
        const dateBtn = document.getElementById('newDate');
        const travelBtn = document.getElementById('newTravelCountry');
        const hourBtn = document.getElementById('newHour');
        const minBtn = document.getElementById('newMinute');
        const holidayToggleBtn = document.getElementById('newHolidayToggle'); // Assuming this button exists

        // Init Default Time State
        newAddCardState.hour = 17;
        newAddCardState.minute = 30;
        newAddCardState.isHoliday = false; // Add flag
        // Add Holiday Toggle Button Logic to UI if not present? User asked to add "Next to +" button.
        // We will create it dynamically or user must add to HTML.
        // JS will handle logic.

        // 日期按鈕：點擊開啟日期選擇器
        if (dateBtn) {
          dateBtn.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'date';
            input.value = newAddCardState.date || '';

            // Improved styling to fix transparency and rectangular glitch
            Object.assign(input.style, {
              position: 'fixed',
              top: '50%',
              left: '50%',
              transform: 'translate(-50%, -50%)',
              width: '280px',
              height: '60px',
              fontSize: '20px',
              padding: '10px',
              zIndex: '10000',
              borderRadius: '16px',
              border: '2px solid #007AFF', // var(--color-primary)
              background: '#ffffff', // Force solid background
              boxShadow: '0 8px 32px rgba(0,0,0,0.3)',
              outline: 'none',
              color: '#000000'
            });

            document.body.appendChild(input);

            input.addEventListener('change', () => {
              if (input.value) {
                newAddCardState.date = input.value;
                const d = parseDateSafe(input.value);
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                dateBtn.textContent = `${mm}/${dd}`;
                dateBtn.classList.add('has-value');
              }
              if (document.body.contains(input)) document.body.removeChild(input);
            });
            input.addEventListener('blur', () => {
              // Delay to allow change event if processed on mobile
              setTimeout(() => { if (document.body.contains(input)) document.body.removeChild(input); }, 300);
            });
            setTimeout(() => { input.focus(); input.click(); }, 100);
          });
        }

        const updateTravelUI = () => {
          if (!travelBtn) return;
          const isTraveling = newAddCardState.travel !== 'None';
          const iconColor = isTraveling ? 'var(--color-primary)' : 'rgba(0,0,0,0.5)';
          const bgColor = isTraveling ? 'rgba(0, 122, 255, 0.15)' : 'rgba(0,0,0,0.05)';
          travelBtn.style.background = bgColor;

          let badgeHtml = '';
          if (isTraveling) {
            const shortCode = getCountryAbbr(newAddCardState.travel);
            badgeHtml = `<span style="position:absolute; bottom:2px; right:2px; font-size:8px; font-weight:800; color:var(--color-primary); background:white; padding:1px 2px; border-radius:3px; line-height:1;">${shortCode}</span>`;
          }
          travelBtn.innerHTML = `<span class="material-symbols-outlined" style="font-size: 24px; color: ${iconColor}">flight</span>${badgeHtml}`;
        };

        // Travel 按鈕 logic
        if (travelBtn) {

          let dragState = null;

          travelBtn.addEventListener('mousedown', (e) => {
            const travels = ['None', ...Object.keys(getTravelRates())];
            dragState = { startY: e.clientY, moved: false, travels };
            travelBtn.classList.add('active');
          });

          const onMove = (e) => {
            if (!dragState) return;
            const delta = dragState.startY - e.clientY;
            if (Math.abs(delta) > 10) dragState.moved = true;
            if (Math.abs(delta) > 40) {
              const travels = dragState.travels;
              const curr = travels.indexOf(newAddCardState.travel);
              const next = delta > 0 ? (curr + 1) % travels.length
                : (curr - 1 + travels.length) % travels.length;
              newAddCardState.travel = travels[next];
              updateTravelUI();
              dragState.startY = e.clientY;
            }
          };
          const onUp = () => {
            if (dragState) {
              const travels = dragState.travels;
              if (!dragState.moved) {
                const curr = travels.indexOf(newAddCardState.travel);
                const next = (curr + 1) % travels.length;
                newAddCardState.travel = travels[next];
                updateTravelUI();
              }
              travelBtn.classList.remove('active');
              dragState = null;
            }
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
          };
          travelBtn.addEventListener('mousedown', () => {
            // Note: mousedown is also handled above to init travels list
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
          });
        }

        // Holiday Toggle Button Logic
        if (holidayToggleBtn) {
          holidayToggleBtn.addEventListener('click', () => {
            newAddCardState.isHoliday = !newAddCardState.isHoliday;
            holidayToggleBtn.classList.toggle('on', newAddCardState.isHoliday);
            const icon = holidayToggleBtn.querySelector('.material-symbols-outlined');
            if (icon) {
              icon.textContent = newAddCardState.isHoliday ? 'holiday_village' : 'event_busy';
              icon.style.color = newAddCardState.isHoliday ? 'var(--color-warning)' : 'rgba(0,0,0,0.5)';
            }
          });
        }

        // Leave Toggle for Add Card
        const leaveToggleBtn = document.getElementById('newLeaveToggle');
        const leaveInfoWrapper = document.getElementById('leaveInfoWrapper');
        const leaveInfoRow = document.getElementById('leaveInfoRow');

        // Replace these with capsule selectors dynamically
        if (leaveInfoRow) {
          leaveInfoRow.innerHTML = '';

          const types = [
            '特休', '事假', '病假', '公假', '婚假', '公傷假', '喪假',
            '有薪產假', '無薪產假', '補休', '產檢假', '陪產檢及陪產假',
            '駐地休假', '生理假', '家庭照顧假', '住院病假', '健檢假'
          ];
          const typeCapsule = renderCapsuleSelector(types, newAddCardState.leaveType || '特休', (val) => {
            newAddCardState.leaveType = val;
          });

          const amts = [
            { value: 1, label: '1.0 天' }, { value: 0.5, label: '0.5 天' }, { value: 0.125, label: '1 小時' }, { value: 0.25, label: '2 小時' }, { value: 0.375, label: '3 小時' }, { value: 0.5, label: '4 小時' }
          ];
          const amtCapsule = renderCapsuleSelector(amts, 1, (val) => {
            newAddCardState.leaveAmount = parseFloat(val);
          });
          const amtToggle = amtCapsule.querySelector('.capsule-toggle');
          if (amtToggle) amtToggle.textContent = '1.0 天';

          leaveInfoRow.appendChild(typeCapsule);
          leaveInfoRow.appendChild(amtCapsule);
        }



        if (leaveToggleBtn) {
          leaveToggleBtn.addEventListener('click', () => {
            newAddCardState.isLeave = !newAddCardState.isLeave;
            leaveToggleBtn.classList.toggle('on', newAddCardState.isLeave);

            const unit = document.getElementById('leaveCapsuleUnit');

            if (leaveInfoWrapper) {
              if (newAddCardState.isLeave) {
                leaveInfoWrapper.classList.add('expanded');
                if (unit) unit.classList.add('expanded');
              } else {
                leaveInfoWrapper.classList.remove('expanded');
                if (unit) unit.classList.remove('expanded');
              }
            }

            const icon = leaveToggleBtn.querySelector('.material-symbols-outlined');
            if (icon) {
              icon.textContent = newAddCardState.isLeave ? 'person_off' : 'person';
              icon.style.color = newAddCardState.isLeave ? '#ba1a1a' : 'rgba(0,0,0,0.5)';
            }
            if (newAddCardState.isLeave) {
              newAddCardState.leaveType = newAddCardState.leaveType || '特休';
              newAddCardState.leaveAmount = newAddCardState.leaveAmount || 1;
            }
          });
        }

        // Hour Button Logic
        if (hourBtn) {
          let hDrag = null;
          const startHDrag = (y) => {
            hDrag = { startY: y, startVal: newAddCardState.hour };
            hourBtn.classList.add('active');
          };
          const moveHDrag = (y) => {
            if (!hDrag) return;
            const delta = Math.floor((hDrag.startY - y) / 10);
            let newVal = (hDrag.startVal + delta) % 24;
            if (newVal < 0) newVal += 24;
            if (newVal !== newAddCardState.hour) {
              newAddCardState.hour = newVal;
              hourBtn.textContent = String(newVal).padStart(2, '0');
            }
          };
          const endHDrag = () => {
            if (hDrag) {
              hourBtn.classList.remove('active');
              hDrag = null;
            }
          };

          const onHMove = (e) => moveHDrag(e.clientY);
          const onHUp = () => {
            endHDrag();
            document.removeEventListener('mousemove', onHMove);
            document.removeEventListener('mouseup', onHUp);
          };
          const onHTouchMove = (e) => moveHDrag(e.touches[0].clientY);
          const onHTouchEnd = () => {
            endHDrag();
            document.removeEventListener('touchmove', onHTouchMove);
            document.removeEventListener('touchend', onHTouchEnd);
          };

          hourBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            startHDrag(e.clientY);
            document.addEventListener('mousemove', onHMove);
            document.addEventListener('mouseup', onHUp);
          });
          hourBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startHDrag(e.touches[0].clientY);
            document.addEventListener('touchmove', onHTouchMove, { passive: false });
            document.addEventListener('touchend', onHTouchEnd);
          });
        }

        // Minute Button Logic
        if (minBtn) {
          let mDrag = null;
          const startMDrag = (y) => {
            mDrag = { startY: y, startVal: newAddCardState.minute };
            minBtn.classList.add('active');
          };
          const moveMDrag = (y) => {
            if (!mDrag) return;
            const steps = Math.floor((mDrag.startY - y) / 10);
            let newVal = (mDrag.startVal + (steps * 10)) % 60;
            if (newVal < 0) newVal += 60;
            if (newVal !== newAddCardState.minute) {
              newAddCardState.minute = newVal;
              minBtn.textContent = String(newVal).padStart(2, '0');
            }
          };
          const endMDrag = () => {
            if (mDrag) {
              minBtn.classList.remove('active');
              mDrag = null;
            }
          };

          const onMMove = (e) => moveMDrag(e.clientY);
          const onMUp = () => {
            endMDrag();
            document.removeEventListener('mousemove', onMMove);
            document.removeEventListener('mouseup', onMUp);
          };
          const onMTouchMove = (e) => moveMDrag(e.touches[0].clientY);
          const onMTouchEnd = () => {
            endMDrag();
            document.removeEventListener('touchmove', onMTouchMove);
            document.removeEventListener('touchend', onMTouchEnd);
          };

          minBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            startMDrag(e.clientY);
            document.addEventListener('mousemove', onMMove);
            document.addEventListener('mouseup', onMUp);
          });
          minBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startMDrag(e.touches[0].clientY);
            document.addEventListener('touchmove', onMTouchMove, { passive: false });
            document.addEventListener('touchend', onMTouchEnd);
          });
        }

        // Add Row Button
        const addBtn = document.getElementById('addRowCard');
        if (addBtn) {
          addBtn.addEventListener('click', () => {
            if (!newAddCardState.date) {
              showNotification('請先選擇日期', true);
              // Highlight date button
              if (dateBtn) {
                dateBtn.style.animation = 'shake 0.4s ease';
                setTimeout(() => dateBtn.style.animation = '', 400);
              }
              return;
            }

            const exists = tableData.some((d) => d.date === newAddCardState.date);
            if (exists) {
              showNotification('該日期已存在', true);
              return;
            }

            // Holiday Check handled in UI (we need to read the state)
            // We need to add the Holiday Button to the DOM first (handled in initAddCardSteppers or manually inserted)
            const isLeave = newAddCardState.isLeave || false;
            const res = isLeave
              ? { v134: 0, v167: 0, v166: 0, v267: 0, total: 0 }
              : calculateOvertime(newAddCardState.hour, newAddCardState.minute, newAddCardState.date, newAddCardState.isHoliday);

            const newEntry = {
              date: newAddCardState.date,
              v167: res.v167,
              v134: res.v134,
              v166: res.v166, // Holiday 2.0 bucket
              v267: res.v267,
              isLeave: isLeave,
              remark: '',
              travelCountry: newAddCardState.travel,
              endTime: `${String(newAddCardState.hour).padStart(2, '0')}:${String(newAddCardState.minute).padStart(2, '0')}`,
              leaveType: isLeave ? newAddCardState.leaveType : '',
              leaveAmount: isLeave ? newAddCardState.leaveAmount : 0
            };

            addNewEntry(newEntry);

            // 重置
            newAddCardState.date = null;
            newAddCardState.hour = 17;
            newAddCardState.minute = 30;
            newAddCardState.travel = 'Vietnam';
            newAddCardState.isHoliday = false; // Reset holiday toggle
            newAddCardState.isLeave = false; // Reset leave toggle

            if (dateBtn) {
              dateBtn.textContent = '--/--';
              dateBtn.classList.remove('has-value');
            }
            if (hourBtn) hourBtn.textContent = '17';
            if (minBtn) minBtn.textContent = '30';

            const leaveToggleBtn = document.getElementById('newLeaveToggle');
            if (leaveToggleBtn) {
              leaveToggleBtn.classList.remove('on');
              const icon = leaveToggleBtn.querySelector('.material-symbols-outlined');
              if (icon) {
                icon.textContent = 'person';
                icon.style.color = 'rgba(0,0,0,0.5)';
              }
            }
            if (leaveInfoWrapper) {
              leaveInfoWrapper.classList.remove('expanded');
            }
            const leaveInfoRow = document.getElementById('leaveInfoRow');
            if (leaveInfoRow) {
              // Reset capsule toggles text
              const toggles = leaveInfoRow.querySelectorAll('.capsule-toggle');
              if (toggles[0]) toggles[0].textContent = '特休';
              if (toggles[1]) toggles[1].textContent = '1.0 天';
            }

            if (holidayToggleBtn) {
              holidayToggleBtn.classList.remove('on');
              const icon = holidayToggleBtn.querySelector('.material-symbols-outlined');
              if (icon) {
                icon.textContent = 'event_busy';
                icon.style.color = 'rgba(0,0,0,0.5)';
              }
            }
            updateTravelUI();

            showNotification('✅ 已新增一筆資料');
          });
        }
      }

      // Event binding is handled in DOMContentLoaded below for better reliability.


      // Settings Card Toggle Logic (Animation)
      if (global) {
        global.toggleSettingsCard = function () {
          const body = document.getElementById('settingsBody');
          const icon = document.getElementById('settingsExpandIcon');
          // Toggle class 'open' on the wrapper
          body.classList.toggle('open');

          const isOpen = body.classList.contains('open');
          icon.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
        };
      }

      const fillBtn = document.getElementById('fillMissingDatesBtn');
      if (fillBtn) {
        fillBtn.addEventListener('click', () => {
          fillMissingDatesToToday();
        });
      } else {
        console.log(
          '[OT] fillMissingDatesBtn 尚未加入 HTML，待之後加上即可使用。'
        );
      }

      // === Charts Helper: Center Text Plugin ===
      const centerTextPlugin = {
        id: 'centerText',
        afterDraw(chart) {
          if (chart.canvas.id !== 'incomeChart' && chart.canvas.id !== 'incomeChart3M') return;
          const { ctx, width, height } = chart;
          ctx.restore();

          const data = chart.data.datasets[0].data;
          const sum = data.reduce((a, b) => a + b, 0);
          const count = chart.data.labels.length;

          const isNeumo = document.documentElement.getAttribute('data-theme') === 'neumorphic';

          const fontSize = (height / 160).toFixed(2);
          ctx.font = `600 ${fontSize}em "Open Sans", sans-serif`;
          ctx.textBaseline = 'middle';
          ctx.fillStyle = isNeumo ? '#444' : '#1d1d1f';

          const text = Math.round(sum).toLocaleString();
          const textX = Math.round((width - ctx.measureText(text).width) / 2);
          const textY = height / 2 - 5;

          ctx.fillText(text, textX, textY);

          ctx.font = `400 ${(fontSize * 0.4)}em sans-serif`;
          ctx.fillStyle = isNeumo ? '#888' : '#666';
          const subText = 'Avg Income';
          const subX = Math.round((width - ctx.measureText(subText).width) / 2);
          const subY = height / 2 + 15;
          ctx.fillText(subText, subX, subY);

          ctx.save();
        }
      };

      // 初始載入：在 Apps Script Web App 中會從 Sheet 讀取資料，其他情況顯示空白假表
      loadFromSheet();

      // 預留給 LOGO 點擊呼叫的函式：顯示當月統計通知
      if (global) {
        global.showOtMonthlySummary = function () {
          const summary = getMonthlySummaryText();
          showNotification('✅ ' + summary);
        };

        // 暴露到全域供 Analytics 使用
        global.updateAll = updateAll;
        global.showNotification = showNotification;
      }
      // ========== Analytics 升級功能 (已合併至同一 Scope) ==========
      // 由於 analytics.js 需要存取 tableData 等全域變數，直接在此內嵌

      // ========== 分頁切換 ==========
      function initTabNavigation() {
        // Logic handled via toggle button
      }

      // ========== 月份過濾 ==========
      function populateMonthFilter() {
        const filter = document.getElementById('monthFilter');
        if (!filter) return;

        // 收集所有月份
        const months = new Set();
        tableData.forEach(e => {
          if (e.date) months.add(e.date.slice(0, 7));
        });

        // 排序（新到舊）
        const sortedMonths = Array.from(months).sort().reverse();
        availableMonths = sortedMonths;

        // 清空並重建
        filter.innerHTML = '<option value="">全部月份</option>';
        sortedMonths.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m;
          opt.textContent = m;
          filter.appendChild(opt);
        });

        // 綁定事件
        filter.addEventListener('change', (e) => {
          selectedMonth = e.target.value || null;
          updateAll();
          updateCharts();
          updateAnalyticsStats();
        });
      }

      // ========== Chart.js 圖表 ==========
      // --- Global Esc Key Listener ---
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (typeof closeSalaryModal === 'function') closeSalaryModal();
          if (typeof closeTravelRateModal === 'function') closeTravelRateModal();
          if (typeof closeRulesModal === 'function') closeRulesModal();
          if (typeof closeLeaveManagementModal === 'function') closeLeaveManagementModal();
        }
      });

      /* Move plugin definition up to avoid ReferenceError */

      function initCharts(force = false) {
        if (chartsInitialized && !force) return;
        if (typeof Chart === 'undefined') return;

        if (force) {
          Object.values(charts).forEach(c => {
            if (c && typeof c.destroy === 'function') c.destroy();
          });
          charts = {};
        }

        const ctxOvertime = document.getElementById('overtimeChart')?.getContext('2d');
        const ctxIncome = document.getElementById('incomeChart')?.getContext('2d');
        const ctxIncome3M = document.getElementById('incomeChart3M')?.getContext('2d');
        const ctxAttendance = document.getElementById('attendanceChart')?.getContext('2d');
        const ctxSalaryTrend = document.getElementById('salaryTrendChart')?.getContext('2d');

        if (!ctxOvertime || !ctxIncome || !ctxIncome3M || !ctxAttendance || !ctxSalaryTrend) return;

        const isNeumo = document.documentElement.getAttribute('data-theme') === 'neumorphic';
        const textColor = isNeumo ? '#666' : '#1d1d1f';
        const secondaryTextColor = isNeumo ? '#999' : '#6e6e73';
        const fontFamily = "'Outfit', -apple-system, sans-serif";

        try {
          if (typeof ChartDataLabels !== 'undefined' && !Chart.registry.plugins.get('datalabels')) {
            Chart.register(ChartDataLabels);
          }
          if (!Chart.registry.plugins.get('centerText')) {
            Chart.register(centerTextPlugin);
          }
        } catch (e) { console.warn('[OT] Plugin registration error:', e); }

        charts.overtime = new Chart(ctxOvertime, {
          type: 'line',
          data: {
            labels: [],
            datasets: [{
              label: 'OT Hours',
              data: [],
              borderColor: '#007AFF',
              borderWidth: 3,
              pointBackgroundColor: '#007AFF',
              pointRadius: 4,
              pointHoverRadius: 6,
              tension: 0.4,
              fill: true,
              backgroundColor: 'rgba(0,122,255,0.08)'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              datalabels: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(0,0,0,0.03)' },
                ticks: { color: secondaryTextColor, font: { family: fontFamily }, callback: (val) => val.toFixed(1) }
              },
              x: {
                grid: { display: false },
                ticks: { color: secondaryTextColor, font: { family: fontFamily } }
              }
            }
          }
        });

        const incomeOptions = {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 1.2, // Optimal for doughnut with legend
          cutout: '70%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                boxWidth: 8,
                color: textColor,
                padding: 15,
                font: { family: fontFamily, size: 11, weight: '600' }
              }
            },
            datalabels: {
              color: '#fff',
              formatter: (value, ctx) => {
                const sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                if (sum === 0 || value === 0) return '';
                const percent = (value * 100 / sum);
                return percent > 5 ? percent.toFixed(0) + '%' : ''; // Hide small percentages
              },
              font: { family: fontFamily, weight: 'bold', size: 10 }
            },
            tooltip: {
              backgroundColor: 'rgba(255, 255, 255, 0.9)',
              titleColor: '#1d1d1f',
              bodyColor: '#1d1d1f',
              borderColor: 'rgba(0, 0, 0, 0.1)',
              borderWidth: 1,
              padding: 12,
              titleFont: { family: fontFamily, weight: 'bold' },
              bodyFont: { family: fontFamily },
              callbacks: {
                label: (item) => ` ${item.label}: ${Math.round(item.raw).toLocaleString()}`
              }
            },
            centerText: { display: true }
          }
        };

        charts.income = new Chart(ctxIncome, {
          type: 'doughnut',
          data: {
            labels: ['Salary', 'Travel', 'OT'],
            datasets: [{
              data: [0, 0, 0],
              backgroundColor: ['#34C759', '#007AFF', '#FF9500'],
              borderWidth: 0,
              hoverOffset: 10
            }]
          },
          options: incomeOptions
        });

        // 2.1 Income Structure (Last 3 Months)
        charts.income3M = new Chart(ctxIncome3M, {
          type: 'doughnut',
          data: {
            labels: ['Salary', 'Travel', 'OT'],
            datasets: [{
              data: [0, 0, 0],
              backgroundColor: ['#34C759', '#007AFF', '#FF9500'],
              borderWidth: 0,
              hoverOffset: 10
            }]
          },
          options: incomeOptions
        });

        charts.attendance = new Chart(ctxAttendance, {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              {
                label: 'Office',
                data: [],
                borderColor: '#34C759',
                backgroundColor: 'rgba(52,199,89,0.08)',
                borderWidth: 2,
                pointRadius: 3,
                tension: 0.4,
                fill: true
              },
              {
                label: 'Travel',
                data: [],
                borderColor: '#007AFF',
                backgroundColor: 'rgba(0,122,255,0.08)',
                borderWidth: 2,
                pointRadius: 3,
                tension: 0.4,
                fill: true
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  boxWidth: 8,
                  color: textColor,
                  font: { family: fontFamily, size: 10, weight: '600' }
                }
              },
              datalabels: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(0,0,0,0.03)' },
                ticks: { color: secondaryTextColor, font: { family: fontFamily }, stepSize: 1 }
              },
              x: {
                grid: { display: false },
                ticks: { color: secondaryTextColor, font: { family: fontFamily } }
              }
            }
          }
        });

        charts.salaryTrend = new Chart(ctxSalaryTrend, {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              { label: 'Base', data: [], borderColor: '#8e8e93', borderDash: [5, 5], tension: 0.4, fill: false, borderWidth: 2 },
              { label: 'OT Pay', data: [], borderColor: '#FF9500', tension: 0.4, fill: true, backgroundColor: 'rgba(255,149,0,0.08)', borderWidth: 3, pointRadius: 4 },
              { label: 'Travel', data: [], borderColor: '#007AFF', tension: 0.4, fill: true, backgroundColor: 'rgba(0,122,255,0.08)', borderWidth: 3, pointRadius: 4 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  boxWidth: 8,
                  color: textColor,
                  font: { family: fontFamily, size: 10, weight: '600' }
                }
              },
              datalabels: { display: false }
            },
            scales: {
              y: {
                stacked: true,
                beginAtZero: true,
                grid: { color: 'rgba(0,0,0,0.03)' },
                ticks: { color: secondaryTextColor, font: { family: fontFamily }, callback: (val) => (val / 1000).toFixed(0) + 'k' }
              },
              x: {
                grid: { display: false },
                ticks: { color: secondaryTextColor, font: { family: fontFamily } }
              }
            }
          }
        });

        chartsInitialized = true;
      }

      function drawSparkline(canvasId, data, color) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1;

        // Resize canvas for high DPI
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);

        if (data.length < 2) return;

        const width = rect.width;
        const height = rect.height;
        const max = Math.max(...data) || 1;
        const min = Math.min(...data);
        const range = max - min || 1;

        ctx.clearRect(0, 0, width, height);
        ctx.beginPath();
        ctx.lineWidth = 2;
        ctx.strokeStyle = color;
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';

        const step = width / (data.length - 1);

        for (let i = 0; i < data.length; i++) {
          const x = i * step;
          const y = height - ((data[i] - min) / range) * (height - 4) - 2;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();

        // Create gradient fill
        const grad = ctx.createLinearGradient(0, 0, 0, height);
        grad.addColorStop(0, color.replace('1)', '0.2)'));
        grad.addColorStop(1, color.replace('1)', '0)'));
        ctx.lineTo(width, height);
        ctx.lineTo(0, height);
        ctx.fillStyle = grad;
        ctx.fill();
      }

      function updateCharts() {
        if (!chartsInitialized) initCharts();
        if (!charts.overtime) return;

        try {
          let totalBase = 0, totalTravel = 0, totalOtPay = 0;
          let countAll = 0;

          let totalBase3M = 0, totalTravel3M = 0, totalOtPay3M = 0;
          let count3M = 0;

          const today = new Date();
          const threeMonthsAgo = new Date();
          threeMonthsAgo.setMonth(today.getMonth() - 3);

          tableData.forEach(entry => {
            if (!entry.date) return;
            const eDate = parseDateSafe(entry.date);
            const mKey = entry.date.slice(0, 7).replace(/\//g, '-');

            const isSelected = !selectedMonth || mKey === selectedMonth;
            if (isSelected) {
              totalBase += safeParseFloat(entry.base || 0);
              totalTravel += safeParseFloat(entry.travel || 0);
              totalOtPay += safeParseFloat(entry.otSalary || 0);
              countAll++;
            }

            // Last 3 Months
            if (eDate >= threeMonthsAgo && eDate <= today) {
              totalBase3M += safeParseFloat(entry.base || 0);
              totalTravel3M += safeParseFloat(entry.travel || 0);
              totalOtPay3M += safeParseFloat(entry.otSalary || 0);
              count3M++;
            }
          });

          // Calculate Averages for Pie Charts
          // For All Time: find unique months in the selection
          const targetMonths = new Set(tableData.filter(e => {
            if (!e.date) return false;
            const mKey = e.date.slice(0, 7).replace(/\//g, '-');
            return !selectedMonth || mKey === selectedMonth;
          }).map(e => e.date.slice(0, 7)));
          const numMonthsAll = targetMonths.size || 1;

          // For 3 Months: find unique months in the 3M range
          const targetMonths3M = new Set(tableData.filter(e => {
            if (!e.date) return false;
            const eDate = parseDateSafe(e.date);
            return eDate >= threeMonthsAgo && eDate <= today;
          }).map(e => e.date.slice(0, 7)));
          const numMonths3M = targetMonths3M.size || 1;

          const avgAll = [totalBase / numMonthsAll, totalTravel / numMonthsAll, totalOtPay / numMonthsAll];
          const avg3M = [totalBase3M / numMonths3M, totalTravel3M / numMonths3M, totalOtPay3M / numMonths3M];

          const allMonthsData = {};
          const allMonthsAttendance = {};
          const allMonthsSalaryComponents = {};

          tableData.forEach(e => {
            if (!e.date || e.date.length < 7) return;
            const k = e.date.slice(0, 7).replace(/\//g, '-');
            if (allMonthsData[k] === undefined) {
              allMonthsData[k] = 0;
              allMonthsAttendance[k] = { work: 0, travel: 0 };
              allMonthsSalaryComponents[k] = { base: 0, ot: 0, travel: 0 };
            }
            allMonthsData[k] += !!e.isLeave ? 0 : safeParseFloat(e.otSum || 0);
            const isTravel = (e.travelCountry && e.travelCountry !== 'None') || (safeParseFloat(e.travel || 0) > 0);
            const date = parseDateSafe(e.date);
            const isWeekend = (date.getDay() === 0 || date.getDay() === 6);
            const isOffice = (!e.isLeave && !isWeekend) || (safeParseFloat(e.otSum || 0) > 0);
            if (isTravel) allMonthsAttendance[k].travel++;
            if (isOffice) allMonthsAttendance[k].work++;
            allMonthsSalaryComponents[k].ot += safeParseFloat(e.otSalary || 0);
            allMonthsSalaryComponents[k].travel += safeParseFloat(e.travel || 0);
          });

          let salaryHistory = globalSettings.salaryHistory || [];
          Object.keys(allMonthsSalaryComponents).forEach(k => {
            const applicable = salaryHistory.find(h => h.date <= k) || salaryHistory[salaryHistory.length - 1];
            allMonthsSalaryComponents[k].base = applicable ? safeParseFloat(applicable.amount) : 68000;
          });

          const sortedMonths = Object.keys(allMonthsData).sort();

          // Update Overtime Chart
          charts.overtime.data.labels = sortedMonths;
          charts.overtime.data.datasets[0].data = sortedMonths.map(m => allMonthsData[m]);
          charts.overtime.update();

          // Update Income Charts
          charts.income.data.datasets[0].data = avgAll;
          charts.income.update();

          charts.income3M.data.datasets[0].data = avg3M;
          charts.income3M.update();

          // Update Attendance Chart
          charts.attendance.data.labels = sortedMonths;
          charts.attendance.data.datasets[0].data = sortedMonths.map(m => allMonthsAttendance[m].work);
          charts.attendance.data.datasets[1].data = sortedMonths.map(m => allMonthsAttendance[m].travel);
          charts.attendance.update();

          // Update Salary Trend
          charts.salaryTrend.data.labels = sortedMonths;
          charts.salaryTrend.data.datasets[0].data = sortedMonths.map(m => allMonthsSalaryComponents[m].base);
          charts.salaryTrend.data.datasets[1].data = sortedMonths.map(m => Math.round(allMonthsSalaryComponents[m].ot));
          charts.salaryTrend.data.datasets[2].data = sortedMonths.map(m => Math.round(allMonthsSalaryComponents[m].travel));
          charts.salaryTrend.update();
        } catch (err) { console.error('[OT] updateCharts failed:', err); }
      }

      // 更新統計卡片
      function updateAnalyticsStats() {
        let workDays = 0;
        let totalOT = 0;
        let travelDays = 0;
        let totalIncome = 0;
        let totalOTSalary = 0;
        let totalTravelAllowance = 0;

        let weekdayDays = 0;
        let weekendDays = 0;
        let thisMonthIncome = 0;

        let totalIncomeLastYear = 0;
        let thisMonthOTHours = 0;

        const today = new Date();
        const currentMonthKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        const oneYearAgo = new Date();
        oneYearAgo.setFullYear(today.getFullYear() - 1);

        // 根據篩選器決定計算範圍
        const targetData = selectedMonth
          ? tableData.filter(e => e.date && e.date.replace(/\//g, '-').startsWith(selectedMonth))
          : tableData;

        targetData.forEach(entry => {
          if (!entry.date) return;

          const isLeave = !!entry.isLeave;
          const leaveType = entry.leaveType || '';

          // [Audit Fix] 採用與圖表一致的包容性邏輯
          const isTrv = (entry.travelCountry && entry.travelCountry !== 'None') || (parseFloat(entry.travel || 0) > 0);
          // Force local time parsing
          const date = parseDateSafe(entry.date);
          const dayNum = date.getDay();
          const isWknd = (dayNum === 0 || dayNum === 6);
          const otVal = parseFloat(entry.otSum || 0);

          // 每月出席狀況邏輯優化：有出差就是有上班，或者是平日且沒請假，或者是週末有加班
          const isWk = isTrv || (otVal > 0) || (!isWknd && !isLeave);

          if (isWk) {
            workDays++;
            totalOT += otVal;
          }
          if (isTrv) {
            travelDays++;
          }
          totalTravelAllowance += parseFloat(entry.travel || 0);

          const otSal = parseFloat(entry.otSalary || 0);
          totalOTSalary += otSal;

          const income = parseFloat(entry.total || 0);
          totalIncome += income;

          // 判斷平日/週末 (統計加班次數與天數)
          if (dayNum === 0 || dayNum === 6) {
            if (otVal > 0) weekendDays++;
          } else {
            if (otVal > 0) weekdayDays++;
          }

          // 如果未選月份，則統計「當前這個月」的收入作為本月收入
          if (!selectedMonth) {
            if (entry.date.startsWith(currentMonthKey)) {
              thisMonthIncome += income;
              thisMonthOTHours += otVal;
            }
          } else {
            // If selectedMonth is current, also update thisMonthOTHours
            if (entry.date.startsWith(currentMonthKey)) {
              thisMonthOTHours += otVal;
            }
          }

          // Last Year Income
          if (date >= oneYearAgo && date <= today) {
            totalIncomeLastYear += income;
          }
        });

        // 如果有選月份，「本月收入」就顯示該月收入
        if (selectedMonth) {
          thisMonthIncome = totalIncome;
        }

        // --- 專業指標計算 ---

        // 1. 平均計算
        const avgDaily = workDays > 0 ? totalIncome / workDays : 0;
        const uniqueMonths = new Set(targetData.map(e => e.date.slice(0, 7))).size;
        const avgMonthly = uniqueMonths > 0 ? totalIncome / uniqueMonths : totalIncome;
        const avgAnnual = avgMonthly * 12;

        // 2. 實質時薪 (有效)：總收入 / (標準工時 + 加班工時)
        const standardWorkHours = workDays * 8;
        const totalWorkHours = standardWorkHours + totalOT;
        const effectiveHourly = totalWorkHours > 0 ? totalIncome / totalWorkHours : 0;

        // 3. 出差補貼佔比：出差加給 / 總收入
        const travelRatio = totalIncome > 0 ? (totalTravelAllowance / totalIncome) * 100 : 0;

        // 4. 加班貢獻度：加班費 / 總收入
        const otImpact = totalIncome > 0 ? (totalOTSalary / totalIncome) * 100 : 0;

        // --- DOM 更新 ---
        const setEl = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.textContent = val;
        };

        // 統計日期範圍 (yy/mm/dd-yy/mm/dd)
        if (targetData.length > 0) {
          // 先按日期排序
          const sorted = [...targetData].sort((a, b) => parseDateSafe(a.date) - parseDateSafe(b.date));
          const first = parseDateSafe(sorted[0].date);
          const last = parseDateSafe(sorted[sorted.length - 1].date);

          const fmtDate = (d) => {
            const yy = String(d.getFullYear()).slice(-2);
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yy}/${mm}/${dd}`;
          };
          setEl('statDateRange', `${fmtDate(first)}-${fmtDate(last)}`);
        } else {
          setEl('statDateRange', '--/--/-- - --/--/--');
        }

        const fmt = (n) => Math.round(n).toLocaleString();
        const pct = (n) => n.toFixed(1) + '%';

        setEl('statWorkDays', workDays);
        setEl('statTravelDays', travelDays);
        setEl('statWeekdayDays', weekdayDays);
        setEl('statWeekendDays', weekendDays);

        setEl('statAvgDaily', fmt(avgDaily));
        setEl('statAvgHourly', fmt(effectiveHourly)); // 舊 ID 保留但內容改為有效時薪，或者新增 ID
        setEl('statEffectiveHourly', fmt(effectiveHourly));
        setEl('statAvgMonthly', fmt(avgMonthly));

        setEl('statTotalIncome', fmt(totalIncome));
        setEl('statTotalIncomeLastYear', fmt(totalIncomeLastYear));
        setEl('statThisMonthIncome', fmt(thisMonthIncome));
        setEl('statOTHours', totalOT.toFixed(1));
        setEl('statOTHoursThisMonth', '+' + thisMonthOTHours.toFixed(1));
        setEl('statAvgAnnual', fmt(avgAnnual));

        setEl('statTravelRatio', pct(travelRatio));
        setEl('statOTImpact', pct(otImpact));

        // --- Sparkline Rendering (Last 6 Months Trend) ---
        try {
          const monthStats = {};
          const last6Months = [];
          const now = new Date();
          for (let i = 5; i >= 0; i--) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
            monthStats[key] = { travelDays: 0, otHours: 0, travelPay: 0, otPay: 0 };
            last6Months.push(key);
          }

          tableData.forEach(entry => {
            if (!entry.date) return;
            const eDate = parseDateSafe(entry.date);
            const mKey = eDate.getFullYear() + '-' + String(eDate.getMonth() + 1).padStart(2, '0');
            if (monthStats[mKey]) {
              monthStats[mKey].travelDays += (entry.travelDays || entry.v133 ? 1 : 0); // Simplified check
              monthStats[mKey].otHours += safeParseFloat(entry.totalOtHoursNumeric || 0);
              monthStats[mKey].travelPay += safeParseFloat(entry.travel || 0);
              monthStats[mKey].otPay += safeParseFloat(entry.otSalary || 0);
            }
          });

          drawSparkline('travelSparkline', last6Months.map(m => monthStats[m].travelDays), 'rgba(52, 199, 89, 1)');
          drawSparkline('otSparkline', last6Months.map(m => monthStats[m].otHours), 'rgba(255, 149, 0, 1)');
          drawSparkline('travelPaySparkline', last6Months.map(m => monthStats[m].travelPay), 'rgba(0, 122, 255, 1)');
          drawSparkline('otPaySparkline', last6Months.map(m => monthStats[m].otPay), 'rgba(139, 92, 246, 1)');
        } catch (err) {
          console.error('[OT] Sparkline Error:', err);
        }
      }

      // Overview 頁面的匯率更新按鈕
      const refreshOverviewBtn = document.getElementById('refreshRateOverviewBtn');
      if (refreshOverviewBtn) {
        refreshOverviewBtn.addEventListener('click', async () => {
          refreshOverviewBtn.disabled = true;
          const icon = refreshOverviewBtn.querySelector('.material-symbols-outlined');
          if (icon) icon.style.animation = 'spin 1s linear infinite';

          try {
            if (typeof google !== 'undefined' && google.script && google.script.run) {
              google.script.run
                .withSuccessHandler((rate) => {
                  document.getElementById('usdRate').value = rate.toFixed(2);
                  updateAll();
                  showNotification(`✅ 匯率已更新: 1 USD = ${rate.toFixed(2)} TWD`);
                  refreshOverviewBtn.disabled = false;
                  if (icon) icon.style.animation = '';
                })
                .withFailureHandler(() => {
                  showNotification('❌ 匯率更新失敗，請檢查網路連線', true);
                  refreshOverviewBtn.disabled = false;
                  if (icon) icon.style.animation = '';
                })
                .getExchangeRate('USD', 'TWD', true);
            } else {
              showNotification('⚠️ 僅在 Apps Script 環境中可用', true);
              refreshOverviewBtn.disabled = false;
              if (icon) icon.style.animation = '';
            }
          } catch (err) {
            refreshOverviewBtn.disabled = false;
            if (icon) icon.style.animation = '';
          }
        });
      }

      // Ripple 效果函數
      function createRipple(event, button) {
        const ripple = document.createElement('span');
        ripple.classList.add('ripple');

        const rect = button.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = event.clientX - rect.left - size / 2;
        const y = event.clientY - rect.top - size / 2;

        ripple.style.width = ripple.style.height = size + 'px';
        ripple.style.left = x + 'px';
        ripple.style.top = y + 'px';

        button.appendChild(ripple);

        setTimeout(() => ripple.remove(), 600);
      }

      // 暴露給全域
      window.updateCharts = updateCharts;
      window.updateAnalyticsStats = updateAnalyticsStats;
      window.populateMonthFilter = populateMonthFilter;
      window.initCharts = initCharts;

      // To make sure updateMonthStatsDOM is available globally for updateAll to call:
      window.updateMonthStatsDOM = function () {
        const monthHeaders = document.querySelectorAll('.month-header');
        if (!monthHeaders.length) return;

        // Calculate sums per month using the same logic as renderDataList
        const monthSums = {};
        tableData.forEach(d => {
          if (!d.date) return;
          const m = d.date.slice(0, 7);
          if (!monthSums[m]) monthSums[m] = { ot: 0, trv: 0, slr: 0 };

          monthSums[m].ot += (parseFloat(d.otSalary) || 0);
          monthSums[m].trv += (parseFloat(d.travel) || 0);
          if (d.monthSLR) monthSums[m].slr = parseFloat(d.monthSLR);
        });

        monthHeaders.forEach(header => {
          const mKey = header.dataset.monthKey;
          if (mKey && monthSums[mKey]) {
            const sums = monthSums[mKey];

            // Update Travel Chip (Blue)
            const trvChip = header.querySelector('.travel-chip span:nth-child(2)');
            if (trvChip) trvChip.textContent = Math.round(sums.trv).toLocaleString();

            // Update Yellow Chip (OT)
            const otChip = header.querySelector('.ot-chip span:nth-child(2)');
            if (otChip) otChip.textContent = '+' + Math.round(sums.ot).toLocaleString();

            // Update Salary Chip (Month SLR)
            const salChip = header.querySelector('.salary-chip');
            if (salChip) {
              const spans = salChip.querySelectorAll('span');
              if (spans.length >= 2) spans[1].textContent = Math.round(sums.slr).toLocaleString();
            }
          }
        });
      };

      // --- Salary History Modal Logic ---
      let currentSalaryIndex = -1; // -1 for new, else index in history

      window.openSalaryModal = function () {
        const modal = document.getElementById('salaryModal');
        modal.classList.add('active');
        renderSalaryList();
      };

      window.openTravelRateModal = function () {
        // Compatibility: redirect to card toggle
        toggleTravelRateCard();
        const card = document.getElementById('travelRateCard');
        if (card) card.scrollIntoView({ behavior: 'smooth' });
      };

      window.openLeaveManagementModal = function () {
        // Compatibility: redirect to card toggle
        toggleLeaveManagementCard();
        const card = document.getElementById('leaveManagementCard');
        if (card) card.scrollIntoView({ behavior: 'smooth' });
      };

      window.closeSalaryModal = function () {
        document.getElementById('salaryModal').classList.remove('active');
      };
      window.closeTravelRateModal = function () {
        const body = document.getElementById('travelRateBody');
        if (body) body.classList.remove('open');
      };
      window.closeLeaveManagementModal = function () {
        const body = document.getElementById('leaveManagementBody');
        if (body) body.classList.remove('open');
      };

      function getSalaryHistory() {
        if (!globalSettings.salaryHistory || globalSettings.salaryHistory.length === 0) {
          globalSettings.salaryHistory = [{ date: '2024-01', amount: 68000 }];
        }
        return globalSettings.salaryHistory.sort((a, b) => b.date.localeCompare(a.date));
      }

      function saveSalaryHistory(history) {
        globalSettings.salaryHistory = history;
        storage.set('globalSettings', JSON.stringify(globalSettings));
      }

      let salaryEditState = {}; // index -> { date, amount }

      function renderSalaryList() {
        const list = document.getElementById('salaryList');
        const history = getSalaryHistory();
        list.innerHTML = '';

        history.forEach((item, index) => {
          const div = document.createElement('div');
          div.className = 'salary-item';
          div.dataset.index = index;

          const isEditing = !!salaryEditState[index];
          const displayItem = isEditing ? salaryEditState[index] : item;
          const [year, month] = displayItem.date.split('-');

          div.innerHTML = `
          <div class="salary-date-steppers" style="display:flex; gap:4px;">
            <div class="stepper-btn salary-year-stepper" data-index="${index}" data-type="year">${year}</div>
            <div class="stepper-btn salary-month-stepper" data-index="${index}" data-type="month">${month}</div>
          </div>
          <input type="number" value="${displayItem.amount}" oninput="onSalaryAmountInput(${index}, this.value)" style="width:100px;">
          <div class="salary-actions">
            <span class="material-symbols-outlined btn-v" onclick="confirmSalaryEdit(${index})" style="${isEditing ? '' : 'display:none'}">check_circle</span>
            <span class="material-symbols-outlined btn-x" onclick="cancelSalaryEdit(${index})" style="${isEditing ? '' : 'display:none'}">cancel</span>
            <span class="material-symbols-outlined btn-del" onclick="deleteSalaryItem(${index})" style="${isEditing ? 'display:none' : ''}">delete</span>
          </div>
        `;
          list.appendChild(div);
        });
        initSalaryStepperEvents();

        // Update Salary Summary
        const summaryVal = document.getElementById('currentSalaryVal');
        const annualVal = document.getElementById('estimatedAnnualSalary');
        if (summaryVal && annualVal && history.length > 0) {
          const current = history[0].amount; // History is sorted desc
          summaryVal.textContent = Math.round(current).toLocaleString();

          // Calculate average salary from history
          const avg = history.reduce((acc, cur) => acc + cur.amount, 0) / history.length;
          annualVal.textContent = Math.round(avg * 12).toLocaleString();
        }
      }

      window.onSalaryAmountInput = function (index, val) {
        const history = getSalaryHistory();
        const amount = parseFloat(val) || 0;

        const itemDiv = document.querySelector(`.salary-item[data-index="${index}"]`);
        if (!salaryEditState[index]) {
          salaryEditState[index] = { ...history[index] };
          // Show confirm/cancel buttons on first change
          if (itemDiv) {
            itemDiv.querySelector('.btn-v').style.display = '';
            itemDiv.querySelector('.btn-x').style.display = '';
            itemDiv.querySelector('.btn-del').style.display = 'none';
          }
        }
        salaryEditState[index].amount = amount;
      };

      window.confirmSalaryEdit = function (index) {
        if (!salaryEditState[index]) return;
        const history = getSalaryHistory();
        history[index] = { ...salaryEditState[index] };
        delete salaryEditState[index];
        storage.set('salaryHistory', JSON.stringify(history));
        updateAll();
        renderSalaryList();
        showNotification('✅ 薪資紀錄已更新');
      };

      window.cancelSalaryEdit = function (index) {
        delete salaryEditState[index];
        renderSalaryList();
      };

      // --- Travel Rate Logic ---
      let travelEditState = {}; // country -> { rate }

      function renderTravelRateList() {
        const list = document.getElementById('travelRateList');
        if (!list) return;
        const rates = getTravelRates();
        list.innerHTML = '';

        Object.keys(rates).forEach(country => {
          const div = document.createElement('div');
          div.className = 'salary-item';
          div.dataset.country = country;

          const isEditing = !!travelEditState[country];
          const displayRate = isEditing ? travelEditState[country].rate : rates[country];

          div.innerHTML = `
          <div style="font-weight:600; font-size:0.9rem; padding: 0 8px;">${country}</div>
          <input type="number" value="${displayRate}" oninput="onTravelRateInput('${country}', this.value)" style="width:100px;">
          <div class="salary-actions">
            <span class="material-symbols-outlined btn-v" onclick="confirmTravelRateEdit('${country}')" style="${isEditing ? '' : 'display:none'}">check_circle</span>
            <span class="material-symbols-outlined btn-x" onclick="cancelTravelRateEdit('${country}')" style="${isEditing ? '' : 'display:none'}">cancel</span>
            <span class="material-symbols-outlined btn-del" onclick="deleteTravelRate('${country}')" style="${isEditing ? 'display:none' : ''}">delete</span>
          </div>
        `;
          list.appendChild(div);
        });
      }

      window.onTravelRateInput = function (country, val) {
        const rates = getTravelRates();
        const rate = parseFloat(val) || 0;

        const itemDiv = document.querySelector(`.salary-item[data-country="${country}"]`);
        if (!travelEditState[country]) {
          travelEditState[country] = { rate: rates[country] };
          if (itemDiv) {
            itemDiv.querySelector('.btn-v').style.display = '';
            itemDiv.querySelector('.btn-x').style.display = '';
            itemDiv.querySelector('.btn-del').style.display = 'none';
          }
        }
        travelEditState[country].rate = rate;
      };

      window.confirmTravelRateEdit = function (country) {
        if (!travelEditState[country]) return;
        const rates = getTravelRates();
        rates[country] = travelEditState[country].rate;
        delete travelEditState[country];
        globalSettings.travelRates = rates;
        storage.set('globalSettings', JSON.stringify(globalSettings));
        renderTravelRateList();
        showNotification(`✅ ${country} 費率已更新`);
      };

      window.cancelTravelRateEdit = function (country) {
        delete travelEditState[country];
        renderTravelRateList();
      };

      window.deleteTravelRate = function (country) {
        if (!confirm(`確定要刪除 ${country} 的費率嗎？`)) return;
        const rates = getTravelRates();
        delete rates[country];
        globalSettings.travelRates = rates;
        storage.set('globalSettings', JSON.stringify(globalSettings));
        renderTravelRateList();
      };

      // --- Leave Management Logic ---
      window.saveLeaveQuota = function (val) {
        storage.set('annualLeaveQuota', val);
        updateAll();
      };

      function getLeaveQuota() {
        return parseFloat(storage.get('annualLeaveQuota')) || 5.25;
      }

      function updateLeaveSummaryDOM() {
        const quota = getLeaveQuota();
        let used = 0;
        tableData.forEach(entry => {
          if (entry.isLeave && entry.leaveType === '特休') {
            used += (parseFloat(entry.leaveAmount) || 0);
          }
        });
        const remaining = quota - used;
        const el = document.getElementById('leaveSummaryUI');
        if (el) {
          el.innerHTML = `
          <div style="font-weight: 700; color: var(--color-primary); font-size: 1rem; margin-bottom: 4px;">
            共 ${quota} 天 / 剩 ${remaining} 天
          </div>
          <div style="color: #666; font-size: 0.85rem;">
            年度特休: ${quota} 天<br>
            已請天數: ${used} 天<br>
            <span style="opacity: 0.7;">(由系統自動加總特休記錄)</span>
          </div>
        `;
        }
        const input = document.getElementById('annualLeaveQuoata');
        if (input && document.activeElement !== input) {
          input.value = quota;
        }
      }

      window.addTravelRateRecord = function () {
        const country = prompt('請輸入出差地區名稱（例如：USA）:');
        if (!country) return;
        const rates = getTravelRates();
        if (rates[country]) {
          alert('該地區已存在');
          return;
        }
        rates[country] = 40;
        globalSettings.travelRates = rates;
        storage.set('globalSettings', JSON.stringify(globalSettings));
        renderTravelRateList();
      };

      let ratesInProgress = false;
      function initDefaultChinaRate() {
        if (ratesInProgress) return;
        const rates = getTravelRates();
        // Only auto-update if it's the old default values
        if (rates['China'] === 160.25 || rates['China'] === 32.05) {
          ratesInProgress = true;
          google.script.run.withSuccessHandler(rate => {
            ratesInProgress = false;
            if (rate) {
              const chinaUsd = Math.round(250 * rate * 100) / 100; // 250 HKD
              const currentRates = getTravelRates();
              currentRates['China'] = chinaUsd;
              saveTravelRates(currentRates);
              renderTravelRateList();
              console.log(`[OT] China rate updated to ${chinaUsd} USD (250 HKD)`);
            }
          }).withFailureHandler(() => {
            ratesInProgress = false;
          }).getExchangeRate('HKD', 'USD');
        }
      }

      function initSalaryStepperEvents() {
        const modal = document.getElementById('salaryModal');

        const onMove = (e) => {
          if (!dragState || dragState.type !== 'salary') return;
          const clientY = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;
          const deltaY = dragState.lastY - clientY;
          dragState.lastY = clientY;
          dragState.accumulatedDelta += deltaY;

          const threshold = 40;
          if (Math.abs(dragState.accumulatedDelta) >= threshold) {
            const direction = dragState.accumulatedDelta > 0 ? 1 : -1;
            const history = getSalaryHistory();

            if (!salaryEditState[dragState.index]) {
              salaryEditState[dragState.index] = { ...history[dragState.index] };
            }

            let [year, month] = salaryEditState[dragState.index].date.split('-').map(Number);

            if (dragState.subType === 'year') {
              year += direction;
            } else {
              month += direction;
              if (month > 12) { month = 1; year++; }
              if (month < 1) { month = 12; year--; }
            }

            salaryEditState[dragState.index].date = `${year}-${String(month).padStart(2, '0')}`;
            renderSalaryList();

            dragState.accumulatedDelta = 0;
          }
        };

        const mouseUp = () => {
          if (dragState && dragState.type === 'salary') {
            dragState.el.classList.remove('active');
            document.body.classList.remove('is-dragging');
            dragState = null;
          }
        };

        modal.addEventListener('mousedown', (e) => {
          const stepper = e.target.closest('.stepper-btn');
          if (!stepper || (!stepper.classList.contains('salary-year-stepper') && !stepper.classList.contains('salary-month-stepper'))) return;

          document.body.classList.add('is-dragging');

          dragState = {
            type: 'salary',
            subType: stepper.dataset.type,
            index: parseInt(stepper.dataset.index),
            el: stepper,
            lastY: e.clientY,
            accumulatedDelta: 0
          };
          stepper.classList.add('active');
        });

        modal.addEventListener('touchstart', (e) => {
          const stepper = e.target.closest('.stepper-btn');
          if (!stepper || (!stepper.classList.contains('salary-year-stepper') && !stepper.classList.contains('salary-month-stepper'))) return;

          e.preventDefault();
          document.body.classList.add('is-dragging');

          dragState = {
            type: 'salary',
            subType: stepper.dataset.type,
            index: parseInt(stepper.dataset.index),
            el: stepper,
            lastY: e.touches[0].clientY,
            accumulatedDelta: 0
          };
          stepper.classList.add('active');
        }, { passive: false });

        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', mouseUp);
        window.addEventListener('touchmove', onMove, { passive: false });
        window.addEventListener('touchend', mouseUp);
      }

      window.updateSalaryItem = function (index, key, value) {
        const history = getSalaryHistory();
        history[index][key] = key === 'amount' ? parseFloat(value) : value;
        storage.set('salaryHistory', JSON.stringify(history));
        updateAll();
      };

      window.addSalaryRecord = function () {
        const history = getSalaryHistory();
        const last = history[0] || { date: '2024-01', amount: 68000 };
        history.unshift({ date: last.date, amount: last.amount });
        saveSalaryHistory(history);
        renderSalaryList();
        updateAll();
      };

      window.deleteSalaryItem = function (index) {
        const history = getSalaryHistory();
        if (history.length <= 1) {
          showNotification('⚠️ 至少需要一筆薪資紀錄', true);
          return;
        }
        history.splice(index, 1);
        saveSalaryHistory(history);
        renderSalaryList();
        updateAll();
      };

      // ========== Smart Stepper 拖曳互動 ==========
      let dragState = null;

      function initSmartStepperEvents() {
        const container = document.getElementById('tableContainer');
        if (!container) return;

        container.addEventListener('mousedown', (e) => {
          const stepper = e.target.closest('.smart-stepper');
          if (!stepper) return;

          e.preventDefault();
          const entryIndex = parseInt(stepper.dataset.entryIndex);
          const key = stepper.dataset.key;
          const entry = tableData[entryIndex];

          dragState = {
            stepper,
            entry,
            key,
            startY: e.clientY,
            lastY: e.clientY,
            accumulatedDelta: 0,
          };

          stepper.classList.add('active');
        });

        document.addEventListener('mousemove', (e) => {
          if (!dragState) return;

          e.preventDefault();
          const deltaY = dragState.lastY - e.clientY; // 上拉為正，下拉為負
          dragState.lastY = e.clientY;
          dragState.accumulatedDelta += deltaY;

          // 每移動30px觸發一次調整（0.5小時）
          const threshold = 30;
          if (Math.abs(dragState.accumulatedDelta) >= threshold) {
            const steps = Math.floor(Math.abs(dragState.accumulatedDelta) / threshold);
            const direction = dragState.accumulatedDelta > 0 ? 1 : -1;

            for (let i = 0; i < steps; i++) {
              adjustOTValue(dragState.entry, dragState.key, direction);
            }

            // 更新視覺
            if (dragState.key === 'vH' || dragState.key === 'vM') {
              const [h, m] = dragState.entry.endTime.split(':');
              dragState.stepper.textContent = (dragState.key === 'vH') ? h : m;
            } else {
              dragState.stepper.textContent = dragState.entry[dragState.key].toFixed(1);
            }
            dragState.stepper.classList.add('has-value');

            const card = dragState.stepper.closest('.data-card');
            if (card) {
              const entry = dragState.entry;
              const otTotal = entry.totalOtHoursNumeric || (Number(entry.v167 || 0) + Number(entry.v134 || 0) + Number(entry.v166 || 0) + Number(entry.v267 || 0));
              const val = otTotal.toFixed(1);
              const badge = card.querySelector('.scoreboard-badge');
              if (badge) {
                badge.textContent = val;
                badge.className = 'scoreboard-badge'; // reset
                const numericVal = parseFloat(val);
                if (numericVal >= 2 && numericVal < 3) badge.classList.add('green');
                else if (numericVal >= 3 && numericVal < 4) badge.classList.add('yellow');
                else if (numericVal >= 4 && numericVal < 5) badge.classList.add('orange');
                else if (numericVal >= 5 && numericVal < 6) badge.classList.add('red');
                else if (numericVal >= 6) badge.classList.add('purple');
              }

              // 更新 Daily OT Chip
              const dailyChip = card.querySelector('.daily-total-chip span');
              if (dailyChip) dailyChip.textContent = `+${Math.round(entry.total)}`;
            }

            // Also Trigger Month Header Update from Stepper Drag? 
            // No, drag adjusts values directly for UI, but doesn't call updateAll until end?
            // Wait, current logic calls adjustOTValue -> updateAll(null, true).
            // So updateMonthStatsDOM() is already called in updateAll.

            dragState.accumulatedDelta = dragState.accumulatedDelta % threshold;
          }
        });


        // Mouse Up
        document.addEventListener('mouseup', () => {
          if (dragState) {
            dragState.stepper.classList.remove('active');
            dragState = null;
          }
        });

        // Touch Start
        container.addEventListener('touchstart', (e) => {
          const stepper = e.target.closest('.smart-stepper');
          if (!stepper) return;

          const touch = e.touches[0];
          const entryIndex = parseInt(stepper.dataset.entryIndex);
          const key = stepper.dataset.key;
          const entry = tableData[entryIndex];

          dragState = {
            stepper,
            entry,
            key,
            startY: touch.clientY,
            lastY: touch.clientY,
            accumulatedDelta: 0,
          };

          stepper.classList.add('active');
        });

        // Touch Move
        document.addEventListener('touchmove', (e) => {
          if (!dragState) return;

          // e.preventDefault(); // Passive false handled at attachment
          if (e.cancelable) e.preventDefault();

          const touch = e.touches[0];
          const deltaY = dragState.lastY - touch.clientY;
          dragState.lastY = touch.clientY;
          dragState.accumulatedDelta += deltaY;

          const threshold = 30;
          if (Math.abs(dragState.accumulatedDelta) >= threshold) {
            const steps = Math.floor(Math.abs(dragState.accumulatedDelta) / threshold);
            const direction = dragState.accumulatedDelta > 0 ? 1 : -1;

            for (let i = 0; i < steps; i++) {
              adjustOTValue(dragState.entry, dragState.key, direction);
            }

            dragState.stepper.textContent = dragState.entry[dragState.key].toFixed(1);
            if (dragState.entry[dragState.key] > 0) {
              dragState.stepper.classList.add('has-value');
            } else {
              dragState.stepper.classList.remove('has-value');
            }

            // Scoreboard (Touch)
            const card = dragState.stepper.closest('.data-card');
            if (card) {
              const entry = dragState.entry;
              const otTotal = entry.totalOtHoursNumeric || (Number(entry.v167 || 0) + Number(entry.v134 || 0) + Number(entry.v166 || 0) + Number(entry.v267 || 0));
              const val = otTotal.toFixed(1);
              const badge = card.querySelector('.scoreboard-badge');
              if (badge) {
                badge.textContent = val;
                badge.className = 'scoreboard-badge';
                const numericVal = parseFloat(val);
                if (numericVal >= 2 && numericVal < 3) badge.classList.add('emerald');
                else if (numericVal >= 3 && numericVal < 4) badge.classList.add('blue');
                else if (numericVal >= 4 && numericVal < 5) badge.classList.add('amber');
                else if (numericVal >= 5) badge.classList.add('crimson');
              }
              const dailyChip = card.querySelector('.daily-total-chip span');
              if (dailyChip) dailyChip.textContent = `+${Math.round(entry.total || 0)}`;
            }

            dragState.accumulatedDelta = dragState.accumulatedDelta % threshold;
          }
        }, { passive: false });

        // Touch End
        document.addEventListener('touchend', () => {
          if (dragState) {
            dragState.stepper.classList.remove('active');
            dragState = null;
          }
        });
      }


      function initTabNavigation() {
        const tabBtns = document.querySelectorAll('.tab-navigation .tab-btn');
        if (tabBtns.length > 0) {
          tabBtns.forEach(btn => {
            // We only have one button now (Dashboard Toggle).
            // Logic handled separately.
          });
        }
      }

      // New Toggle Button Logic (Header)
      const toggleBtn = document.getElementById('viewToggleBtn');
      const logoCard = document.getElementById('logoCard');

      function switchToAnalytics() {
        document.getElementById('overview-tab').classList.remove('active');
        document.getElementById('analytics-tab').classList.add('active');
      }

      function toggleView() {
        const overview = document.getElementById('overview-tab');
        const analytics = document.getElementById('analytics-tab');

        if (overview.classList.contains('active')) {
          // Switch to Analytics
          overview.classList.remove('active');
          analytics.classList.add('active');
          // Update stats
          if (window.charts && window.charts.overtime) window.charts.overtime.resize();
          if (window.charts && window.charts.income) window.charts.income.resize();
          updateCharts();
          updateAnalyticsStats();
        } else {
          // Switch to Overview
          analytics.classList.remove('active');
          overview.classList.add('active');
        }
      }

      if (toggleBtn) {
        toggleBtn.addEventListener('click', toggleView);
      }

      if (logoCard) {
        logoCard.addEventListener('click', () => {
          // User requested: "Clicking homepage logo... analysis page...".
          // So force switch to analytics side.
          const overview = document.getElementById('overview-tab');
          const analytics = document.getElementById('analytics-tab');
          if (overview.classList.contains('active')) {
            toggleView();
          }
        });
      }

      // ========== DOM 載入後初始化 ==========
      document.addEventListener('DOMContentLoaded', () => {
        // 綁定「回傳到 Google Sheet」按鈕
        const saveBtn = document.getElementById('saveToSheetBtn');
        if (saveBtn) {
          saveBtn.addEventListener('click', async () => {
            try {
              saveBtn.disabled = true;
              await saveToSheet();
            } catch (err) {
              console.error('[OT] Save button error:', err);
              alert('上傳發生預期外錯誤: ' + (err.message || err));
            } finally {
              saveBtn.disabled = false;
            }
          });
        }

        // 綁定診斷按鈕
        const diagBtn = document.getElementById('runDiagnosticsBtn');
        if (diagBtn) {
          diagBtn.addEventListener('click', runDiagnostics);
        }

        // 核心初始化流程
        const startApp = async () => {
          try {
            console.log('[OT] Starting initialization...');
            initTheme();
            initTabNavigation();

            // 1. 先處理資料載入
            await loadFromSheet();

            // 2. 處理 UI 相關初始化
            populateMonthFilter();
            initSmartStepperEvents();
            initAddCardSteppers();

            // 3. 最後初始化圖表 (延後以優化首屏感)
            setTimeout(() => {
              try {
                initCharts();
                updateCharts();
                updateAnalyticsStats();
                console.log('[OT] 升級功能已載入 ✅');
              } catch (e) {
                console.error('[OT] Error initializing charts/stats:', e);
              }
            }, isMobile ? 800 : 400);

          } catch (err) {
            console.error('[OT] Application startup failed:', err);
            showNotification('❌ 程式啟動失敗，請重新整理頁面', true);
          }
        };

        startApp();
      });
    })(typeof globalThis !== 'undefined' ? globalThis : this);
  </script>
  <!-- Floating Action Button -->
  <button class="fab"
    onclick="window.scrollTo({top: 0, behavior: 'smooth'}); setTimeout(() => document.getElementById('addRecordSection')?.scrollIntoView({behavior: 'smooth'}), 100);"
    title="新增紀錄">
    <span class="material-symbols-outlined">add</span>
  </button>

</body>

</html>