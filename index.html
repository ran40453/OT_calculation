<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>OT calculation</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script id="init-payload" type="application/json"><?!= INIT_DATA_JSON || '{"data":[]}' ?></script>
  <script>
    // 版本標籤（防止本地環境報錯）
    window.__CW_DEPLOY_TAG = "<?= DEPLOY_TAG ?>";
    if (window.__CW_DEPLOY_TAG && window.__CW_DEPLOY_TAG.startsWith("<" + "?")) window.__CW_DEPLOY_TAG = "LOCAL_DEV";

    // 從 Apps Script 模板注入的初始加班資料
    // 使用 JSON script 區塊讀取，避免本地預覽時語法報錯
    try {
      const rawPayload = document.getElementById('init-payload').textContent;
      window.__OT_INIT_PAYLOAD__ = JSON.parse(rawPayload);
    } catch (e) {
      console.warn('[OT] 無法讀取或解析初始資料:', e);
      window.__OT_INIT_PAYLOAD__ = null;
    }
  </script>
  <?!= include('style'); ?>
</head>

<body>

  <!-- 分頁導航列（固定顯示） -->
  <!-- 分頁導航列（桌面版為左側邊欄，手機版為頂部導航） -->
  <!-- 分頁導航列已移除，改為 Header Toggle -->

  <!-- Global Persistent Header -->
  <div class="header-row" style="padding: 8px 24px 0 24px; margin-bottom: 0;">
    <div class="card header-combined-card"
      style="display: flex; align-items: center; justify-content: space-between; padding: 8px 16px; width: 100%; cursor: default; margin-bottom: 0;">

      <!-- Logo (Left) -->
      <div id="logoCard" style="display: flex; align-items: center; cursor: pointer; gap: 12px;">
        <img
          src="https://static.wixstatic.com/media/f31164_8fb3a217689346059f1c7a5e599fa050~mv2.png/v1/fill/w_282,h_50,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/logoFONT.png"
          alt="OT Logo" class="logo-image" style="max-height: 32px; object-fit: contain;">
      </div>

      <!-- View Toggle (Right in Header) -->
      <button id="viewToggleBtn" aria-label="View Detailed List" class="icon-button"
        onclick="location.href='#tableSection'" title="查看加班明細"
        style="background: rgba(0,0,0,0.05); color: #333; border: 1px solid rgba(0,0,0,0.1); box-shadow: none;">
        <span class="material-symbols-outlined">table_view</span>
      </button>
    </div>
  </div>

  <!-- Overview Tab (原有內容) -->
  <div class="tab-content active" id="overview-tab">
    <div class="container" style="padding-top: 16px;">

      <!-- 左側區域 -->
      <div class="left-panel">
        <!-- 工具 (操作按鈕卡片) -->
        <div class="card actions-card">
          <div class="settings-actions" style="justify-content: center; gap: 16px;">
            <button id="exportCSVCard" class="icon-button">
              <span class="material-symbols-outlined">save</span>
            </button>
            <label for="importCSVCard" class="icon-button file-label">
              <span class="material-symbols-outlined">upload</span>
            </label>
            <button id="saveToSheetBtn" class="icon-button" aria-label="Save to Google Sheet">
              <span class="material-symbols-outlined">cloud_upload</span>
            </button>
            <button id="fillMissingDatesBtn" class="icon-button" aria-label="Fill missing dates">
              <span class="material-symbols-outlined">calendar_month</span>
            </button>

            <button id="privacyToggleBtn" class="icon-button privacy-btn" onclick="togglePrivacyMode()" title="切換隱私模式">
              <span class="material-symbols-outlined">visibility</span>
            </button>
            <button id="themeToggleBtn" class="icon-button theme-btn" onclick="toggleTheme()" title="切換主題 (新擬態/玻璃擬態)">
              <span class="material-symbols-outlined">palette</span>
            </button>
            <input type="file" id="importCSVCard" accept=".csv">
          </div>
        </div>

        <!-- 總計 (Dashboard 總計) -->
        <div class="card dashboard-card" id="dashboardCard">
          <div class="card-header" onclick="toggleDashboardCard()"
            style="padding: 16px 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; text-align: left;">本月統計</h3>
            <span class="material-symbols-outlined card-expand-icon" id="dashboardExpandIcon">expand_less</span>
          </div>

          <div class="expand-wrapper open" id="dashboardBody">
            <div class="expand-inner">
              <div class="dashboard-stats-grid">
                <!-- 群組 1: 次數與時數 -->
                <div class="dashboard-group">
                  <div class="stat-row">
                    <span class="label">出差天數</span>
                    <span class="capsule black" id="travelDays">0</span>
                  </div>
                  <div class="stat-row">
                    <span class="label">加班總時數</span>
                    <span class="capsule black" id="totalOT">0</span>
                  </div>
                </div>

                <!-- 群組 2: 津貼與加班費 -->
                <div class="dashboard-group">
                  <div class="stat-row">
                    <span class="label">Travel 津貼</span>
                    <span class="capsule black" id="totalTravel">0</span>
                  </div>
                  <div class="stat-row">
                    <span class="label">OT 加班費</span>
                    <span class="capsule black" id="totalOTSalary">0</span>
                  </div>
                </div>

                <!-- 總計單獨顯示 -->
                <div class="dashboard-total">
                  <div class="stat-row total-row">
                    <span class="label">總收入</span>
                    <span class="capsule yellow" id="totalCost">0</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 系統工具 (Toolbox - 摺疊設計) -->
        <div class="card system-tools-card" id="toolboxCard">
          <div class="card-header" onclick="toggleToolboxCard()"
            style="padding: 16px 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; text-align: left;">系統工具 (Toolbox)</h3>
            <span class="material-symbols-outlined card-expand-icon" id="toolboxExpandIcon">expand_more</span>
          </div>

          <div class="expand-wrapper" id="toolboxBody">
            <div class="expand-inner">
              <div class="settings-actions"
                style="margin-top: 16px; display: flex; flex-direction: column; gap: 12px; align-items: stretch;">
                <button class="promo-action-btn" onclick="openSalaryModal()">
                  <span class="material-symbols-outlined">payments</span>
                  <span>薪資紀錄管理</span>
                </button>
                <button class="promo-action-btn" onclick="openTravelRateModal()">
                  <span class="material-symbols-outlined">public</span>
                  <span>出差費率設定</span>
                </button>
                <button class="promo-action-btn" onclick="openLeaveManagementModal()">
                  <span class="material-symbols-outlined">person_pin</span>
                  <span>特休給假管理</span>
                </button>
                <button class="promo-action-btn" onclick="openRulesModal()">
                  <span class="material-symbols-outlined">gavel</span>
                  <span>加班計算規則</span>
                </button>
                <button class="promo-action-btn" id="runDiagnosticsBtn" onclick="runDiagnostics()">
                  <span class="material-symbols-outlined">analytics</span>
                  <span>執行系統診斷</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div> <!-- End of left-panel -->

      <!-- 右側區域 -->
      <div class="right-panel">

        <!-- 新增資料卡片 (Smart Stepper 統一設計) -->
        <div class="add-card add-card-circular">
          <div class="add-card-item">
            <label>日期</label>
            <button type="button" id="newDate" class="smart-stepper-add" data-type="date">--/--</button>
          </div>
          <div class="add-card-item">
            <label>Hour</label>
            <button type="button" id="newHour" class="smart-stepper-add" data-type="hour">17</button>
          </div>
          <div class="add-card-item">
            <label>Min</label>
            <button type="button" id="newMinute" class="smart-stepper-add" data-type="minute">30</button>
          </div>
          <div class="add-card-item">
            <label>Holiday</label>
            <button type="button" id="newHolidayToggle" class="smart-stepper-add"
              style="border: none; background: rgba(0,0,0,0.05) !important;">
              <span class="material-symbols-outlined" style="font-size: 20px;">event_busy</span>
            </button>
          </div>
          <div class="add-card-item" id="newLeaveItem">
            <label>Leave</label>
            <div class="leave-capsule-unit" id="leaveCapsuleUnit">
              <button type="button" id="newLeaveToggle" class="smart-stepper-add" title="切換請假狀態">
                <span class="material-symbols-outlined">person</span>
              </button>
              <div class="expandable-wrapper" id="leaveInfoWrapper">
                <div class="expandable-content" style="display: flex; align-items: center; height: 100%;">
                  <div class="add-card-item" id="leaveInfoRow"
                    style="flex-direction: row; gap: 8px; margin-top: 0; padding-top: 0; white-space: nowrap;">
                    <!-- Capsules dynamically injected here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="add-card-item">
            <label>Travel</label>
            <button type="button" id="newTravelCountry" class="smart-stepper-add" data-type="travel">
              <span class="material-symbols-outlined" style="font-size: 20px;">flight</span>
            </button>
          </div>
          <div class="add-card-item">
            <label>&nbsp;</label>
            <button id="addRowCard" class="circular-add-btn-round">
              <span class="material-symbols-outlined">add</span>
            </button>
          </div>
        </div>

        <!-- 表格容器 -->
        <div id="tableContainer">
          <!-- 表格由 JS 動態生成 -->
        </div>

      </div> <!-- End of right-panel -->

    </div> <!-- End of container -->

  </div>
  <!-- End of Overview Tab -->

  <!-- Analytics Tab -->
  <div class="tab-content" id="analytics-tab">
    <div class="analytics-container">

      <!-- 頂部控制列 -->
      <div class="analytics-header">
        <h2>Analytics</h2>
        <div class="month-filter-wrapper">
          <select id="monthFilter" class="month-select">
            <option value="">全部月份</option>
          </select>
        </div>
      </div>

      <!-- 統計專欄區 (Grid 佈局) -->
      <div class="stats-columns">

        <!-- 天數專欄 -->
        <div class="stat-column-card">
          <div class="column-header">
            <span class="material-symbols-outlined icon-blue">calendar_month</span>
            <h3>天數統計</h3>
          </div>
          <div class="stat-list">
            <div class="stat-item">
              <span class="label">統計日期</span>
              <span class="value" id="statDateRange" style="font-size: 0.85rem;">--/--/-- - --/--/--</span>
            </div>
            <div class="stat-item">
              <span class="label">工作天數</span>
              <span class="value" id="statWorkDays">0</span>
            </div>
            <div class="stat-item">
              <span class="label">出差天數</span>
              <span class="value" id="statTravelDays">0</span>
            </div>
            <div class="stat-item">
              <span class="label">平日加班</span>
              <span class="value" id="statWeekdayDays">0</span>
            </div>
            <div class="stat-item">
              <span class="label">週末加班</span>
              <span class="value" id="statWeekendDays">0</span>
            </div>
          </div>
        </div>

        <!-- 薪資專欄 -->
        <div class="stat-column-card">
          <div class="column-header">
            <span class="material-symbols-outlined icon-green">payments</span>
            <h3>薪資概況</h3>
          </div>
          <div class="stat-list">
            <div class="stat-item">
              <span class="label">平均日薪</span>
              <span class="value" id="statAvgDaily">0</span>
            </div>
            <div class="stat-item">
              <span class="label">平均時薪</span>
              <span class="value" id="statAvgHourly">0</span>
            </div>
            <div class="stat-item">
              <span class="label">平均月薪</span>
              <span class="value" id="statAvgMonthly">0</span>
            </div>
            <div class="stat-item highlight-alt">
              <span class="label">實質時薪 (有效)</span>
              <span class="value" id="statEffectiveHourly">0</span>
            </div>
          </div>
        </div>

        <!-- 收入專欄 -->
        <div class="stat-column-card">
          <div class="column-header">
            <span class="material-symbols-outlined icon-orange">savings</span>
            <h3>收入分析</h3>
          </div>
          <div class="stat-list">
            <div class="stat-item"
              style="display: flex; flex-direction: row; justify-content: space-between; align-items: center; gap: 8px;">
              <div style="flex: 1; display: flex; flex-direction: column;">
                <span class="label">總收入 (All)</span>
                <span class="value highlight" id="statTotalIncome">0</span>
              </div>
              <div style="width: 1px; height: 30px; background: rgba(0,0,0,0.1);"></div>
              <div style="flex: 1; display: flex; flex-direction: column; align-items: flex-end;">
                <span class="label">近一年 (1Y)</span>
                <span class="value" id="statTotalIncomeLastYear"
                  style="color: var(--color-primary); font-weight: 700;">0</span>
              </div>
            </div>
            <div class="stat-item">
              <span class="label">本月收入</span>
              <span class="value" id="statThisMonthIncome">0</span>
            </div>
            <div class="stat-item" style="display: flex; align-items: center; justify-content: space-between;">
              <span class="label">加班總時數</span>
              <div style="display: flex; align-items: center; gap: 6px;">
                <span class="value" id="statOTHours">0</span>
                <span class="capsule" id="statOTHoursThisMonth"
                  style="background: var(--color-primary); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; opacity: 0.9;">+0</span>
              </div>
            </div>
            <div class="stat-item">
              <span class="label">出差補貼佔比</span>
              <span class="value" id="statTravelRatio">0%</span>
            </div>
            <div class="stat-item highlight-alt" style="background: rgba(var(--color-primary-rgb), 0.1);">
              <span class="label">平均年薪 (估算)</span>
              <span class="value" id="statAvgAnnual">0</span>
            </div>
          </div>
        </div>

      </div>

      <!-- 圖表區 (Grid 佈局) -->
      <div class="chart-section">
        <div class="chart-card">
          <h3>月度加班趨勢</h3>
          <div style="position: relative; height: 100%; width: 100%;">
            <canvas id="overtimeChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3>收入結構</h3>
          <div style="display: flex; gap: 16px; height: 100%; width: 100%;">
            <div style="flex: 1; position: relative;">
              <div style="font-size: 0.7rem; text-align: center; color: #999; margin-bottom: 4px;">所有資料平均</div>
              <canvas id="incomeChart"></canvas>
            </div>
            <div style="flex: 1; position: relative;">
              <div style="font-size: 0.7rem; text-align: center; color: #999; margin-bottom: 4px;">近三個月平均</div>
              <canvas id="incomeChart3M"></canvas>
            </div>
          </div>
        </div>
        <!-- Attendance Analysis (Merged Office & Travel) -->
        <div class="chart-card">
          <div class="chart-header">
            <span class="material-symbols-outlined icon-blue">analytics</span>
            <h3>月度出勤統計 (Office vs Travel)</h3>
          </div>
          <div class="chart-container" style="position: relative; height: 100%; width: 100%;">
            <canvas id="attendanceChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3>月度薪資趨勢</h3>
          <div style="position: relative; height: 100%; width: 100%;">
            <canvas id="salaryTrendChart"></canvas>
          </div>
        </div>
      </div>

    </div>
  </div>
  <!-- End of Analytics Tab -->

  <!-- 薪資紀錄彈窗 -->
  <div id="salaryModal" class="modal-overlay">
    <div class="modal-content glass-window">
      <div class="modal-header">
        <h3>薪資紀錄管理</h3>
        <button class="icon-button close-btn" onclick="closeSalaryModal()">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <div class="modal-body">
        <section class="salary-section">
          <div id="salaryList" class="salary-record-list"></div>
          <button class="add-salary-btn" onclick="addSalaryRecord()">
            <span class="material-symbols-outlined">add</span>
            <span>新增調薪紀錄</span>
          </button>
        </section>
        <div class="modal-footer">
          <button class="icon-button" onclick="closeSalaryModal()" style="width: 100%; background: #666;">
            <span>關閉視窗</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 出差費率彈窗 -->
  <div id="travelRateModal" class="modal-overlay">
    <div class="modal-content glass-window">
      <div class="modal-header">
        <h3>出差費率設定 (USD)</h3>
        <button class="icon-button close-btn" onclick="closeTravelRateModal()">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="usd-rate-container"
          style="background: rgba(0,122,255,0.05); padding: 12px; border-radius: 12px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
          <span style="font-weight: 600;">美金匯率 (USD Rate)</span>
          <input type="number" id="usdRate" value="32.5" step="0.1"
            style="width: 100px; text-align: right; padding: 4px 8px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1);">
        </div>
        <section class="travel-rate-section">
          <div id="travelRateList" class="salary-record-list"></div>
          <button class="add-salary-btn" onclick="addTravelRateRecord()">
            <span class="material-symbols-outlined">add</span>
            <span>新增出差地區</span>
          </button>
        </section>
        <div class="modal-footer">
          <button class="icon-button" onclick="closeTravelRateModal()" style="width: 100%; background: #666;">
            <span>關閉視窗</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 特休管理彈窗 -->
  <div id="leaveManagementModal" class="modal-overlay">
    <div class="modal-content glass-window">
      <div class="modal-header">
        <h3>特休給假管理</h3>
        <button class="icon-button close-btn" onclick="closeLeaveManagementModal()">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <div class="modal-body">
        <section class="salary-section">
          <div style="background: rgba(0,122,255,0.05); padding: 16px; border-radius: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <span style="font-weight: 600;">核給總時數 (天)</span>
              <input type="number" id="annualLeaveQuoata" value="5.25" step="0.125"
                onchange="saveLeaveQuota(this.value)" style="width: 100px; text-align: right;">
            </div>
            <div id="leaveSummaryUI" style="font-size: 0.9rem; color: #555; line-height: 1.6;"></div>
          </div>
        </section>
        <div class="modal-footer">
          <button class="icon-button" onclick="closeLeaveManagementModal()" style="width: 100%; background: #666;">
            <span>關閉視窗</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 加班計算規則彈窗 -->
  <div id="rulesModal" class="modal-overlay">
    <div class="modal-content glass-window rules-modal-content">
      <div class="modal-header">
        <h3 style="display: flex; align-items: center; gap: 8px;">
          <span class="material-symbols-outlined">calculate</span>
          <span>加班計算規則</span>
        </h3>
        <button class="icon-button close-btn" onclick="closeRulesModal()">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <div class="modal-body no-scrollbar" style="max-height: 75vh; overflow-y: auto;">

        <div class="rules-section">
          <div class="rules-grid">
            <!-- Weekdays -->
            <div class="rule-card">
              <div class="rule-card-header">
                <div class="rule-icon-box blue">
                  <span class="material-symbols-outlined">work</span>
                </div>
                <div>
                  <h4>平日 (Weekdays)</h4>
                  <p>17:30 起算</p>
                </div>
              </div>
              <div class="rule-items">
                <div class="rule-item">
                  <span>前 2 小時 (First 2h)</span>
                  <div class="multiplier-badge green" onclick="editMultiplier('weekday_134')" id="m_weekday_134">1.34x
                  </div>
                </div>
                <div class="rule-item">
                  <span>之後 (Thereafter)</span>
                  <div class="multiplier-badge green" onclick="editMultiplier('weekday_167')" id="m_weekday_167">1.67x
                  </div>
                </div>
              </div>
            </div>

            <!-- Rest Days -->
            <div class="rule-card">
              <div class="rule-card-header">
                <div class="rule-icon-box purple">
                  <span class="material-symbols-outlined">weekend</span>
                </div>
                <div>
                  <h4>例假日 (Rest Days)</h4>
                  <p>週末或休息日</p>
                </div>
              </div>
              <div class="rule-items">
                <div class="rule-item">
                  <span>前 2 小時 (First 2h)</span>
                  <div class="multiplier-badge green" onclick="editMultiplier('weekend_134')" id="m_weekend_134">1.34x
                  </div>
                </div>
                <div class="rule-item">
                  <span>3 - 8 小時</span>
                  <div class="multiplier-badge green" onclick="editMultiplier('weekend_167')" id="m_weekend_167">1.67x
                  </div>
                </div>
                <div class="rule-item">
                  <span>9+ 小時</span>
                  <div class="multiplier-badge green" onclick="editMultiplier('weekend_267')" id="m_weekend_267">2.67x
                  </div>
                </div>
              </div>
            </div>

            <!-- Holidays -->
            <div class="rule-card">
              <div class="rule-card-header">
                <div class="rule-icon-box amber">
                  <span class="material-symbols-outlined">celebration</span>
                </div>
                <div>
                  <h4>國定假日 (Holidays)</h4>
                  <p>法定假日</p>
                </div>
              </div>
              <div class="rule-items">
                <div class="rule-item">
                  <span>前 8 小時 (First 8h)</span>
                  <div class="multiplier-badge green" onclick="editMultiplier('holiday_200')" id="m_holiday_200">2.00x
                  </div>
                </div>
                <div class="rule-item">
                  <span>之後 (Thereafter)</span>
                  <div class="rate-link">
                    <span class="material-symbols-outlined">arrow_outward</span>
                    比照平日
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="rules-section" style="margin-top: 24px;">
          <div class="history-promo-card">
            <div class="promo-header">
              <span class="material-symbols-outlined history-icon">history</span>
              <div>
                <h5>薪資調整溯源</h5>
                <p>Calculations automatically use the monthly salary effective on the specific overtime date.</p>
              </div>
            </div>
            <button class="promo-action-btn" onclick="closeRulesModal(); openSalaryModal();">
              查看或新增薪資紀錄
              <span class="material-symbols-outlined">chevron_right</span>
            </button>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button class="icon-button" onclick="closeRulesModal()" style="width: 100%; background: #666;">
          <span>關閉視窗</span>
        </button>
      </div>
    </div>
  </div>

  <?!= include('main'); ?>
</body>

</html>